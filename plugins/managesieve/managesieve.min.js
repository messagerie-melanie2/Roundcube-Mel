/**
 * (Manage)Sieve Filters plugin
 *
 * @licstart  The following is the entire license notice for the
 * JavaScript code in this file.
 *
 * Copyright (c) 2012-2014, The Roundcube Dev Team
 *
 * The JavaScript code in this page is free software: you can redistribute it
 * and/or modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation, either version 3 of
 * the License, or (at your option) any later version.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in this file.
 */
function rule_header_select(e){var t=document.getElementById("header"+e),i=document.getElementById("rule_size"+e),a=document.getElementById("rule_message"+e),s=document.getElementById("rule_op"+e),n=document.getElementById("custom_header"+e+"_list"),r=document.getElementById("custom_var"+e+"_list"),l=document.getElementById("rule_mod"+e),o=document.getElementById("rule_trans"+e),c=document.getElementById("rule_comp"+e),m=document.getElementById("rule_date_part"+e),d=document.getElementById("rule_date_header_div"+e),_=$("#rule_op"+e),u=t.value,g=[s,n,r,l,o,c,i];"size"==u?(a&&g.push(a),$.each(g,function(){this.style.display="none"}),i.style.display="inline"):"message"==u&&a?($.each(g,function(){this.style.display="none"}),a.style.display="inline"):(n.style.display="..."!=u?"none":"inline-block",r.style.display="string"!=u?"none":"inline-block",i.style.display="none",s.style.display="inline",c.style.display="",l.style.display="body"==u||"currentdate"==u||"date"==u||"string"==u?"none":"block",o.style.display="body"==u?"block":"none",a&&(a.style.display="message"==u?"block":"none")),m&&(m.style.display="currentdate"==u||"date"==u?"inline":"none"),d&&(d.style.display="date"==u?"":"none"),$('[value="exists"],[value="notexists"]',_).prop("disabled","string"==u),_.val()||_.val("contains"),rule_op_select(s,e,u),rule_mod_select(e,u),t.style.width="..."==u?"40px":""}function rule_op_select(e,t,i){var a=document.getElementById("rule_target"+t+"_list");i||(i=document.getElementById("header"+t).value),a.style.display=e.value.match(/^(exists|notexists)$/)||i.match(/^(size|message)$/)?"none":"inline-block"}function rule_trans_select(e){var t=document.getElementById("rule_trans_op"+e);document.getElementById("rule_trans_type"+e).style.display="content"!=t.value?"none":"inline"}function rule_mod_select(e,t){var i=document.getElementById("rule_mod_op"+e),a=document.getElementById("rule_mod_type"+e),s=document.getElementById("rule_duplicate_div"+e),n=document.getElementById("rule_index_div"+e);t||(t=document.getElementById("header"+e).value),a.style.display="address"!=i.value&&"envelope"!=i.value?"none":"inline",n&&(n.style.display=t.match(/^(body|currentdate|size|message|string)$/)||"envelope"==i.value?"none":""),s&&(s.style.display="message"==t?"":"none")}function rule_join_radio(e){$("#rules").css("display","any"==e?"none":"block")}function rule_adv_switch(e,t){var i=(t=$(t)).hasClass("hide"),a=$("#rule_advanced"+e);i?(a.hide(),t.removeClass("hide").addClass("show")):(a.show(),t.removeClass("show").addClass("hide"))}function action_type_select(e){var t=document.getElementById("action_type"+e).value,i={},a={mailbox:document.getElementById("action_mailbox"+e),target:document.getElementById("redirect_target"+e),target_area:document.getElementById("action_target_area"+e),flags:document.getElementById("action_flags"+e),vacation:document.getElementById("action_vacation"+e),set:document.getElementById("action_set"+e),notify:document.getElementById("action_notify"+e)};for(var s in"fileinto"==t||"fileinto_copy"==t?i.mailbox=1:"redirect"==t||"redirect_copy"==t?i.target=1:t.match(/^reject|ereject$/)?i.target_area=1:t.match(/^(add|set|remove)flag$/)?i.flags=1:"vacation"==t?i.vacation=1:"set"==t?i.set=1:"notify"==t&&(i.notify=1),a)a[s].style.display=i[s]?"inline":"none"}function vacation_action_select(){var e=$("#vacation_action").val();$("#action_target_span")["discard"==e||"keep"==e?"hide":"show"]()}function smart_field_init(i){var e=i.id+"_list",a=$('<span class="listarea"></span>'),t=i.value?i.value.split("\n"):[""];$("#"+e).length||($.each(t,function(e,t){a.append(smart_field_row(t,i.name,e,$(i).data("size")))}),a.attr("id",e),(i=$(i)).attr("disabled")?a.hide():i.prop("disabled",!0),i.after(a),i.hasClass("error")&&(a.addClass("error"),rcmail.managesieve_tip_register([[e,i.data("tip")]])))}function smart_field_row(e,t,i,s){var a=$('<span class="listelement"><span class="reset"></span><input type="text"><span class="add"></span></span>'),n={value:e,name:t+"[]"};return s&&(n.size=s),$("input",a).attr(n).keydown(function(e){var t=$(this);if(13==e.which){var i=smart_field_row("",t.attr("name").replace(/\[\]$/,""),(new Date).getTime(),s);t.parent().after(i),$("input",i).focus()}else if((8==e.which||46==e.which)&&""==t.val()){var a=t.parent();if(1<a.parent().children().length)return a.prev().length?a.prev().children("input").focus():a.next().children("input").focus(),a.remove(),!1}}),$('span[class="reset"]',a).click(function(){var e=$(this.parentNode);1<e.parent().children().length?e.remove():$("input",e).val("").focus()}),$('span[class="add"]',a).click(function(){$(this.parentNode).parent().append(smart_field_row("",$(this.parentNode).find("input").attr("name").replace("[]",""),null,$(this.parentNode).find("input").attr("size")))}),a}function smart_field_reset(i,e){var t=i.id+"_list",a=e.length?e:[""];area=$("#"+t),area.empty(),$.each(a,function(e,t){area.append(smart_field_row(t,i.name,e,$(i).data("size")))})}function sieve_formattime(e,t){var i,a,s="",n=rcmail.env.time_format||"H:i";for(i=0;i<n.length;i++)switch(a=n.charAt(i)){case"a":s+=12<=e?"pm":"am";break;case"A":s+=12<=e?"PM":"AM";break;case"g":case"h":0==e?12:12<e?e-12:e,s+=("h"==a&&e<10?"0":"")+e;break;case"G":s+=e;break;case"H":s+=(e<10?"0":"")+e;break;case"i":s+=(t<10?"0":"")+t;break;case"s":s+="00";default:s+=a}return s}function sieve_form_init(){var e=rcmail.gui_objects.sieveform;"plugin.managesieve"==rcmail.env.action&&"mail"==rcmail.env.task&&parent.rcmail.managesieve_dialog_resize(e),$('input[type="text"]:first',e).focus(),$('textarea[data-type="list"]',e).each(function(){smart_field_init(this)}),$('[name="_header[]"]',e).each(function(){/([0-9]+)$/.test(this.id)&&rule_header_select(RegExp.$1)}),$.datepicker&&rcmail.env.date_format&&($.datepicker.setDefaults({dateFormat:rcmail.env.date_format,changeMonth:!0,showOtherMonths:!0,selectOtherMonths:!0,onSelect:function(e){$(this).focus().val(e)}}),$("input.datepicker").datepicker()),$("#vacation_timefrom, #vacation_timeto").attr("autocomplete","off").autocomplete({delay:100,minLength:1,source:function(e,t){var i,a=[];for(i=0;i<24;i++)a.push(sieve_formattime(i,0));return a.push(sieve_formattime(23,59)),t(a)},open:function(e,t){var i=$(this),a=i.val(),s=i.autocomplete("widget").css("width","10em"),n=i.data("ui-autocomplete").menu;a&&a.length&&s.children().each(function(){var e=$(this);0==e.text().indexOf(a)&&n._scrollIntoView(e)})},select:function(e,t){return $(this).val(t.item.value),!1}}).click(function(){$(this).autocomplete("search",$(this).val()||" ")}),$("input.error").each(function(){String(this.id).match(/([0-9]+)$/)&&$("#ruleadv"+RegExp.$1+".show").click()})}var cmeditor;function cmCreateErrorElem(e){var t=document.createElement("div");return t.style.color="#822",t.innerHTML="â—",t.title=e,t}function cmScrollToError(){var e=$(".CodeMirror-lines .line-error"),t=$(".CodeMirror-scroll");e.parent();t.scrollTop(e.offset().top-t.offset().top-Math.round(t.height()/2))}function sieve_raw_editor_init(){var e=document.getElementById("rawfiltersettxt");e&&!cmeditor&&(cmeditor=CodeMirror.fromTextArea(e,{mode:"sieve",lineNumbers:!0,gutters:["CodeMirror-linenumbers","errorGutter"],styleActiveLine:!0}),$.each(rcmail.env.sieve_errors||[],function(e,t){var i=Number(t.line)-1;cmeditor.addLineClass(i,"background","line-error"),cmeditor.setGutterMarker(i,"errorGutter",cmCreateErrorElem(t.msg)),e||cmScrollToError()}))}window.rcmail&&rcmail.addEventListener("init",function(e){if("mail"==rcmail.env.task&&("show"!=rcmail.env.action?rcmail.env.message_commands.push("managesieve-create"):rcmail.enable_command("managesieve-create",!0)),("mail"==rcmail.env.task||rcmail.env.action.startsWith("plugin.managesieve"))&&(rcmail.env.framed||(rcmail.env.ms_tip_layer=$('<div id="managesieve-tip" class="popupmenu"></div>'),rcmail.env.ms_tip_layer.appendTo(document.body))),rcmail.register_command("plugin.managesieve-save",function(){rcmail.managesieve_save()}),rcmail.register_command("plugin.managesieve-act",function(){rcmail.managesieve_act()}),rcmail.register_command("plugin.managesieve-add",function(){rcmail.managesieve_add()}),rcmail.register_command("plugin.managesieve-del",function(){rcmail.managesieve_del()}),rcmail.register_command("plugin.managesieve-move",function(){rcmail.managesieve_move()}),rcmail.register_command("plugin.managesieve-setadd",function(){rcmail.managesieve_setadd()}),rcmail.register_command("plugin.managesieve-setdel",function(){rcmail.managesieve_setdel()}),rcmail.register_command("plugin.managesieve-setact",function(){rcmail.managesieve_setact()}),rcmail.register_command("plugin.managesieve-setget",function(){rcmail.managesieve_setget()}),rcmail.register_command("plugin.managesieve-seteditraw",function(){rcmail.managesieve_seteditraw()}),rcmail.env.action.startsWith("plugin.managesieve")){rcmail.gui_objects.sieveform?(rcmail.enable_command("plugin.managesieve-save",!0),sieve_form_init()):rcmail.gui_objects.sievesetrawform?(rcmail.enable_command("plugin.managesieve-save",!0),sieve_raw_editor_init()):rcmail.enable_command("plugin.managesieve-add","plugin.managesieve-setadd",!rcmail.env.sieveconnerror);var t,i=rcmail.env.currentset;rcmail.gui_objects.filterslist&&(rcmail.filters_list=new rcube_list_widget(rcmail.gui_objects.filterslist,{multiselect:!1,draggable:!0,keyboard:!0}),rcmail.filters_list.addEventListener("select",function(e){rcmail.managesieve_select(e)}).addEventListener("dragstart",function(e){rcmail.managesieve_dragstart(e)}).addEventListener("dragend",function(e){rcmail.managesieve_dragend(e)}).addEventListener("initrow",function(e){e.obj.onmouseover=function(){rcmail.managesieve_focus_filter(e)},e.obj.onmouseout=function(){rcmail.managesieve_unfocus_filter(e)}}).init()),rcmail.gui_objects.filtersetslist&&(rcmail.filtersets_list=new rcube_list_widget(rcmail.gui_objects.filtersetslist,{multiselect:!1,draggable:!1,keyboard:!0}),rcmail.filtersets_list.init().focus(),null!=i&&(i=rcmail.managesieve_setid(i),rcmail.filtersets_list.select(i)),rcmail.filtersets_list.addEventListener("select",function(e){rcmail.managesieve_setselect(e)}),t=rcmail.filtersets_list.rowcount,rcmail.enable_command("plugin.managesieve-set",!0),rcmail.enable_command("plugin.managesieve-setact","plugin.managesieve-setget",0<t),rcmail.enable_command("plugin.managesieve-setdel",1<t),rcmail.enable_command("plugin.managesieve-seteditraw",0<t&&rcmail.env.raw_sieve_editor),$("tr",rcmail.gui_objects.filtersetslist).each(function(e,t){rcmail.managesieve_fixdragend(t)}))}rcmail.gui_objects.sieveform&&rcmail.env.rule_disabled&&$("#disabled").attr("checked",!0)}),rcube_webmail.prototype.managesieve_add=function(){this.load_managesieveframe("",!0)},rcube_webmail.prototype.managesieve_del=function(){var e=this.filters_list.get_single_selection();if(confirm(this.get_label("managesieve.filterdeleteconfirm"))){var t=this.set_busy(!0,"loading");this.http_post("plugin.managesieve-action","_act=delete&_fid="+this.filters_list.rows[e].uid,t)}},rcube_webmail.prototype.managesieve_act=function(){var e=this.filters_list.get_single_selection(),t=this.set_busy(!0,"loading");this.http_post("plugin.managesieve-action","_act=act&_fid="+this.filters_list.rows[e].uid,t)},rcube_webmail.prototype.managesieve_select=function(e){var t=e.get_single_selection();null!=t&&(t=e.rows[t].uid,this.load_managesieveframe("_fid="+t));var i=void 0!==t&&null!=t;this.enable_command("plugin.managesieve-act","plugin.managesieve-del",i)},rcube_webmail.prototype.managesieve_setselect=function(e){this.show_contentframe(!1),this.filters_list.clear(!0),this.enable_command("plugin.managesieve-setdel",1<e.rowcount),this.enable_command("plugin.managesieve-setact","plugin.managesieve-setget",0<e.rowcount),this.enable_command("plugin.managesieve-seteditraw",0<e.rowcount&&this.env.raw_sieve_editor);var t=e.get_single_selection();null!=t&&this.managesieve_list(this.env.filtersets[t])},rcube_webmail.prototype.managesieve_rowid=function(e){var t,i=this.filters_list.rows;for(t in i)if(null!=i[t]&&i[t].uid==e)return t},rcube_webmail.prototype.managesieve_setid=function(e){for(var t in this.env.filtersets)if(this.env.filtersets[t]==e)return t},rcube_webmail.prototype.managesieve_list=function(e){var t=this.set_busy(!0,"loading");this.http_post("plugin.managesieve-action","_act=list&_set="+urlencode(e),t)},rcube_webmail.prototype.managesieve_setget=function(){var e=this.filtersets_list.get_single_selection(),t=this.env.filtersets[e];this.goto_url("plugin.managesieve-action",{_act:"setget",_set:t},!1,!0)},rcube_webmail.prototype.managesieve_setact=function(){var e=this.filtersets_list.get_single_selection(),t=this.set_busy(!0,"loading"),i=this.env.filtersets[e],a=$("#rcmrow"+e).hasClass("disabled")?"setact":"deact";this.http_post("plugin.managesieve-action","_act="+a+"&_set="+urlencode(i),t)},rcube_webmail.prototype.managesieve_setdel=function(){if(!confirm(this.get_label("managesieve.setdeleteconfirm")))return!1;var e=this.filtersets_list.get_single_selection(),t=this.set_busy(!0,"loading"),i=this.env.filtersets[e];this.http_post("plugin.managesieve-action","_act=setdel&_set="+urlencode(i),t)},rcube_webmail.prototype.managesieve_seteditraw=function(){var e=this.filtersets_list.get_single_selection(),t=this.env.filtersets[e];this.load_managesieveframe("_seteditraw=1&_set="+urlencode(t),!0)},rcube_webmail.prototype.managesieve_setadd=function(){this.load_managesieveframe("_newset=1",!0)},rcube_webmail.prototype.managesieve_updatelist=function(e,t){switch(this.set_busy(!0),e){case"del":var i=t.id;(s=this.filters_list).remove_row(this.managesieve_rowid(t.id)),this.show_contentframe(!1),this.reset_filters_list(),$("tr",this.filters_list.list).each(function(){if("none"!=this.style.display){var e=this.id.substr(6);$(this).off(),i<e&&(this.uid=e-1,$(this).attr("id","rcmrow"+this.uid))}else $(this).detach()}),s.init();break;case"update":var a=$("#rcmrow"+this.managesieve_rowid(t.id));t.name&&$("td",a).text(t.name),t.disabled?a.addClass("disabled"):a.removeClass("disabled"),$("#disabled",$("iframe").contents()).prop("checked",t.disabled);break;case"add":var s=this.filters_list;a=$('<tr><td class="name"></td></tr>');$("td",a).text(t.name),a.attr("id","rcmrow"+t.id),t.disabled&&a.addClass("disabled"),s.insert_row(a.get(0)),s.highlight_row(t.id),this.enable_command("plugin.managesieve-del","plugin.managesieve-act",!0);break;case"list":var n,r,l,o;s=this.filters_list;for(n in t.clear&&s.clear(),t.list)o=t.list[n],r=document.createElement("TR"),l=document.createElement("TD"),$(l).text(o.name),l.className="name",r.id="rcmrow"+o.id,o.class&&(r.className=o.class),r.appendChild(l),s.insert_row(r);t.set?s.highlight_row(t.set):this.enable_command("plugin.managesieve-del","plugin.managesieve-act",!1);break;case"setact":i=this.managesieve_setid(t.name),a=$("#rcmrow"+i);t.active?(t.all&&$("tr",this.gui_objects.filtersetslist).addClass("disabled"),a.removeClass("disabled")):a.addClass("disabled");break;case"setdel":i=this.managesieve_setid(t.name);this.filtersets_list.remove_row(i),this.filters_list.clear(),this.show_contentframe(!1),this.enable_command("plugin.managesieve-setdel","plugin.managesieve-setact","plugin.managesieve-setget",!1),delete this.env.filtersets[i];break;case"setadd":i="S"+(new Date).getTime(),s=this.filtersets_list,a=$('<tr class="disabled"><td class="name"></td></tr>');if($("td",a).text(t.name),a.attr("id","rcmrow"+i),this.env.filtersets[i]=t.name,s.insert_row(a.get(0)),t.index!=s.rowcount-1){a.detach();var c=$("tr:visible",s.list).get(t.index);a.insertBefore(c)}s.select(i),this.managesieve_fixdragend(a);break;case"refresh":this.reset_filters_list(!0)}this.set_busy(!1)},rcube_webmail.prototype.reset_filters_list=function(e){if(this.filters_list.clear_selection(),this.enable_command("plugin.managesieve-act","plugin.managesieve-del",!1),e){var t=this.filtersets_list.get_single_selection();this.filters_list.clear(!0),this.managesieve_list(this.env.filtersets[t])}},rcube_webmail.prototype.load_managesieveframe=function(e,t){if(t&&this.reset_filters_list(),this.env.contentframe&&window.frames&&window.frames[this.env.contentframe]){var i=this.set_busy(!0,"loading");target=window.frames[this.env.contentframe],target.location.href=this.env.comm_path+"&_action=plugin.managesieve-action&_framed=1&_unlock="+i+(e?"&"+e:"")}},rcube_webmail.prototype.managesieve_dragstart=function(e){var t=this.filters_list.get_single_selection();this.drag_active=!0,this.drag_filter=t},rcube_webmail.prototype.managesieve_dragend=function(e){if(this.drag_active){if(this.drag_filter_target){var t=this.set_busy(!0,"loading");this.show_contentframe(!1),this.http_post("plugin.managesieve-action","_act=move&_fid="+this.drag_filter+"&_to="+this.drag_filter_target,t)}this.drag_active=!1}},rcube_webmail.prototype.managesieve_fixdragend=function(e){var t=this;$(e).on("mouseup"+(bw.iphone||bw.ipad?" touchend":""),function(e){t.drag_active&&t.filters_list.drag_mouse_up(e)})},rcube_webmail.prototype.managesieve_focus_filter=function(e){var t=e.id.replace(/^rcmrow/,"");this.drag_active&&t!=this.drag_filter&&(this.drag_filter_target=t,$(e.obj).addClass(t<this.drag_filter?"filtermoveup":"filtermovedown"))},rcube_webmail.prototype.managesieve_unfocus_filter=function(e){this.drag_active&&($(e.obj).removeClass("filtermoveup filtermovedown"),this.drag_filter_target=null)},rcube_webmail.prototype.managesieve_save=function(){if("plugin.managesieve-vacation"!=this.env.action)if(this.gui_objects.sieveform){if(parent.rcmail&&parent.rcmail.filters_list&&"filtersetform"!=this.gui_objects.sieveform.name){var e=parent.rcmail.filters_list.get_single_selection();null!=e&&(this.gui_objects.sieveform.elements._fid.value=parent.rcmail.filters_list.rows[e].uid)}this.gui_objects.sieveform.submit()}else this.gui_objects.sievesetrawform&&this.gui_objects.sievesetrawform.submit();else{var t=$(this.gui_objects.sieveform).serialize();this.http_post("plugin.managesieve-vacation",t,this.display_message(this.get_label("managesieve.vacation.saving"),"loading"))}},rcube_webmail.prototype.managesieve_ruleadd=function(e){this.http_post("plugin.managesieve-action","_act=ruleadd&_rid="+e)},rcube_webmail.prototype.managesieve_rulefill=function(e,t,i){if(""!=e){var a=document.getElementById("rules"),s=document.createElement("div");this.managesieve_insertrow(a,s,i),s.setAttribute("id","rulerow"+t),s.className="rulerow",s.innerHTML=e,$('textarea[data-type="list"]',s).each(function(){smart_field_init(this)}),this.managesieve_formbuttons(a)}},rcube_webmail.prototype.managesieve_ruledel=function(e){if(!$("#ruledel"+e).hasClass("disabled")&&confirm(this.get_label("managesieve.ruledeleteconfirm"))){var t=document.getElementById("rulerow"+e);t.parentNode.removeChild(t),this.managesieve_formbuttons(document.getElementById("rules"))}},rcube_webmail.prototype.managesieve_actionadd=function(e){this.http_post("plugin.managesieve-action","_act=actionadd&_aid="+e)},rcube_webmail.prototype.managesieve_actionfill=function(e,t,i){if(""!=e){var a=document.getElementById("actions"),s=document.createElement("div");this.managesieve_insertrow(a,s,i),s.className="actionrow",s.setAttribute("id","actionrow"+t),s.innerHTML=e,$('textarea[data-type="list"]',s).each(function(){smart_field_init(this)}),this.managesieve_formbuttons(a)}},rcube_webmail.prototype.managesieve_actiondel=function(e){if(!$("#actiondel"+e).hasClass("disabled")&&confirm(this.get_label("managesieve.actiondeleteconfirm"))){var t=document.getElementById("actionrow"+e);t.parentNode.removeChild(t),this.managesieve_formbuttons(document.getElementById("actions"))}},rcube_webmail.prototype.managesieve_insertrow=function(e,t,i){for(var a=0;a<e.childNodes.length&&e.childNodes[a].id!=("rules"==e.id?"rulerow":"actionrow")+i;a++);e.childNodes[a+1]?e.insertBefore(t,e.childNodes[a+1]):e.appendChild(t)},rcube_webmail.prototype.managesieve_formbuttons=function(e){var t,i,a=[];for(t=0;t<e.childNodes.length;t++)"rules"==e.id&&e.childNodes[t].id?/rulerow/.test(e.childNodes[t].id)&&a.push("ruledel"+e.childNodes[t].id.replace(/rulerow/,"")):e.childNodes[t].id&&/actionrow/.test(e.childNodes[t].id)&&a.push("actiondel"+e.childNodes[t].id.replace(/actionrow/,""));for(t=0;t<a.length;t++)i=document.getElementById(a[t]),0<t||1<a.length?$(i).removeClass("disabled"):$(i).addClass("disabled")},rcube_webmail.prototype.managesieve_vacation_addresses=function(e){var t=this.set_busy(!0,"loading");this.http_post("plugin.managesieve-action",{_act:"addresses",_aid:e},t)},rcube_webmail.prototype.managesieve_vacation_addresses_update=function(e,t){smart_field_reset($("#vacation_addresses,#action_addresses"+(e||"")).get(0),t)},rcube_webmail.prototype.managesieve_tip_register=function(e){var t,r=parent.rcmail,l=r?parent.rcmail.env.ms_tip_layer:rcmail.env.ms_tip_layer;for(t in e)$("#"+e[t][0]).data("tip",e[t][1]).mouseleave(function(e){l.hide()}).mouseenter(function(e){var t=$(this),i=t.offset(),a=i.left,s=i.top-12,n=t.width();r&&(s+=(i=$("mail"==rcmail.env.task?"#sievefilterform > iframe":"#filter-box",parent.document).offset()).top,a+=i.left),l.html(t.data("tip")),s-=l.height(),l.css({left:a,top:s,minWidth:n-2+"px"}).show()})},rcube_webmail.prototype.managesieve_create=function(e){if(e||"show"==this.env.action){if(this.env.sieve_headers&&this.env.sieve_headers.length){var t,i,a={},s=$("#sievefilterform");for(t in s.length||(s=$('<div id="sievefilterform"></div>'),$("body").append(s)),i="<fieldset><legend>"+this.get_label("managesieve.usedata")+"</legend><ul>",this.env.sieve_headers)i+='<li><input type="checkbox" name="headers[]" id="sievehdr'+t+'" value="'+t+'" checked="checked" /><label for="sievehdr'+t+'">'+this.env.sieve_headers[t][0]+":</label> "+this.env.sieve_headers[t][1]+"</li>";i+="</ul></fieldset>",s.html(i),a[this.get_label("managesieve.nextstep")]=function(){var e=$('input[name="headers[]"]:checked',s);if(e.length){var t=rcmail.get_task_url("mail");t=rcmail.add_url(t,"_action","plugin.managesieve"),t=rcmail.add_url(t,"_framed",1),e.map(function(){var e=rcmail.env.sieve_headers[this.value];t=rcmail.add_url(t,"r["+this.value+"]",e[0]+":"+e[1])});var i=$("<iframe>").attr({src:t,frameborder:0});s.empty().append(i).dialog("widget").resize(),(a={})[rcmail.get_label("save")]=function(){$("iframe",s).get(0).contentWindow.rcmail.managesieve_save()},s.dialog("option","buttons",a)}else alert(rcmail.get_label("managesieve.nodata"))},s.dialog({modal:!1,resizable:!0,closeOnEscape:!0,title:this.get_label("managesieve.newfilter"),close:function(){rcmail.managesieve_dialog_close()},buttons:a,minWidth:600,minHeight:300,height:250}).show(),this.env.managesieve_dialog=s}}else{var n=this.message_list.get_single_selection(),r=this.set_busy(!0,"loading");this.http_post("plugin.managesieve-action",{_uid:n},r)}},rcube_webmail.prototype.managesieve_dialog_close=function(){var e=this.env.managesieve_dialog;e.html(""),e.dialog("destroy").hide()},rcube_webmail.prototype.managesieve_dialog_resize=function(e){var t=this.env.managesieve_dialog,i=$(window),a=$(e);width=$("fieldset:first",e).width(),height=a.height(),w=i.width(),h=i.height(),t.dialog("option",{height:Math.min(h-20,height+120),width:Math.min(w-20,width+65)})};
