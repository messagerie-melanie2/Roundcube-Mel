/**
 * ACL plugin script
 *
 * @licstart  The following is the entire license notice for the
 * JavaScript code in this file.
 *
 * Copyright (c) The Roundcube Dev Team
 *
 * The JavaScript code in this page is free software: you can redistribute it
 * and/or modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation, either version 3 of
 * the License, or (at your option) any later version.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in this file.
 */
window.rcmail&&rcmail.addEventListener("init",function(){if(rcmail.gui_objects.acltable&&(rcmail.acl_list_init(),rcmail.env.acl_users_source)){var a=rcmail.is_framed()?parent.rcmail:rcmail;a.init_address_input_events($("#acluser"),{action:"settings/plugin.acl-autocomplete"});a.set_env({autocomplete_max:rcmail.env.autocomplete_max,autocomplete_min_length:rcmail.env.autocomplete_min_length});a.add_label("autocompletechars",rcmail.labels.autocompletechars);a.add_label("autocompletemore",rcmail.labels.autocompletemore);
a.addEventListener("autocomplete_insert",function(a){"acluser"==a.field.id&&(a.field.value=a.insert.replace(/[ ,;]+$/,""))})}rcmail.enable_command("acl-create","acl-save","acl-cancel","acl-mode-switch",!0);rcmail.enable_command("acl-delete","acl-edit",!1);rcmail.env.acl_advanced&&$("#acl-switch").addClass("selected").find("input").prop("checked",!0)});rcube_webmail.prototype.acl_create=function(){this.acl_init_form()};
rcube_webmail.prototype.acl_edit=function(){var a=this.acl_list.get_single_selection();a&&this.acl_init_form(a)};rcube_webmail.prototype.acl_delete=function(){var a=this.acl_get_usernames();a&&a.length&&this.confirm_dialog(this.get_label("acl.deleteconfirm"),"delete",function(b,c){c.http_post("settings/plugin.acl",{_act:"delete",_user:a.join(","),_mbox:rcmail.env.mailbox},c.set_busy(!0,"acl.deleting"))})};
rcube_webmail.prototype.acl_save=function(){var a,b="",c=$("#acluser",this.acl_form).val();$(this.env.acl_advanced?"#advancedrights :checkbox":"#simplerights :checkbox",this.acl_form).map(function(){this.checked&&(b+=this.value)});(a=$("input:checked[name=usertype]",this.acl_form).val())&&"user"!=a&&(c=a);c?b?(a={_act:"save",_user:c,_acl:b,_mbox:this.env.mailbox},this.acl_id&&(a._old=this.acl_id),this.http_post("settings/plugin.acl",a,this.set_busy(!0,"acl.saving"))):this.alert_dialog(this.get_label("acl.norights")):
this.alert_dialog(this.get_label("acl.nouser"))};rcube_webmail.prototype.acl_cancel=function(){this.ksearch_blur();this.acl_popup.dialog("close")};rcube_webmail.prototype.acl_update=function(a){a.old?this.acl_remove_row(a.old):this.env.acl[a.id]&&this.acl_remove_row(a.id);this.acl_add_row(a,!0);this.ksearch_blur();this.acl_popup.dialog("close")};
rcube_webmail.prototype.acl_mode_switch=function(a){this.env.acl_advanced=!this.env.acl_advanced;this.enable_command("acl-delete","acl-edit",!1);this.http_request("settings/plugin.acl","_act=list&_mode="+(this.env.acl_advanced?"advanced":"simple")+"&_mbox="+urlencode(this.env.mailbox),this.set_busy(!0,"loading"))};
rcube_webmail.prototype.acl_list_init=function(){var a=this.env.acl_advanced?"addClass":"removeClass";$("#acl-switch")[a]("selected");$(this.gui_objects.acltable)[a]("advanced");this.acl_list=new rcube_list_widget(this.gui_objects.acltable,{multiselect:!0,draggable:!1,keyboard:!0});this.acl_list.addEventListener("select",function(a){rcmail.acl_list_select(a)}).addEventListener("dblclick",function(a){rcmail.acl_list_dblclick(a)}).addEventListener("keypress",function(a){rcmail.acl_list_keypress(a)}).init()};
rcube_webmail.prototype.acl_list_select=function(a){rcmail.enable_command("acl-delete",0<a.get_selection().length);rcmail.enable_command("acl-edit",1==a.get_selection().length);a.focus()};rcube_webmail.prototype.acl_list_dblclick=function(a){this.acl_edit()};rcube_webmail.prototype.acl_list_keypress=function(a){if(a.key_pressed==a.ENTER_KEY)this.command("acl-edit");else if(a.key_pressed==a.DELETE_KEY||a.key_pressed==a.BACKSPACE_KEY)this.acl_form&&this.acl_form.is(":visible")||this.command("acl-delete")};
rcube_webmail.prototype.acl_list_update=function(a){$(this.gui_objects.acltable).html(a);this.acl_list_init()};rcube_webmail.prototype.acl_get_usernames=function(){var a=[],b,c,e,d,g=this.acl_list,f=g.get_selection();b=0;for(c=f.length;b<c;b++)this.env.acl_specials.length&&0<=$.inArray(f[b],this.env.acl_specials)?a.push(f[b]):(d=g.rows[f[b]])&&(e=$(d.obj).data("userid"))&&a.push(e);return a};
rcube_webmail.prototype.acl_remove_row=function(a){var b=this.acl_list;b.remove_row(a);b.clear_selection();$("#rcmrow"+a).remove();this.env.acl[a]=null;this.enable_command("acl-delete",0<b.get_selection().length);this.enable_command("acl-edit",1==b.get_selection().length)};
rcube_webmail.prototype.acl_add_row=function(a,b){var c,e,d=[];e=[];var g=a.id,f=this.acl_list,k=this.env.acl_advanced?[]:this.env.acl_items,h=$("thead > tr",this.gui_objects.acltable).clone();$("th",h).map(function(){var b=$("<td>"),c=$(this).attr("title"),d=this.className.replace(/^acl/,"");c&&b.attr("title",c);k&&k[d]&&(d=k[d]);"user"==d?b.addClass(d).attr("title",a.title).append($("<a>").text(a.display)):b.addClass(this.className+" "+rcmail.acl_class(a.acl,d)).html("<span/>");$(this).replaceWith(b)});
h=h.attr({id:"rcmrow"+g,"data-userid":a.username}).get(0);this.env.acl[g]=a.acl;for(c in this.env.acl)this.env.acl[c]&&(this.env.acl_specials.length&&0<=$.inArray(c,this.env.acl_specials)?e.push(c):d.push(c));d.sort();d=e.concat(d);c=0;for(e=d.length;c<e&&d[c]!=g;c++);c&&c<e?($("#rcmrow"+d[c-1]).after(h),f.init_row(h),f.rowcount++):f.insert_row(h);b&&f.select_row(a.id)};
rcube_webmail.prototype.acl_init_form=function(a){var b,c,e,d="",g="user",f=$("body");b=$("#advancedrights");var k=$("#simplerights"),h=$("#acluser"),n=$("#usertype");if(!this.acl_form){var m=function(){$('input[value="user"]').prop("checked",!0)};h.click(m).keypress(m)}this.acl_form=$("#aclform");this.env.acl_advanced?(b.show(),k.hide()):(k.show(),b.hide(),b=k);b=$(":checkbox",b);b.attr("checked",!1);a&&(c=this.acl_list.rows[a])?(c=c.obj,b.map(function(){e=$("td."+this.id,c);e.length&&e.hasClass("enabled")&&
(this.checked=!0)}),!this.env.acl_specials.length||0>$.inArray(a,this.env.acl_specials)?d=$(c).data("userid"):g=a):b.filter(function(){return this.id.match(/^acl([lrs]|read)$/)}).prop("checked",!0);h.val(d);$("input[value="+g+"]").prop("checked",!0);this.acl_id=a;var d={},l=this,f=document.body;d[this.get_label("save")]=function(a){l.command("acl-save")};d[this.get_label("cancel")]=function(a){l.command("acl-cancel")};this.acl_popup=this.show_popup_dialog(this.acl_form.show(),a?this.get_label("acl.editperms"):
this.get_label("acl.newuser"),d,{button_classes:["mainaction submit","cancel"],modal:!0,closeOnEscape:!0,close:function(a,b){(l.is_framed()?parent.rcmail:l).ksearch_hide();l.acl_form.appendTo(f).hide();$(this).remove();window.focus()}});"user"==g?h.focus():$("input:checked",n).focus()};rcube_webmail.prototype.acl_class=function(a,b){var c,e,d=0;a=String(a);b=String(b);c=0;for(e=b.length;c<e;c++)-1<a.indexOf(b[c])&&d++;return d==e?"enabled":d?"partial":"disabled"};
