function rcube_text_editor(e,t){var i=this,n=location.href.replace(/[?#].*$/,"").replace(/\/$/,""),s={selector:"#"+($("#"+t).is(".mce_editor")?t:"fake-editor-id"),cache_suffix:"s=5080203",theme:"silver",language:e.lang,content_css:rcmail.assets_path(e.content_css),content_style:e.content_style,menubar:!1,statusbar:!1,toolbar_drawer:"sliding",toolbar:"bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | styleselect fontselect fontsizeselect | forecolor backcolor",extended_valid_elements:"font[face|size|color|style],span[id|class|align|style]",fontsize_formats:"8pt 9pt 10pt 11pt 12pt 14pt 18pt 24pt 36pt",valid_children:"+body[style],+blockquote[style],+div[style]",relative_urls:!1,remove_script_host:!1,convert_urls:!1,image_description:!1,paste_webkit_style:"color font-size font-family",automatic_uploads:!1,paste_data_images:!0,browser_spellcheck:!0,contextmenu:"spellchecker",anchor_bottom:!1,anchor_top:!1,file_picker_types:"image media",file_picker_callback:function(e,t,n){i.file_picker_callback(e,t,n)}};this.spellcheck_observer=function(){},e.spellchecker&&(this.spellchecker=e.spellchecker,e.spellcheck_observer&&(this.spellchecker.spelling_state_observer=this.spellcheck_observer=e.spellcheck_observer)),tinymce.registered_request_token||(tinymce.registered_request_token=!0,tinymce.util.XHR.on("beforeSend",function(e){e.xhr.setRequestHeader("X-Roundcube-Request",rcmail.env.request_token),e.settings&&e.settings.data&&(e.settings.data=e.settings.data.replace(/^(method=[a-zA-Z]+&lang=)([^&]+)/,"$1"+rcmail.env.spell_lang))})),"identity"==e.mode&&(s.toolbar+=" | charmap hr link unlink image code $extra",$.extend(s,{plugins:"autolink charmap code hr image link paste tabfocus",file_picker_types:"image"})),"forum"==e.mode?(s.toolbar+=" | bullist numlist | charmap hr link unlink image code $extra",$.extend(s,{plugins:"autolink charmap code hr image link lists paste tabfocus autoresize",file_picker_types:"image",min_height:400,resize:"vertical"})):(s.toolbar+=" | bullist numlist outdent indent lineheightselect ltr rtl superscript subscript blockquote | link unlink table | $extra charmap image media | code searchreplace undo redo",$.extend(s,{plugins:"autolink charmap code directionality link lists image media nonbreaking paste table tabfocus searchreplace spellchecker lineheight",spellchecker_rpc_url:n+"/?_task=utils&_action=spell_html&_remote=1",spellchecker_language:rcmail.env.spell_lang,min_height:400})),$.each(e.extra_plugins||[],function(){0>s.plugins.indexOf(this)&&(s.plugins=s.plugins+" "+this)}),$.each(e.extra_buttons||[],function(){0>s.toolbar.indexOf(this)&&(s.toolbar=s.toolbar.replace("$extra","$extra "+this))}),$.each(e.disabled_plugins||[],function(){s.plugins=s.plugins.replace(this,"")}),$.each(e.disabled_buttons||[],function(){s.toolbar=s.toolbar.replace(this,"")}),s.toolbar=s.toolbar.replace("$extra","").replace(/\|\s+\|/g,"|"),window.rcmail_editor_settings&&$.extend(s,window.rcmail_editor_settings),s.setup=function(e){e.on("init",function(){i.init_callback(e)}),e.on("SpellcheckStart SpellcheckEnd",function(e){i.spellcheck_active="spellcheckstart"==e.type,i.spellcheck_observer()}),e.on("keypress",function(){rcmail.compose_type_activity++}),e.on("click",function(e){var t=$(e.target).closest("a");if(t.length&&e.shiftKey)return window.open(t.get(0).href,"_blank"),!1}),e.on("focus blur",function(t){$(e.getContainer()).toggleClass("focused")}),s.setup_callback&&s.setup_callback(e)},rcmail.triggerEvent("editor-init",{config:s,ref:i,id:t}),this.id=t,this.editor=null,this._conf=s,this._initial_conf={...s},tinymce.init(s),this.init_callback=function(e){if(this.editor=e,"compose"==rcmail.env.action){var t=$("#"+this.id),n=$("div.tox-toolbar__group",t.parent()).first().height();if(n>200||n>t.height())return setTimeout(function(){i.init_callback(e)},300);var o=rcube_find_object("_from"),l=rcmail.env.compose_focus_elem;o&&"select-one"==o.type&&(rcmail.env.identities_initialized||rcmail.change_identity(o),l&&l.id!=this.id&&"BODY"!=l.nodeName&&(window.focus(),l.focus(),rcmail.env.compose_focus_elem=null))}rcmail.triggerEvent("editor-load",{config:s,ref:i}),i.tabindex(i.force_focus||l&&l.id==i.id),$(window).resize()},this.update=function(e){return this.editor.remove(),this._conf=e,tinymce.init(this._conf),this},this.update_to_dark=function(){let e=this._conf;return e.content_css="dark",this.update(e)},this.restart=function(){return this.update({...this._initial_conf})},this.tabindex=function(e){if("mail"==rcmail.env.task&&this.editor){var t=this.editor.getElement(),n=this.editor.getContentAreaContainer().childNodes[0];if(t&&n&&(n.tabIndex=t.tabIndex),t.tabIndex>0){var s=null,o=[":prev",":next"],l=tinymce.DOM.select("*[tabindex="+t.tabIndex+"]:not(iframe)");tinymce.each(l,function(e,t){if(e.id==i.id)return s=t,!1}),null!==s&&(l[s-1]&&l[s-1].id&&(o[0]=l[s-1].id),l[s+1]&&l[s+1].id&&(o[1]=l[s+1].id),this.editor.settings.tabfocus_elements=o.join(","))}bw.mz&&bw.vendver<25&&$(this.editor.getBody()).prop("contenteditable",!1).prop("contenteditable",!0)}e&&this.focus()},this.focus=function(){$(this.editor||"#"+this.id).focus(),this.force_focus=!1},this.toggle=function(e,t){var n,s,o,l=$("#"+this.id),r=rcmail.env.identity?rcmail.env.signatures[rcmail.env.identity]:null,a=r&&r.text&&r.text.length>1;if(this.spellcheck_stop(),e){s=l.val(),a&&(s=(s=s.replace(/\r\n/,"\n")).replace(r.text.replace(/\r\n/,"\n"),"\x02\x03"));var c=function(e){a&&(e=e.replace("\x02\x03",'<div id="_rc_sig">'+r.html+"</div>")),i.force_focus=!0,l.val(e),tinymce.execCommand("mceAddEditor",!1,i.id)};t?(c(s),o=!0):o=rcmail.plain2html(s,c)}else if(this.editor){a&&((n=this.editor.dom.get("_rc_sig"))&&(n=n.innerHTML),this.editor.dom.setHTML("_rc_sig","\x02\x03")),s=this.editor.getContent();var d=function(e){tinymce.execCommand("mceRemoveEditor",!1,i.id),i.editor=null,a&&(e=e.replace("\x02\x03","\n"+r.text)),l.val(e).focus().trigger("input"),rcmail.set_caret_pos(l.get(0),0)};t?(d(l.val()),o=!0):o=rcmail.html2plain(s,d),!o&&n&&this.editor.dom.setHTML("_rc_sig",n)}return o},this.spellcheck_start=function(){this.editor?(tinymce.execCommand("mceSpellCheck",!0),this.spellcheck_observer()):this.spellchecker&&this.spellchecker.spellCheck&&this.spellchecker.spellCheck()},this.spellcheck_stop=function(){var e=this.editor;e?e.plugins&&e.plugins.spellchecker&&this.spellcheck_active&&(e.execCommand("mceSpellCheck",!1),this.spellcheck_observer()):(e=this.spellchecker)&&e.state&&"ready"!=e.state&&"no_error_found"!=e.state&&$(e.spell_span).trigger("click")},this.spellcheck_state=function(){var e;return this.editor?this.spellcheck_active:(e=this.spellchecker)&&e.state?"ready"!=e.state&&"no_error_found"!=e.state:void 0},this.spellcheck_resume=function(e){var t=this.editor;t?t.plugins.spellchecker.markErrors(e):(t=this.spellchecker)&&(t.prepare(!1,!0),t.processData(e))},this.get_language=function(){return rcmail.env.spell_lang},this.set_language=function(e){var t=this.editor;t&&(t.settings.spellchecker_language=e),(t=this.spellchecker)&&t.setCurrentLanguage(e),rcmail.env.spell_lang=e},this.replace=function(e){var t,i=this.editor;if(!e)return!1;if(i)i.getWin().focus(),"object"==$.type(e)&&"html"in e?(e=e.html,t="html"):("object"==$.type(e)&&(e=e.text||""),e=rcmail.quote_html(e).replace(/\r?\n/g,"<br/>"),t="text"),i.selection.setContent(e,{format:t});else if(i=rcube_find_object(this.id)){var n=rcmail.get_input_selection(i),s=i.value,o=s.substring(0,n.start),l=s.substring(n.end,s.length);"object"==$.type(e)&&(e=e.text||""),i.value=o+e+l,rcmail.set_caret_pos(i,n.start+e.length),i.focus()}},this.set_content=function(e){this.editor?(this.editor.setContent(e),this.editor.getWin().focus()):(ed=rcube_find_object(this.id))&&$(ed).val(e).focus()},this.get_content=function(e){var t,i=this.editor,n="",s=!1,o={refresh:!0,selection:!1,nosig:!1,format:"html"};return(e=e?$.extend(o,e):o).refresh&&this.spellcheck_stop(),i?(e.selection&&(n=i.selection.getContent({format:e.format})),n||(n=i.getContent({format:e.format}),s="text"==e.format)):(i=rcube_find_object(this.id))&&(e.selection&&(n=rcmail.get_input_selection(i).text),n||(n=i.value,s=!0)),s&&e.nosig&&(t=n.indexOf("-- \n"))>0&&(n=n.substring(0,t)),n},this.change_signature=function(e,t){var i,n,s=-1,o=$("#"+this.id),l=o.val(),r=rcmail.env.identity;if(this.editor){if(t&&rcmail.env.signatures){var a=this.editor.dom.get("_rc_sig");if(!a){var c=this.editor.getBody();if(a=$('<div id="_rc_sig"></div>').get(0),rcmail.env.top_posting&&!rcmail.env.sig_below&&rcmail.env.compose_mode&&(c.childNodes.length>1||$(c).text())){this.editor.getWin().focus();var d=this.editor.selection.getNode();$(a).insertBefore("BODY"==d.nodeName?c.firstChild:d.nextSibling),$("<p>").append($("<br>")).insertBefore(a)}else c.appendChild(a),i=rcmail.env.top_posting&&rcmail.env.compose_mode?c.firstChild:$(a).prev()}a.innerHTML=rcmail.env.signatures[e]?rcmail.env.signatures[e].html:""}else rcmail.env.top_posting||(i=$(this.editor.getBody()).children().last())}else t&&r&&rcmail.env.signatures&&rcmail.env.signatures[r]&&(r=(r=rcmail.env.signatures[r].text).replace(/\r\n/g,"\n"),(s=rcmail.env.top_posting?l.indexOf(r):l.lastIndexOf(r))>=0&&(l=l.substring(0,s)+l.substring(s+r.length,l.length))),t&&rcmail.env.signatures&&rcmail.env.signatures[e]?(r=(r=rcmail.env.signatures[e].text).replace(/\r\n/g,"\n"),s>=0?(l=l.substring(0,s)+r+l.substring(s,l.length),n=s-1):l&&rcmail.env.compose_mode?rcmail.env.top_posting&&!rcmail.env.sig_below?(pos=rcmail.get_caret_pos(o.get(0)))?(l=l.substring(0,pos)+"\n"+r+"\n\n"+l.substring(pos,l.length),n=pos):(l="\n\n"+r+"\n\n"+l.replace(/^[\r\n]+/,""),n=0):(l=l.replace(/[\r\n]+$/,""),n=!rcmail.env.top_posting&&l.length?l.length+1:0,l+="\n\n"+r):(n=l.length,l+="\n\n"+r)):n=rcmail.env.top_posting?0:l.length,o.val(l),rcmail.set_caret_pos(o.get(0),n);this.editor&&i&&i.length&&(this.editor.selection.setCursorLocation(i.get(0)),this.editor.getWin().scroll(0,i.offset().top))},this.save=function(){this.editor&&this.editor.save()},this.focus=function(){(this.editor||rcube_find_object(this.id)).focus()},this.file_picker_callback=function(e,t,n){var s,o,l,r,a,c=[],d=n.filetype,p=$(".upload-form").clone();for(s in this.editor.windowManager.open({title:rcmail.get_label("select"+d),body:{type:"panel",items:[{type:"htmlpanel",html:'<div id="image-selector" class="image-selector file-upload"><ul id="image-selector-list" class="attachmentslist"></ul></div>'}]},buttons:[{type:"cancel",text:rcmail.get_label("close"),onclick:function(){i.file_picker_close()}}]}),rcmail.env.file_picker_callback=e,rcmail.env.file_picker_type=d,a=$("#image-selector"),p.length?p.find("button,a.button").slice(1).remove():p=this.file_upload_form(rcmail.gui_objects.uploadform),(o=a.prepend(p).find("button,a.button").text(rcmail.get_label("add"+d)).focus()).is(".btn")||o.addClass("tox-button"),rcmail.env.attachments)(l=i.file_picker_entry(s,rcmail.env.attachments[s]))&&c.push(l);r=a.parents(".tox-dialog").find("button").last(),c=$("#image-selector-list").append(c).on("keydown","li",function(e){if(9==e.which)return rcube_event.get_modifier(e)==SHIFT_KEY?$(this).prev().focus().length||o.focus():$(this).next().focus().length||r.focus(),!1}),o.keydown(function(e){if(9==e.which)return rcube_event.get_modifier(e)!=SHIFT_KEY&&c.find("li").first().focus().length||r.focus(),!1;13==e.which&&this.click()}),r.keydown(function(e){if(9==e.which)return rcube_event.get_modifier(e)==SHIFT_KEY&&c.find("li").last().focus().length||o.focus(),!1}),window.FormData&&(rcmail.env.filedrop||(rcmail.env.filedrop={}),rcmail.gui_objects.filedrop&&(rcmail.env.old_file_drop=rcmail.gui_objects.filedrop),rcmail.gui_objects.filedrop=$("#image-selector"),rcmail.gui_objects.filedrop.addClass("droptarget").on("dragover dragleave",function(e){e.preventDefault(),e.stopPropagation(),$(this)["dragover"==e.type?"addClass":"removeClass"]("hover")}).get(0).addEventListener("drop",function(e){return rcmail.file_dropped(e)},!1)),rcmail.env["file_dialog_event_"+d]||(rcmail.env["file_dialog_event+"+d]=!0,rcmail.addEventListener("fileuploaded",function(e){var t;(t=i.file_picker_entry(e.name,e.attachment))&&(c.prepend(t),t.focus())}))},this.file_picker_close=function(e){this.editor.windowManager.close(),e&&rcmail.env.file_picker_callback(e),rcmail.env.old_file_drop&&(rcmail.gui_objects.filedrop=rcmail.env.old_file_drop)},this.file_picker_entry=function(e,t){if(t.complete&&t.mimetype){switch(rcmail.file_upload_id&&rcmail.set_busy(!1,null,rcmail.file_upload_id),rcmail.env.file_picker_type){case"image":n=/^image\//i;break;case"media":n=/^video\//i,s=rcmail.assets_path("program/resources/tinymce/video.png");break;default:return}if(n.test(t.mimetype)){var n,s,o,l=rcmail.env.comm_path+"&_from="+rcmail.env.action+(rcmail.env.compose_id?"&_id="+rcmail.env.compose_id+"&_action=display-attachment":"&_action=upload-display")+"&_file="+e,r=$("<img>").attr({title:t.name,src:s||l+"&_thumbnail=1"});return $("<li>").attr({tabindex:0}).data("url",l).append($('<span class="img">').append(r)).append($('<span class="name">').text(t.name)).click(function(){i.file_picker_close($(this).data("url"))}).keydown(function(e){13==e.which&&i.file_picker_close($(this).data("url"))})}}},this.file_upload_form=function(e){var t=e?$(e).find(".hint").text():"",i=$('<form id="imageuploadform">').attr({method:"post",enctype:"multipart/form-data"});return file=$("<input>").attr({name:"_file[]",type:"file",multiple:!0,style:"opacity:0;height:1px;width:1px"}).change(function(){rcmail.upload_file(i,"upload")}),wrapper=$('<div class="upload-form">').append($("<button>").attr({class:"btn btn-secondary attach",href:"#",onclick:"rcmail.upload_input('imageuploadform')"})),t&&wrapper.prepend($('<div class="hint">').text(t)),e&&(file.attr("name",$('input[type="file"]',e).attr("name")),i.attr("action",$(e).attr("action"))),i.append(file).append($("<input>").attr({type:"hidden",name:"_token",value:rcmail.env.request_token})),wrapper.append(i)}}