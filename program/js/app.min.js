/**
 * Roundcube Webmail Client Script
 *
 * This file is part of the Roundcube Webmail client
 *
 * @licstart  The following is the entire license notice for the
 * JavaScript code in this file.
 *
 * Copyright (C) The Roundcube Dev Team
 * Copyright (C) Kolab Systems AG
 *
 * The JavaScript code in this page is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in this file.
 *
 * @author Thomas Bruederli <roundcube@gmail.com>
 * @author Aleksander 'A.L.E.C' Machniak <alec@alec.pl>
 * @author Charles McNulty <charles@charlesmcnulty.com>
 *
 * @requires jquery.js, common.js, list.js
 */
function rcube_webmail(){this.labels={};this.buttons={};this.buttons_sel={};this.gui_objects={};this.gui_containers={};this.commands={};this.command_handlers={};this.onloads=[];this.messages={};this.group2expand={};this.http_request_jobs={};this.menu_stack=[];this.menu_buttons={};this.entity_selectors=[];this.image_style={};this.uploads={};this.dblclick_time=500;this.message_time=5E3;this.preview_delay_select=400;this.preview_delay_click=60;this.identifier_expr=/[^0-9a-z_-]/gi;this.env={request_timeout:180,
draft_autosave:0,comm_path:"./",recipients_separator:",",recipients_delimiter:", ",popup_width:1150,popup_width_small:900,thread_padding:"15px"};this.ref="rcmail";var f=this;$.ajaxSetup({cache:!1,timeout:1E3*this.env.request_timeout,error:function(a,b,d){f.http_error(a,b,d)},beforeSend:function(a){a.setRequestHeader("X-Roundcube-Request",f.env.request_token)}});$(window).on("beforeunload",function(){f.unload=!0});this.set_env=function(a,b){if(null==a||"object"!==typeof a||b)this.env[a]=b;else for(var d in a)this.env[d]=
a[d]};this.add_label=function(a,b){"string"==typeof a?this.labels[a]=b:"object"==typeof a&&$.extend(this.labels,a)};this.register_button=function(a,b,d,e,g,k){b={id:b,type:d};e&&(b.act=e);g&&(b.sel=g);k&&(b.over=k);this.buttons[a]||(this.buttons[a]=[]);this.buttons[a].push(b);this.loaded&&(this.init_button(a,b),this.set_button(a,this.commands[a]?"act":"pas"))};this.register_menu_button=function(a,b){if(this.menu_buttons[b])this.menu_buttons[b][0].push(a);else{var d=[];$("#"+b).find("a").each(function(){var a,
b=$(this);a=(a=b.attr("onclick"))&&String(a).match(/rcmail\.command\(\'([^']+)/)?RegExp.$1:function(){return b.is(".active")};d.push(a)});d.length&&(this.menu_buttons[b]=[[a],d])}this.set_menu_buttons()};this.set_menu_buttons=function(){clearTimeout(this.menu_buttons_timeout);this.menu_buttons_timeout=setTimeout(function(){$.each(f.menu_buttons,function(){var a=!0;$.each(this[1],function(){var b="function"==typeof this;if(b&&this()||!b&&f.commands[this])return a=!1});$(this[0]).add($(this[0]).parent(".dropbutton")).addClass(a?
"disabled":"active").removeClass(a?"active":"disabled")})},50)};this.gui_object=function(a,b){this.gui_objects[a]=this.loaded?rcube_find_object(b):b};this.gui_container=function(a,b){this.gui_containers[a]=b};this.add_element=function(a,b){this.gui_containers[b]&&this.gui_containers[b].jquery&&this.gui_containers[b].append(a)};this.register_command=function(a,b,d){this.command_handlers[a]=b;d&&this.enable_command(a,!0)};this.add_onload=function(a){this.onloads.push(a)};this.init=function(){var a;
this.task=this.env.task;if(409==this.env.server_error||bw.dom&&bw.xmlhttp_test()){this.env.blankpage||(this.env.blankpage="about:blank");for(a in this.gui_containers)this.gui_containers[a]=$("#"+this.gui_containers[a]);for(a in this.gui_objects)this.gui_objects[a]=rcube_find_object(this.gui_objects[a]);this.init_buttons();this.is_framed()&&parent.rcmail.unlock_frame();this.enable_command("close","logout","mail","addressbook","settings","save-pref","compose","undo","about","switch-task","menu-open",
"menu-close","menu-save",!0);this.set_button(this.task,"sel");this.env.permaurl&&this.enable_command("permaurl","extwin",!0);switch(this.task){case "mail":this.enable_command("list","checkmail","add-contact","search","reset-search","collapse-folder","import-messages",!0);if(this.gui_objects.messagelist){this.env.widescreen_list_template=[{className:"threads",cells:["threads"]},{className:"subject",cells:["fromto","date","status","subject"]},{className:"flags",cells:["flag","attachment"]}];this.message_list=
new rcube_list_widget(this.gui_objects.messagelist,{multiselect:!0,multiexpand:!0,draggable:!0,keyboard:!0,column_movable:this.env.col_movable,dblclick_time:this.dblclick_time});this.message_list.addEventListener("initrow",function(a){f.init_message_row(a)}).addEventListener("dblclick",function(a){f.msglist_dbl_click(a)}).addEventListener("keypress",function(a){f.msglist_keypress(a)}).addEventListener("select",function(a){f.msglist_select(a)}).addEventListener("dragstart",function(a){f.drag_start(a)}).addEventListener("dragmove",
function(a){f.drag_move(a)}).addEventListener("dragend",function(a){f.drag_end(a)}).addEventListener("expandcollapse",function(a){f.msglist_expand(a)}).addEventListener("column_replace",function(a){f.msglist_set_coltypes(a)}).init();$(this.message_list.thead).on("click","a.sortcol",function(a){return f.command("sort",$(this).attr("rel"),this)});this.enable_command("toggle_status","toggle_flag","sort",!0);this.enable_command("set-listmode",this.env.threads&&!this.is_multifolder_listing());var b=$(this.gui_objects.search_filter).val();
b&&"ALL"!=b?this.filter_mailbox(b):this.command("list");$(this.gui_objects.qsearchbox).val(this.env.search_text).focusin(function(){f.message_list.blur()})}this.set_button_titles();this.env.message_commands="show reply reply-all reply-list move copy delete open mark edit viewsource bounce print load-attachment download-attachment show-headers hide-headers download forward forward-inline forward-attachment change-format".split(" ");if("show"==this.env.action||"preview"==this.env.action){if(this.enable_command(this.env.message_commands,
this.env.uid),this.enable_command("reply-list",this.env.list_post),"show"==this.env.action&&this.http_request("pagenav",{_uid:this.env.uid,_mbox:this.env.mailbox,_search:this.env.search_request},this.display_message("","loading")),0<this.env.mail_read_time&&setTimeout(function(){f.http_post("mark",{_uid:f.env.uid,_flag:"read",_mbox:f.env.mailbox,_quiet:1})},1E3*this.env.mail_read_time),this.env.blockedobjects&&($(this.gui_objects.remoteobjectsmsg).show(),this.enable_command("load-remote",!0)),"preview"==
this.env.action&&this.is_framed()&&(this.enable_command("compose","add-contact",!1),parent.rcmail.show_contentframe(!0)),0<=$.inArray("flagged",this.env.message_flags)&&$(document.body).addClass("status-flagged"),this.gui_objects.attachments)$("li > a",this.gui_objects.attachments).not(".drop").on("dragstart",function(a){var b=this.href,d=a.originalEvent.dataTransfer;d&&(b=b.replace(/^https?:\/\//,function(a){return a+urlencode(f.env.username)+"@"}),a=$(this).clone(),a.children().remove(),d.setData("roundcube-uri",
b),d.setData("roundcube-name",$.trim(a.text())))})}else if("compose"==this.env.action)this.env.address_group_stack=[],this.env.compose_commands="send-attachment remove-attachment send cancel toggle-editor list-addresses pushgroup search reset-search extwin insert-response save-response menu-open menu-close load-attachment download-attachment open-attachment rename-attachment".split(" "),this.env.drafts_mailbox&&this.env.compose_commands.push("savedraft"),this.enable_command(this.env.compose_commands,
!0),$.merge(this.env.compose_commands,["add-recipient","firstpage","previouspage","nextpage","lastpage"]),window.googie&&(this.env.editor_config.spellchecker=googie,this.env.editor_config.spellcheck_observer=function(a){f.spellcheck_state()},this.env.compose_commands.push("spellcheck"),this.enable_command("spellcheck",!0)),this.editor_init(this.env.editor_config,this.env.composebody),this.gui_objects.responseslist&&($("a.insertresponse",this.gui_objects.responseslist).attr("unselectable","on").mousedown(function(a){return rcube_event.cancel(a)}).on("mouseup keypress",
function(a){if("mouseup"==a.type||13==rcube_event.get_keycode(a))return f.command("insert-response",$(this).attr("rel")),$(document.body).trigger("mouseup"),rcube_event.cancel(a)}),$.each(this.buttons["save-response"]||[],function(a,b){$("#"+b.id).mousedown(function(a){return rcube_event.cancel(a)})})),this.init_messageform();else if("bounce"==this.env.action)this.init_messageform_inputs(),this.env.compose_commands=[];else if("get"==this.env.action){if(this.enable_command("download",!0),this.enable_command("image-scale",
"image-rotate",!!/^image\//.test(this.env.mimetype)),this.enable_command("print","application/pdf"!=this.env.mimetype||!bw.mz||75<=bw.vendver),this.env.is_message&&(this.enable_command("reply","reply-all","edit","viewsource","forward","forward-inline","forward-attachment","bounce",!0),this.env.list_post&&this.enable_command("reply-list",!0)),this.env.mimetype.startsWith("image/"))$(this.gui_objects.messagepartframe).on("load",function(){var a=$(this).contents();a.find("img").length&&a.find("head").append('<style type="text/css">img { max-width:100%; max-height:100%; } body { display:flex; align-items:center; justify-content:center; height:100%; margin:0; }</style>')})}else"print"!=
this.env.action||!this.env.uid||this.env.is_pgp_content||this.env.pgp_mime_part||this.print_dialog();this.gui_objects.mailboxlist&&(this.env.unread_counts={},this.gui_objects.folderlist=this.gui_objects.mailboxlist,this.http_request("getunread",{_page:this.env.current_page}));this.gui_objects.contactslist&&(this.contact_list=new rcube_list_widget(this.gui_objects.contactslist,{multiselect:!0,draggable:!1,keyboard:!0}),this.contact_list.addEventListener("initrow",function(a){f.triggerEvent("insertrow",
{cid:a.uid,row:a})}).addEventListener("select",function(a){f.compose_recipient_select(a)}).addEventListener("dblclick",function(a){f.compose_add_recipient()}).addEventListener("keypress",function(a){a.key_pressed==a.ENTER_KEY&&(f.compose_add_recipient()||a.last_selected&&"G"==String(a.last_selected).charAt(0)&&$(a.rows[a.last_selected].obj).find("a").first().click())}).init(),$("#_to,#_cc,#_bcc").focus(function(){f.env.focused_field=this}));this.gui_objects.addressbookslist&&(this.gui_objects.folderlist=
this.gui_objects.addressbookslist,this.enable_command("list-addresses",!0));if(this.env.mdn_request&&this.env.uid){var b="sendmdn",d={_uid:this.env.uid,_mbox:this.env.mailbox};confirm(this.get_label("mdnrequest"))||(d._flag="mdnsent",b="mark");this.http_post(b,d)}this.check_mailvelope(this.env.action);this.is_framed()||this.env.extwin||this.browser_capabilities_check();break;case "addressbook":this.env.address_group_stack=[];this.gui_objects.folderlist&&(this.env.contactfolders=$.extend($.extend({},
this.env.address_sources),this.env.contactgroups));this.enable_command("add","import",this.env.writable_source);this.enable_command("list","listgroup","pushgroup","popgroup","listsearch","search","reset-search","advanced-search",!0);this.gui_objects.contactslist&&(this.contact_list=new rcube_list_widget(this.gui_objects.contactslist,{multiselect:!0,draggable:this.gui_objects.folderlist?!0:!1,keyboard:!0}),this.contact_list.addEventListener("initrow",function(a){f.triggerEvent("insertrow",{cid:a.uid,
row:a})}).addEventListener("keypress",function(a){f.list_keypress(a)}).addEventListener("select",function(a){f.contactlist_select(a)}).addEventListener("dragstart",function(a){f.drag_start(a)}).addEventListener("dragmove",function(a){f.drag_move(a)}).addEventListener("dragend",function(a){f.drag_end(a)}).init(),$(this.gui_objects.qsearchbox).focusin(function(){f.contact_list.blur()}),this.update_group_commands(),this.command("list"));this.gui_objects.savedsearchlist&&(this.savedsearchlist=new rcube_treelist_widget(this.gui_objects.savedsearchlist,
{id_prefix:"rcmli",id_encode:this.html_identifier_encode,id_decode:this.html_identifier_decode}),this.savedsearchlist.addEventListener("select",function(a){f.triggerEvent("selectfolder",{folder:a.id,prefix:"rcmli"})}));this.set_page_buttons();this.env.cid&&(this.enable_command("show","edit","qrcode",!0),this.gui_objects.editform&&$("input.groupmember").change(function(){f.group_member_change(this.checked?"add":"del",f.env.cid,f.env.source,this.value)}));this.gui_objects.editform?(this.enable_command("save",
!0),"add"!=this.env.action&&"edit"!=this.env.action&&"search"!=this.env.action||this.init_contact_form()):"print"==this.env.action&&this.print_dialog();break;case "settings":this.enable_command("show","save",!0);"identities"==this.env.action?this.enable_command("add",2>this.env.identities_level):"edit-identity"==this.env.action||"add-identity"==this.env.action?(this.enable_command("save","edit","toggle-editor",!0),this.enable_command("delete",2>this.env.identities_level),this.editor_init(this.env.editor_config,
"rcmfd_signature"),this.check_mailvelope(this.env.action)):"folders"==this.env.action?this.enable_command("subscribe","unsubscribe","create-folder","rename-folder",!0):"edit-folder"==this.env.action&&this.gui_objects.editform?(this.enable_command("save","folder-size",!0),parent.rcmail.env.exists=this.env.messagecount,parent.rcmail.enable_command("purge",this.env.messagecount)):"responses"==this.env.action&&this.enable_command("add",!0);this.gui_objects.identitieslist?(this.identity_list=new rcube_list_widget(this.gui_objects.identitieslist,
{multiselect:!1,draggable:!1,keyboard:!0}),this.identity_list.addEventListener("select",function(a){f.identity_select(a)}).addEventListener("keypress",function(a){f.list_keypress(a)}).init().focus()):this.gui_objects.sectionslist?(this.sections_list=new rcube_list_widget(this.gui_objects.sectionslist,{multiselect:!1,draggable:!1,keyboard:!0}),this.sections_list.addEventListener("select",function(a){f.section_select(a)}).init().focus()):this.gui_objects.subscriptionlist?this.init_subscription_list():
this.gui_objects.responseslist&&(this.responses_list=new rcube_list_widget(this.gui_objects.responseslist,{multiselect:!1,draggable:!1,keyboard:!0}),this.responses_list.addEventListener("select",function(a){f.response_select(a)}).addEventListener("keypress",function(a){f.list_keypress(a)}).init().focus());break;case "login":var e=$("#rcmloginuser"),g=$("#rcmlogintz");""==e.val()?e.focus():$("#rcmloginpwd").focus();window.jstz&&(b=jstz.determine())&&(d=b.name());g.val(d?d:(new Date).getStdTimezoneOffset()/
-60);$("form").submit(function(){$("[type=submit]",this).prop("disabled",!0);f.clear_messages();f.display_message("","loading")})}this.gui_objects.editform&&$("input,select,textarea",this.gui_objects.editform).not(":hidden").not(":disabled").first().select().focus();bw.ie&&$("input[type=file]").keydown(function(a){"13"==a.keyCode&&a.preventDefault()});this.loaded=!0;this.env.lastrefresh=new Date;this.pending_message&&this.display_message.apply(this,this.pending_message);this.gui_objects.folderlist&&
window.rcube_treelist_widget&&this.gui_objects.folderlist!=this.gui_objects.addressbookslist&&(this.treelist=new rcube_treelist_widget(this.gui_objects.folderlist,{selectable:!0,id_prefix:"rcmli",parent_focus:!0,id_encode:this.html_identifier_encode,id_decode:this.html_identifier_decode,check_droptarget:function(a){return!a.virtual&&f.check_droptarget(a.id)}}),this.treelist.addEventListener("collapse",function(a){f.folder_collapsed(a)}).addEventListener("expand",function(a){f.folder_collapsed(a)}).addEventListener("beforeselect",
function(a){return!f.busy}).addEventListener("select",function(a){f.triggerEvent("selectfolder",{folder:a.id,prefix:"rcmli"});f.mark_all_read_state()}));this.gui_objects.filedrop&&this.env.filedrop&&window.FormData&&($(document.body).on("dragover dragleave drop",function(a){return f.document_drag_hover(a,"dragover"==a.type)}),$(this.gui_objects.filedrop).addClass("droptarget").on("dragover dragleave",function(a){return f.file_drag_hover(a,"dragover"==a.type)}).get(0).addEventListener("drop",function(a){return f.file_dropped(a)},
!1));b=function(a){return f.doc_mouse_up(a)};$(document.body).mouseup(b).keydown(function(a){return f.doc_keypress(a)});rcube_webmail.set_iframe_events({mouseup:b});this.triggerEvent("init",{task:this.task,action:this.env.action});for(a in this.onloads)if("string"===typeof this.onloads[a])eval(this.onloads[a]);else if("function"===typeof this.onloads[a])this.onloads[a]();$("[data-popup]").each(function(){f.register_menu_button(this,$(this).data("popup"))});this.start_refresh();this.start_keepalive()}else this.goto_url("error",
"_code=0x199")};this.log=function(a){this.env.devel_mode&&window.console&&console.log&&console.log(a)};this.command=function(a,b,d,e,g){!d||!d.blur||e&&rcube_event.is_keyboard(e)||d.blur();if(this.busy&&("reset-search"!=a||"search"!=this.last_command)&&!a.match(/^menu-/))return!1;if(d&&d.href&&0>String(d.href).indexOf("#")&&rcube_event.get_modifier(e))return!0;if(!g&&!this.commands[a])return this.is_framed()&&parent.rcmail.command(a,b),!1;if("mail"==this.task&&"compose"==this.env.action&&!this.env.server_error&&
"save-pref"!=a&&0>$.inArray(a,this.env.compose_commands)&&!this.compose_skip_unsavedcheck&&!this.env.is_sent&&this.cmp_hash!=this.compose_field_hash())return this.confirm_dialog(this.get_label("notsentwarning"),"discard",function(){f.remove_compose_data(f.env.compose_id);f.compose_skip_unsavedcheck=!0;f.command(a,b,d,e)}),!1;this.last_command=a;this.command_aborted=!1;this.triggerEvent("actionbefore",{props:b,action:a,originalEvent:e});if(void 0!==(g=this.triggerEvent("before"+a,b||e))){if(!1===g)return!1;
b=g}g="function"===typeof this.command_handlers[a]?this.command_handlers[a](b,d,e):"string"===typeof this.command_handlers[a]?window[this.command_handlers[a]](b,d,e):this.command_handler(a,b,d,e);this.command_aborted||!1!==this.triggerEvent("after"+a,b)||(g=!1);this.triggerEvent("actionafter",{props:b,action:a,aborted:this.command_aborted,ret:g,originalEvent:e});return!1===g||d&&!0!==g||!0===this.command_aborted?!1:!0};this.command_handler=function(a,b,d,e){var g,k;switch(a){case "logout":case "mail":case "addressbook":case "settings":this.switch_task(a);
break;case "about":this.redirect("?_task=settings&_action=about",!1);break;case "permaurl":if(d&&d.href&&d.target)return!0;this.env.permaurl&&(parent.location.href=this.env.permaurl);break;case "extwin":if("compose"==this.env.action){if(a=this.gui_objects.messageform,b=this.open_window(""))this.save_compose_form_local(),this.compose_skip_unsavedcheck=!0,$("[name='_action']",a).val("compose"),a.action=this.url("mail/compose",{_id:this.env.compose_id,_extwin:1}),a.target=b.name,a.submit()}else this.open_window(this.env.permaurl,
!0);break;case "change-format":e=this.env.permaurl+"&_format="+b;"preview"==this.env.action&&(e=e.replace(/_action=show/,"_action=preview")+"&_framed=1");this.env.extwin&&(e+="&_extwin=1");location.href=e;break;case "menu-open":b&&"attachmentmenu"==b.menu&&((g=this.env.attachments[b.id])&&g.mimetype&&(g=g.mimetype),this.enable_command("open-attachment",g&&this.env.mimetypes&&0<=$.inArray(g,this.env.mimetypes)));this.show_menu(b,b.show||void 0,e);break;case "menu-close":this.hide_menu(b,e);break;case "menu-save":return this.triggerEvent(a,
{props:b,originalEvent:e}),!1;case "open":if(g=this.get_single_uid())return d.href=this.url("show",this.params_from_uid(g,{_extwin:1})),!0;break;case "close":this.env.extwin&&window.close();break;case "list":b&&""!=b&&this.reset_qsearch(!0);"compose"==this.env.action&&this.env.extwin?window.close():"mail"==this.task?(this.list_mailbox(b),this.set_button_titles()):"addressbook"==this.task&&this.list_contacts(b);break;case "set-listmode":this.set_list_options(null,void 0,void 0,"threads"==b?1:0);break;
case "sort":a=this.env.sort_order;b=this.env.disabled_sort_col?this.env.sort_col:b;this.env.disabled_sort_order||(a=this.env.sort_col==b&&"ASC"==a?"DESC":"ASC");this.set_list_sorting(b,a);this.list_mailbox("","",b+"_"+a);break;case "nextpage":this.list_page("next");break;case "lastpage":this.list_page("last");break;case "previouspage":this.list_page("prev");break;case "firstpage":this.list_page("first");break;case "expunge":this.env.exists&&this.expunge_mailbox(this.env.mailbox);break;case "purge":case "empty-mailbox":this.env.exists&&
this.purge_mailbox(this.env.mailbox);break;case "show":"mail"==this.task?!(g=this.get_single_uid())||this.env.uid&&g==this.env.uid||(b=this.get_message_mailbox(g),b==this.env.drafts_mailbox?this.open_compose_step({_draft_uid:g,_mbox:b}):this.show_message(g)):"addressbook"==this.task?(k=b?b:this.get_single_cid(),!k||"show"==this.env.action&&k==this.env.cid||this.load_contact(k,"show")):"settings"==this.task&&this.goto_url("settings/"+b,{_framed:0});break;case "add":"addressbook"==this.task?this.load_contact(0,
"add"):"settings"==this.task&&"responses"==this.env.action?this.load_response(0,"add-response"):"settings"==this.task&&this.load_identity(0,"add-identity");break;case "edit":"addressbook"==this.task&&(k=this.get_single_cid())?this.load_contact(k,"edit"):"mail"==this.task&&(g=this.get_single_uid())&&(e={_mbox:this.get_message_mailbox(g)},e[e._mbox==this.env.drafts_mailbox&&"new"!=b?"_draft_uid":"_uid"]=g,this.open_compose_step(e));break;case "save":var h;if(a=this.gui_objects.editform){if((h=$("[name='_pagesize']",
a))&&h.length&&isNaN(parseInt(h.val()))){this.alert_dialog(this.get_label("nopagesizewarning"),function(){h.focus()});break}else if("reload"==b)a.action+="&_reload=1";else if("settings"==this.task&&0==this.env.identities_level%2&&(h=$("[name='_email']",a))&&h.length&&!rcube_check_email(h.val())){this.alert_dialog(this.get_label("noemailwarning"),function(){h.focus()});break}parent.rcmail&&parent.rcmail.env.source&&(a.action=this.add_url(a.action,"_orig_source",parent.rcmail.env.source));a.submit()}break;
case "delete":"mail"==this.task?this.delete_messages(e):"addressbook"==this.task?this.delete_contacts():"settings"==this.task&&"responses"==this.env.action?this.delete_response():"settings"==this.task&&this.delete_identity();break;case "move":case "moveto":"mail"==this.task?this.move_messages(b,e):"addressbook"==this.task&&this.move_contacts(b,e);break;case "copy":"mail"==this.task?this.copy_messages(b,e):"addressbook"==this.task&&this.copy_contacts(b,e);break;case "mark":b&&this.mark_message(b);
break;case "toggle_status":case "toggle_flag":a="toggle_flag"==a?"flagged":"read";if(g=b)"flagged"==a?this.message_list.rows[g].flagged&&(a="unflagged"):this.message_list.rows[g].deleted?a="undelete":this.message_list.rows[g].unread||(a="unread"),this.mark_message(a,g);break;case "add-contact":this.add_contact(b);break;case "load-remote":if(this.env.uid){if(b&&this.env.sender){this.add_contact(this.env.sender,!0);break}this.show_message(this.env.uid,!0,"preview"==this.env.action)}break;case "load-attachment":case "open-attachment":case "download-attachment":g=
this.env.attachments[b];"compose"==this.env.action?(b={_file:b,_id:this.env.compose_id},g=g?g.mimetype:""):b={_mbox:this.env.mailbox,_uid:this.env.uid,_part:b};if("download-attachment"!=a&&g&&this.env.mimetypes&&0<=$.inArray(g,this.env.mimetypes)&&this.open_window(this.url("get",$.extend({_frame:1,_framed:0},b))))break;this.compose_skip_unsavedcheck=b._download=1;this.goto_url("get",b,!1,!0);this.compose_skip_unsavedcheck=0;break;case "select-all":this.select_all_mode=b?!1:!0;this.dummy_select=!0;
a=this["addressbook"==this.task?"contact_list":"message_list"];"invert"==b?a.invert_selection():a.select_all("page"==b?"":b);this.dummy_select=null;break;case "select-none":this.select_all_mode=!1;this["addressbook"==this.task?"contact_list":"message_list"].clear_selection();break;case "expand-all":this.env.autoexpand_threads=1;this.message_list.expand_all();break;case "expand-unread":this.env.autoexpand_threads=2;this.message_list.collapse_all();this.expand_unread();break;case "collapse-all":this.env.autoexpand_threads=
0;this.message_list.collapse_all();break;case "nextmessage":this.env.next_uid&&this.show_message(this.env.next_uid,!1,"preview"==this.env.action);break;case "lastmessage":this.env.last_uid&&this.show_message(this.env.last_uid);break;case "previousmessage":this.env.prev_uid&&this.show_message(this.env.prev_uid,!1,"preview"==this.env.action);break;case "firstmessage":this.env.first_uid&&this.show_message(this.env.first_uid);break;case "compose":e={};if("mail"==this.task)e={_mbox:this.env.mailbox,_search:this.env.search_request},
b&&(e._to=b);else if("addressbook"==this.task)if(b&&0<b.indexOf("@"))e._to=b;else if(a=[],b?a.push(b):this.contact_list&&(a=this.contact_list.get_selection()),a.length){this.http_post("mailto",{_cid:a.join(","),_source:this.env.source},!0);break}else{if(this.env.group&&this.env.pagecount){this.http_post("mailto",{_gid:this.env.group,_source:this.env.source},!0);break}}else b&&"string"==typeof b?e._to=b:b&&"object"==typeof b&&$.extend(e,b);this.open_compose_step(e);break;case "spellcheck":this.spellcheck_state()?
this.editor.spellcheck_stop():this.editor.spellcheck_start();break;case "savedraft":clearTimeout(this.save_timer);if(this.env.draft_id&&this.cmp_hash==this.compose_field_hash()){this.auto_save_start();break}this.submit_messageform(!0);break;case "send":if(!b.nocheck&&!this.env.is_sent&&!this.check_compose_input(a))break;clearTimeout(this.save_timer);this.submit_messageform();break;case "send-attachment":clearTimeout(this.save_timer);(a=this.upload_file(b||this.gui_objects.uploadform,"upload"))||(!1!==
a&&this.alert_dialog(this.get_label("selectimportfile")),aborted=!0);break;case "insert-sig":this.change_identity($("[name='_from']")[0],!0);break;case "list-addresses":this.list_contacts(b);this.enable_command("add-recipient",!1);break;case "add-recipient":this.compose_add_recipient(b);break;case "reply-all":case "reply-list":case "reply":if(g=this.get_single_uid())e={_reply_uid:g,_mbox:this.get_message_mailbox(g),_search:this.env.search_request},"reply-all"==a?e._all=!b&&1==this.env.reply_all_mode&&
this.commands["reply-list"]?"list":"all":"reply-list"==a&&(e._all="list"),this.open_compose_step(e);break;case "forward-attachment":case "forward-inline":case "forward":g=this.env.uid?[this.env.uid]:this.message_list?this.message_list.get_selection():[];if(g.length){e={_forward_uid:this.uids_to_list(g),_mbox:this.env.mailbox,_search:this.env.search_request};if("forward-attachment"==a||!b&&this.env.forward_attachment||1<g.length)e._attachment=1;this.open_compose_step(e)}break;case "print":if("addressbook"==
this.task){if(g=this.get_single_cid())e="&_action=print&_cid="+g,this.env.source&&(e+="&_source="+urlencode(this.env.source)),this.open_window(this.env.comm_path+e,!0,!0)}else if("get"==this.env.action&&!this.env.is_message)this.gui_objects.messagepartframe.contentWindow.print();else if(g=this.get_single_uid())e=this.url("print",this.params_from_uid(g,{_safe:this.env.safemode?1:0})),this.open_window(e,!0,!0)&&"show"!=this.env.action&&"get"!=this.env.action&&this.mark_message("read",g);break;case "viewsource":(g=
this.get_single_uid())&&this.open_window(this.url("viewsource",this.params_from_uid(g)),!0,!0);break;case "download":"get"==this.env.action?location.href=this.secure_url(location.href.replace(/_frame=/,"_download=")):(g=this.get_single_uid())&&this.goto_url("viewsource",this.params_from_uid(g,{_save:1}),!1,!0);break;case "search":return this.qsearch(b);case "reset-search":var l;b=this.env.search_request||this.env.qsearch;this.reset_qsearch(!0);if(b&&"compose"==this.env.action)this.contact_list&&this.list_contacts_clear();
else if(b&&this.env.mailbox)this.list_mailbox(this.env.mailbox,1);else if(b&&"addressbook"==this.task){if(""==this.env.source){for(l in this.env.address_sources)break;this.env.source=l;this.env.group=""}this.list_contacts(this.env.source,this.env.group,1)}break;case "pushgroup":var m={id:b.id,search_request:this.env.search_request,page:this.env.current_page,search:this.env.search_request&&this.gui_objects.qsearchbox?this.gui_objects.qsearchbox.value:null};this.env.address_group_stack.push(m);d&&e&&
rcube_event.cancel(e);case "listgroup":this.reset_qsearch();this.list_contacts(b.source,b.id,1,m);break;case "popgroup":this.env.address_group_stack.length&&(a=this.env.address_group_stack.pop(),this.reset_qsearch(),a.search_request?(a.search&&this.gui_objects.qsearchbox&&$(this.gui_objects.qsearchbox).val(a.search),this.env.search_request=a.search_request,this.list_contacts_remote(null,null,this.env.current_page=a.page)):this.list_contacts(b.source,this.env.address_group_stack[this.env.address_group_stack.length-
1].id));break;case "import-messages":a=b||this.gui_objects.importform;b=this.set_busy(!0,"importwait");(a=this.upload_file(a,"import",b))||(this.set_busy(!1,null,b),!1!==a&&this.alert_dialog(this.get_label("selectimportfile")),this.command_aborted=!0);break;case "import":var q=$("<iframe>").attr("src",this.url("import",{_framed:1,_target:this.env.source}));this.import_state=null;this.import_dialog=this.simple_dialog(q,this.gettext("importcontacts"),function(a){var b=q[0].contentWindow,d=b.rcmail.gui_objects.importform;
if(d){var e;(e=b.$("#rcmimportfile")[0])&&!e.value?b.rcmail.alert_dialog(b.rcmail.get_label("selectimportfile")):(e=b.rcmail.set_busy(!0,"importwait"),$('[name="_unlock"]',d).val(e),d.submit(),b.rcmail.lock_form(d,!0),$(a.target).attr("disabled",!0).next().focus())}},{close:function(a,b){$(this).remove();"reload"==f.import_state&&f.command("list")},button:"import",width:500,height:300});break;case "export":0<this.contact_list.rowcount&&this.goto_url("export",{_source:this.env.source,_gid:this.env.group,
_search:this.env.search_request},!1,!0);break;case "export-selected":0<this.contact_list.rowcount&&this.goto_url("export",{_source:this.env.source,_gid:this.env.group,_cid:this.contact_list.get_selection().join(",")},!1,!0);break;case "upload-photo":this.upload_contact_photo(b||this.gui_objects.uploadform);break;case "delete-photo":this.replace_contact_photo("-del-");break;case "undo":this.http_request("undo","",this.display_message("","loading"));break;default:if(a=a.replace(/-/g,"_"),this[a]&&"function"===
typeof this[a])return this[a](b,d,e)}};this.enable_command=function(){var a,b,d=Array.prototype.slice.call(arguments),e=d.pop(),g;for(b=0;b<d.length;b++)if(g=d[b],"string"===typeof g)this.commands[g]=e,this.set_button(g,e?"act":"pas"),this.triggerEvent("enable-command",{command:g,status:e});else for(a in g)d.push(g[a]);this.set_menu_buttons()};this.command_enabled=function(a){return this.commands[a]};this.set_busy=function(a,b,d){a&&b?(d=this.get_label(b),d==b&&(d="Loading..."),d=this.display_message(d,
"loading")):!a&&d&&this.hide_message(d);this.busy=a;this.gui_objects.editform&&this.lock_form(this.gui_objects.editform,a);return d};this.gettext=this.get_label=function(a,b){return b&&this.labels[b+"."+a]?this.labels[b+"."+a]:this.labels[a]?this.labels[a]:a};this.switch_task=function(a){var b,d;2==(d=a.split("/")).length&&(a=d[0],b=d[1]);if(this.task!==a||"mail"==a)d=this.get_task_url(a),b&&(d+="&_action="+b),"mail"==a?d+="&_mbox=INBOX":"logout"==a&&(d=this.secure_url(d),this.clear_compose_data()),
this.redirect(d)};this.get_task_url=function(a,b){b||(b=this.env.comm_path);return b.match(/[?&]_task=[a-zA-Z0-9_-]+/)?b.replace(/_task=[a-zA-Z0-9_-]+/,"_task="+a):b.replace(/\?.*$/,"")+"?_task="+a};this.reload=function(a){this.is_framed()?parent.rcmail.reload(a):a?setTimeout(function(){f.reload()},a):window.location&&(location.href=this.url("",{_extwin:this.env.extwin}))};this.add_url=function(a,b,d){var e,g,k="";d=urlencode(d);/(#[a-z0-9_-]+)$/.test(a)&&(k=RegExp.$1,a=a.substr(0,a.length-k.length));
return/(\?.*)$/.test(a)?(e=RegExp.$1,g=RegExp("((\\?|&)"+RegExp.escape(b)+"=[^&]*)"),e=g.test(e)?e.replace(g,RegExp.$2+b+"="+d):e+("&"+b+"="+d),a.replace(/(\?.*)$/,e)+k):a+"?"+b+"="+d+k};this.secure_url=function(a){return this.add_url(a,"_token",this.env.request_token)};this.is_framed=function(){return this.env.framed&&parent.rcmail&&parent.rcmail!=this&&"function"==typeof parent.rcmail.command};this.save_pref=function(a){var b={_name:a.name,_value:a.value};a.session&&(b._session=a.session);a.env&&
(this.env[a.env]=a.value);this.http_post("save-pref",b)};this.html_identifier=function(a,b){return b?this.html_identifier_encode(a):String(a).replace(this.identifier_expr,"_")};this.html_identifier_encode=function(a){return Base64.encode(String(a)).replace(/=+$/,"").replace(/\+/g,"-").replace(/\//g,"_")};this.html_identifier_decode=function(a){for(a=String(a).replace(/-/g,"+").replace(/_/g,"/");a.length%4;)a+="=";return Base64.decode(a)};this.drag_menu=function(a,b){var d=rcube_event.get_modifier(a),
e=this.gui_objects.dragmenu;return e&&d==SHIFT_KEY&&this.commands.copy?(d=rcube_event.get_mouse_pos(a),this.env.drag_target=b,this.show_menu(this.gui_objects.dragmenu.id,!0,a),$(e).css({top:d.y-10+"px",left:d.x-10+"px"}),!0):!1};this.drag_menu_action=function(a){var b=this.gui_objects.dragmenu;b&&$(b).hide();this.command(a,this.env.drag_target);this.env.drag_target=null};this.drag_start=function(a){this.drag_active=!0;this.preview_timer&&clearTimeout(this.preview_timer);this.treelist&&this.treelist.drag_start()};
this.drag_end=function(a){var b,d;this.treelist&&this.treelist.drag_end();if(b=this.message_list)d=this.env.mailboxes;else if(b=this.contact_list)d=this.env.contactfolders;this.drag_active&&d&&this.env.last_folder_target&&!rcube_event.is_keyboard(a)&&(d=d[this.env.last_folder_target],b.draglayer.hide(),this.contact_list?this.contacts_drag_menu(a,d)||this.command("move",d):this.drag_menu(a,d)||this.command("move",d));this.drag_active=!1;this.env.last_folder_target=null};this.drag_move=function(a){if(this.gui_objects.folderlist){var b,
d,e="draglayernormal";a=rcube_event.get_mouse_pos(a);this.contact_list&&this.contact_list.draglayer&&(d=this.contact_list.draglayer.attr("class"));this.treelist&&(b=this.treelist.intersects(a,!0))?(this.env.last_folder_target=b,e="draglayer"+(1<this.check_droptarget(b)?"copy":"normal")):this.env.last_folder_target=null;e!=d&&this.contact_list&&this.contact_list.draglayer&&this.contact_list.draglayer.attr("class",e)}};this.collapse_folder=function(a){this.treelist&&this.treelist.toggle(a)};this.folder_collapsed=
function(a){this.folder_collapsed_timer&&clearTimeout(this.folder_collapsed_timer);var b="addressbook"==this.env.task?"collapsed_abooks":"collapsed_folders",d=this.env[b];if(a.collapsed)this.env[b]=this.env[b]+"&"+urlencode(a.id)+"&",!a.virtual&&this.env.mailbox&&this.env.mailbox.startsWith(a.id+this.env.delimiter)&&this.command("list",a.id);else{var e=RegExp("&"+urlencode(a.id)+"&");this.env[b]=this.env[b].replace(e,"")}this.drag_active||(d!==this.env[b]&&(this.folder_collapsed_timer=setTimeout(function(){f.command("save-pref",
{name:b,value:f.env[b]})},10)),this.env.unread_counts&&this.set_unread_count_display(a.id,!1))};this.doc_mouse_up=function(a){var b,d=rcube_event.get_target(a);if(!$(d).closest(".ui-dialog, .ui-widget-overlay").length){window.rcube_list_widget&&rcube_list_widget._instances.length&&$.each(rcube_list_widget._instances,function(b,d){d&&!rcube_mouse_is_over(a,d.list.parentNode)&&d.blur()});if(this.buttons_sel){for(b in this.buttons_sel)"function"!==typeof b&&this.button_out(this.buttons_sel[b],b);this.buttons_sel=
{}}setTimeout(function(a){var b,k,h,l,m=$(d).parents();for(l=f.menu_stack.length-1;0<=l;l--)h=f.menu_stack[l],b=$("#"+h),!b.is(":visible")||d==b.data("opener")||d==b.get(0)||m.is(b.data("opener"))||h==k||"true"==b.attr("data-editable")&&$(d).parents("#"+h).length||"true"==b.attr("data-sticky")&&rcube_mouse_is_over(a,b.get(0))||f.hide_menu(h,a),k=b.data("parent")},10,a)}};this.doc_keypress=function(a){var b=function(a){var b,d=0>a?"prevAll":"nextAll",e=0>a?"last":"first";return f.focused_menu&&(b=
$("#"+f.focused_menu))?(a=b.find(":focus").closest("li")[d]().has(":not([aria-disabled=true])").find("a,input")[e](),a.length||(a=b.find(":focus").closest("ul")[d]().has(":not([aria-disabled=true])").find("a,input")[e]()),a.focus().length):0},d=a.target||{},e=rcube_event.get_keycode(a);if(27!=a.keyCode&&(!this.menu_keyboard_active||"TEXTAREA"==d.nodeName||"SELECT"==d.nodeName))return!0;switch(e){case 38:case 40:case 63232:case 63233:return b(38==e||63232==e?-1:1),rcube_event.cancel(a);case 9:return this.focused_menu&&
(d=rcube_event.get_modifier(a),b(d==SHIFT_KEY?-1:1)||this.hide_menu(this.focused_menu,a)),rcube_event.cancel(a);case 27:this.menu_stack.length&&this.hide_menu(this.menu_stack[this.menu_stack.length-1],a)}return!0};this.list_keypress=function(a,b){a.modkey!=CONTROL_KEY&&(a.key_pressed==a.DELETE_KEY||a.key_pressed==a.BACKSPACE_KEY?this.command(b&&b.del?b.del:"delete"):33==a.key_pressed?this.command(b&&b.prev?b.prev:"previouspage"):34==a.key_pressed&&this.command(b&&b.next?b.next:"nextpage"))};this.msglist_keypress=
function(a){a.key_pressed!=a.ENTER_KEY||this.env.contentframe?this.list_keypress(a):this.command("show")};this.msglist_select=function(a){this.preview_timer&&clearTimeout(this.preview_timer);var b=a.get_single_selection(),d=a.get_selection(!1).length;this.enable_command(this.env.message_commands,null!=b);b&&(this.get_message_mailbox(b)==this.env.drafts_mailbox?this.enable_command("reply","reply-all","reply-list","forward","forward-attachment","forward-inline",!1):this.env.messages[b].ml||this.enable_command("reply-list",
!1));this.enable_command("delete","move","copy","mark","forward","forward-attachment",0<d);if(b||d&&d!=a.rowcount)this.select_all_mode=!1;b&&this.env.contentframe&&!a.multi_selecting&&!this.dummy_select?(a=(new Date).getTime(),b=this.preview_delay_click,a-(this._last_msglist_select_time||0)<this.preview_delay_select&&(b=this.preview_delay_select,this.preview_timer&&clearTimeout(this.preview_timer),this.env.contentframe&&this.show_contentframe(!1)),this._last_msglist_select_time=a,this.preview_timer=
setTimeout(function(){f.msglist_get_preview()},b)):this.env.contentframe&&this.show_contentframe(!1)};this.msglist_dbl_click=function(a){this.preview_timer&&clearTimeout(this.preview_timer);var b=a.get_single_selection();b&&(a=this.get_message_mailbox(b),a==this.env.drafts_mailbox?this.open_compose_step({_draft_uid:b,_mbox:a}):this.show_message(b))};this.msglist_get_preview=function(){var a=this.get_single_uid();a&&this.env.contentframe&&!this.drag_active?this.show_message(a,!1,!0):this.env.contentframe&&
this.show_contentframe(!1)};this.msglist_expand=function(a){this.env.messages[a.uid]&&(this.env.messages[a.uid].expanded=a.expanded);$(a.obj)[a.expanded?"addClass":"removeClass"]("expanded")};this.msglist_set_coltypes=function(a){var b,d=a.thead.rows[0].cells;this.env.listcols=[];for(a=0;a<d.length;a++)d[a].id&&d[a].id.startsWith("rcm")&&(b=d[a].id.slice(3),this.env.listcols.push(b));0<=(a=$.inArray("flag",this.env.listcols))&&(this.env.flagged_col=a);0<=(a=$.inArray("subject",this.env.listcols))&&
(this.env.subject_col=a);this.command("save-pref",{name:"list_cols",value:this.env.listcols,session:"list_attrib/columns"})};this.check_droptarget=function(a){switch(this.task){case "mail":return!this.env.mailboxes[a]||this.env.mailboxes[a].virtual||this.env.mailboxes[a].id==this.env.mailbox&&!this.is_multifolder_listing()?0:1;case "addressbook":var b;if(a!=this.env.source&&(b=this.env.contactfolders[a]))if("group"==b.type){if(b.id!=this.env.group&&!this.env.contactfolders[b.source].readonly)return!(1<
this.env.selection_sources.length||-1==$.inArray(b.source,this.env.selection_sources))||this.commands.move?1:2}else if(!b.readonly&&(1<this.env.selection_sources.length||-1==$.inArray(a,this.env.selection_sources)))return this.commands.move?1:2}return 0};this.open_window=function(a,b,d){var e="rcmextwin"+(new Date).getTime();a+=(a.match(/\?/)?"&":"?")+"_extwin=1";if(this.env.standard_windows)var g=window.open(a,e);else{var k=this.is_framed()?parent.window:window,f=$(k),l=f.width(),f=bw.mz?$("body",
k).height():f.height();b=Math.min(b?this.env.popup_width_small:this.env.popup_width,l);g=window.open(a,e,"width="+b+",height="+f+",top="+((k.screenTop||k.screenY)+20)+",left="+((k.screenLeft||k.screenX)+20)+",resizable=yes,location=no,scrollbars=yes"+(d?",toolbar=yes,menubar=yes,status=yes":",toolbar=no,menubar=no,status=no"))}if(!g||g.closed)this.display_message("windowopenerror","warning");else return!a&&g.document&&g.document.write("<html><body>"+this.get_label("loading")+"</body></html>"),this.triggerEvent("openwindow",
{url:a,handle:g}),setTimeout(function(){g&&g.focus()},10),g};this.init_message_row=function(a){var b={},d=a.uid,e=(null!=this.env.status_col?"status":"msg")+"icn"+a.id;d&&this.env.messages[d]&&$.extend(a,this.env.messages[d]);if(a.icon=document.getElementById(e))b.icon=function(a){f.command("toggle_status",d)};a.msgicon=null!=this.env.status_col?document.getElementById("msgicn"+a.id):a.icon;null!=this.env.flagged_col&&(a.flagicon=document.getElementById("flagicn"+a.id))&&(b.flagicon=function(a){f.command("toggle_flag",
d)});!a.depth&&a.has_children&&(a.expando=document.getElementById("rcmexpando"+a.id))&&(b.expando=function(a){f.expand_message_row(a,d)});$.each(b,function(b,d){a[b].onclick=function(a){d(a);return rcube_event.cancel(a)};bw.touch&&a[b].addEventListener&&a[b].addEventListener("touchend",function(a){if(1==a.changedTouches.length)return d(a),rcube_event.cancel(a)},!1)});this.triggerEvent("insertrow",{uid:d,row:a})};this.add_message_row=function(a,b,d,e){if(!this.gui_objects.messagelist||!this.message_list||
d.mbox!=this.env.mailbox&&!d.skip_mbox_check||this.message_list.rows[a])return!1;this.env.messages[a]||(this.env.messages[a]={});$.extend(this.env.messages[a],{deleted:d.deleted?1:0,replied:d.answered?1:0,unread:d.seen?0:1,forwarded:d.forwarded?1:0,flagged:d.flagged?1:0,has_children:d.has_children?1:0,depth:d.depth?d.depth:0,unread_children:d.unread_children||0,flagged_children:d.flagged_children||0,parent_uid:d.parent_uid||0,selected:this.select_all_mode||this.message_list.in_selection(a),ml:d.ml?
1:0,ctype:d.ctype,mbox:d.mbox,flags:d.extra_flags});var g,k,f,l,m="",q=f="",p="",s=this.message_list;l=s.rows;var t=this.env.messages[a],u=this.html_identifier(a,!0),w="message"+(d.seen?"":" unread")+(d.deleted?" deleted":"")+(d.flagged?" flagged":"")+(t.selected?" selected":""),v={cols:[],style:{},id:"rcmrow"+u,uid:a};g="msgicon";null===this.env.status_col&&(g+=" status",d.deleted?(m+=" deleted",f+=this.get_label("deleted")+" "):d.seen?0<d.unread_children&&(m+=" unreadchildren"):(m+=" unread",f+=
this.get_label("unread")+" "));d.answered&&(m+=" replied",f+=this.get_label("replied")+" ");d.forwarded&&(m+=" forwarded",f+=this.get_label("forwarded")+" ");t.selected&&!s.in_selection(a)&&s.selection.push(a);this.env.threading&&(t.depth?(q+='<span id="rcmtab'+u+'" class="branch" style="width:'+15*t.depth+'px;">&nbsp;&nbsp;</span>',l[t.parent_uid]&&!1===l[t.parent_uid].expanded||!(0!=this.env.autoexpand_threads&&2!=this.env.autoexpand_threads||l[t.parent_uid]&&l[t.parent_uid].expanded)?(v.style.display=
"none",t.expanded=!1):t.expanded=!0,w+=" thread expanded"):t.has_children&&(void 0===t.expanded&&(1==this.env.autoexpand_threads||2==this.env.autoexpand_threads&&t.unread_children)&&(t.expanded=!0),p='<div id="rcmexpando'+v.id+'" class="'+(t.expanded?"expanded":"collapsed")+'">&nbsp;&nbsp;</div>',w+=" thread"+(t.expanded?" expanded":"")),d.unread_children&&d.seen&&!t.expanded&&(w+=" unroot"),d.flagged_children&&!t.expanded&&(w+=" flaggedroot"));q+='<span id="msgicn'+v.id+'" class="'+g+m+'" title="'+
f+'"></span>';v.className=w;b.subject&&(g=d.mbox==this.env.drafts_mailbox?"compose":"show",f={_mbox:d.mbox},f[d.mbox==this.env.drafts_mailbox?"_draft_uid":"_uid"]=a,b.subject='<a href="'+this.url(g,f)+'" onclick="return rcube_event.keyboard_only(event)" onmouseover="rcube_webmail.long_subject_title(this,'+(t.depth+1)+')" tabindex="-1"><span>'+b.subject+"</span></a>");for(k in this.env.listcols)g=this.env.listcols[k],f={className:String(g).toLowerCase(),events:{}},this.env.coltypes[g]&&this.env.coltypes[g].hidden&&
(f.className+=" hidden"),"flag"==g?(g=d.flagged?"flagged":"unflagged",l=this.get_label(g),g='<span id="flagicn'+v.id+'" class="'+g+'" title="'+l+'"></span>'):"attachment"==g?(l=this.get_label("withattachment"),g=d.attachmentClass?'<span class="'+d.attachmentClass+'" title="'+l+'"></span>':"multipart/report"==d.ctype?'<span class="report"></span>':"multipart/encrypted"==d.ctype||"application/pkcs7-mime"==d.ctype?'<span class="encrypted"></span>':d.hasattachment||!d.hasnoattachment&&/application\/|multipart\/(m|signed)/.test(d.ctype)?
'<span class="attachment" title="'+l+'"></span>':"&nbsp;"):"status"==g?(l="",d.deleted?(g="deleted",l=this.get_label("deleted")):d.seen?g=0<d.unread_children?"unreadchildren":"msgicon":(g="unread",l=this.get_label("unread")),g='<span id="statusicn'+v.id+'" class="'+g+m+'" title="'+l+'"></span>'):"threads"==g?g=p:"subject"==g?g=q+b[g]:"priority"==g?0<d.prio&&6>d.prio?(l=this.get_label("priority")+" "+d.prio,g='<span class="prio'+d.prio+'" title="'+l+'"></span>'):g="&nbsp;":g="folder"==g?'<span onmouseover="rcube_webmail.long_subject_title(this)">'+
b[g]+"<span>":b[g],f.innerHTML=g,v.cols.push(f);"widescreen"==this.env.layout&&(v=this.widescreen_message_row(v,a,t));s.insert_row(v,e);e&&this.env.pagesize&&s.rowcount>this.env.pagesize&&(a=s.get_last_row(),s.remove_row(a),s.clear_selection(a))};this.widescreen_message_row=function(a,b,d){var e=document.createElement("tr");e.id=a.id;e.uid=a.uid;e.className=a.className;a.style&&$.extend(e.style,a.style);$.each(this.env.widescreen_list_template,function(){if(f.env.threading||"threads"!=this.className){var b,
d,h,l=document.createElement("td");this.className&&(l.className=this.className);for(b=0;this.cells&&b<this.cells.length;b++)for(d=0;a.cols&&d<a.cols.length;d++)if(this.cells[b]==a.cols[d].className){d=a.cols[d];h=document.createElement("span");h.className=this.cells[b];"subject"==this.className&&"subject"!=h.className&&(h.className+=" skip-on-drag");d.innerHTML&&(h.innerHTML=d.innerHTML);l.appendChild(h);break}e.appendChild(l)}});this.env.threading&&d.depth&&(n=this.calculate_thread_padding(d.depth),
$("td.subject",e).attr("style","padding-left:"+n+" !important"),$("span.branch",e).remove());return e};this.calculate_thread_padding=function(a){f.env.thread_padding.match(/^([0-9.]+)(.+)/);return Math.min(6,a)*parseFloat(RegExp.$1)+RegExp.$2};this.set_list_sorting=function(a,b){var d="arrival"==a?"date":a;$("#rcm"+("arrival"==this.env.sort_col?"date":this.env.sort_col)).removeClass("sorted"+this.env.sort_order.toUpperCase());d&&$("#rcm"+d).addClass("sorted"+b);$("#rcmdate > a").prop("rel","arrival"==
a?"arrival":"date");this.env.sort_col=a;this.env.sort_order=b};this.set_list_options=function(a,b,d,e,g){var f,h={};void 0===b&&(b=this.env.sort_col);d||(d=this.env.sort_order);if(this.env.sort_col!=b||this.env.sort_order!=d)f=1,this.set_list_sorting(b,d);this.env.threading!=e&&(f=1,h._threads=e);g&&this.env.layout!=g&&(this.triggerEvent("layout-change",{old_layout:this.env.layout,new_layout:g}),f=1,this.env.layout=h._layout=g);if(a&&a.length){var l,m=[],q=this.env.listcols;for(e=0;e<q.length;e++)l=
q[e],g=$.inArray(l,a),-1!=g&&(m.push(l),delete a[g]);for(e=0;e<a.length;e++)a[e]&&m.push(a[e]);m.join()!=q.join()&&(f=1,h._cols=m.join(","))}f&&this.list_mailbox("","",b+"_"+d,h)};this.show_message=function(a,b,d){if(a){var e,g=window,f=this.params_from_uid(a,{_caps:this.browser_capabilities()});d&&(e=this.get_frame_window(this.env.contentframe))&&(g=e,f._framed=1);b&&(f._safe=1);this.env.search_request&&(f._search=this.env.search_request);this.env.extwin&&(f._extwin=1);f=this.url(d?"preview":"show",
f);d&&(this.preview_id=a);d&&0<=String(g.location.href).indexOf(f)?this.show_contentframe(!0):d||!this.env.message_extwin||this.env.extwin?this.location_href(f,g,!0):this.open_window(f,!0)}};this.set_unread_message=function(a,b){var d=this;d.message_list||(d=d.opener());!d&&window.parent&&(d=parent.rcmail);d&&d.message_list&&(!1===d.set_message(a,"unread",!1)&&d.set_message(a+"-"+b,"unread",!1),0<d.env.unread_counts[b]&&(d.env.unread_counts[b]-=1,d.set_unread_count(b,d.env.unread_counts[b],"INBOX"==
b&&!d.is_multifolder_listing())))};this.show_contentframe=function(a){var b,d,e=this.env.contentframe;if(b=this.get_frame_element(e))if(!a&&(d=this.get_frame_window(e)))0>d.location.href.indexOf(this.env.blankpage)&&(d.stop?d.stop():d.document.execCommand("Stop"),d.location.href=this.env.blankpage);else if(!bw.safari&&!bw.konq)$(b)[a?"show":"hide"]();a||(this.unlock_frame(),delete this.preview_id)};this.get_frame_element=function(a){var b;if(a&&(b=document.getElementById(a)))return b};this.get_frame_window=
function(a){if((a=this.get_frame_element(a))&&a.name&&window.frames)return window.frames[a.name]};this.lock_frame=function(a){var b=this.is_framed()?parent.rcmail:this;b.env.frame_lock||(b.env.frame_lock=b.set_busy(!0,"loading"));if(a.frameElement)$(a.frameElement).on("load.lock",function(a){b.unlock_frame();$(this).off("load.lock")})};this.unlock_frame=function(){this.env.frame_lock&&(this.set_busy(!1,null,this.env.frame_lock),this.env.frame_lock=null)};this.list_page=function(a){"next"==a?a=this.env.current_page+
1:"last"==a?a=this.env.pagecount:"prev"==a&&1<this.env.current_page?a=this.env.current_page-1:"first"==a&&1<this.env.current_page&&(a=1);0<a&&a<=this.env.pagecount&&(this.env.current_page=a,"addressbook"==this.task||this.contact_list?this.list_contacts(this.env.source,this.env.group,a):"mail"==this.task&&this.list_mailbox(this.env.mailbox,a))};this.checkmail=function(){var a=this.set_busy(!0,"checkingmail"),b=this.check_recent_params();this.http_post("check-recent",b,a)};this.filter_mailbox=function(a){if(!this.filter_disabled){var b=
this.search_params(!1,a),d=this.set_busy(!0,"searching");this.clear_message_list();this.env.current_page=1;this.env.search_filter=a;this.http_request("search",b,d);this.update_state({_mbox:b._mbox,_filter:a,_scope:b._scope})}};this.refresh_list=function(){this.list_mailbox(this.env.mailbox,this.env.current_page||1,null,{_clear:1},!0);this.message_list&&this.message_list.clear_selection()};this.list_mailbox=function(a,b,d,e,g){var f=window;"object"!=typeof e&&(e={});a||(a=this.env.mailbox?this.env.mailbox:
"INBOX");d&&(e._sort=d);this.env.mailbox!=a?(b=1,this.env.current_page=b,this.env.search_scope="base",this.select_all_mode=!1,this.reset_search_filter()):this.env.search_request&&(e._search=this.env.search_request);if(!g){this.clear_message_list();if(a!=this.env.mailbox||a==this.env.mailbox&&!b&&!d)e._refresh=1;this.select_folder(a,"",!0);this.unmark_folder(a,"recent","",!0);this.env.mailbox=a}if(this.gui_objects.messagelist)this.list_mailbox_remote(a,b,e);else{if(d=this.get_frame_window(this.env.contentframe))f=
d,e._framed=1;this.env.uid&&(e._uid=this.env.uid);a&&(e._mbox=a,e._page=b,this.set_busy(!0,"loading"),this.location_href(e,f))}};this.clear_message_list=function(){this.env.messages={};this.show_contentframe(!1);this.message_list&&this.message_list.clear(!0)};this.list_mailbox_remote=function(a,b,d){var e=this.set_busy(!0,"loading");"object"!=typeof d&&(d={});d._layout=this.env.layout;d._mbox=a;d._page=b;this.http_request("list",d,e);this.update_state({_mbox:a,_page:b&&1<b?b:null})};this.update_selection=
function(){var a=this.message_list,b=a.selection,d=a.rows,e,g=[];for(e in b)d[b[e]]&&g.push(b[e]);a.selection=g;try{var f=this.get_frame_window(this.env.contentframe).rcmail.env.uid;f&&!a.in_selection(f)&&this.show_contentframe(!1)}catch(h){}};this.expand_unread=function(){for(var a,b=this.message_list.tbody.firstChild;b;)1==b.nodeType&&(a=this.message_list.rows[b.uid])&&a.unread_children&&(this.message_list.expand_all(a),this.set_unread_children(a.uid)),b=b.nextSibling;return!1};this.expand_message_row=
function(a,b){var d=this.message_list.rows[b];d.expanded=!d.expanded;this.set_unread_children(b);this.set_flagged_children(b);d.expanded=!d.expanded;this.message_list.expand_row(a,b)};this.expand_threads=function(){if(this.env.threading&&this.env.autoexpand_threads&&this.message_list)switch(this.env.autoexpand_threads){case 2:this.expand_unread();break;case 1:this.message_list.expand_all()}};this.init_threads=function(a,b){if(b&&b!=this.env.mailbox)return!1;for(var d=0,e=a.length;d<e;d++)this.add_tree_icons(a[d]);
this.expand_threads()};this.add_tree_icons=function(a){var b,d,e,g,f=[],h=[],l,m=this.message_list.rows;for(l=a?m[a]?m[a].obj:null:this.message_list.tbody.firstChild;l;){if(1==l.nodeType&&(d=m[l.uid]))if(d.depth){for(b=f.length-1;0<=b&&!(e=f[b].length,e>d.depth?(g=e-d.depth,f[b][g]&2||(f[b][g]=f[b][g]?f[b][g]+2:2)):e==d.depth&&(f[b][0]&2||(f[b][0]+=2)),d.depth>e);b--);f.push(Array(d.depth));f[f.length-1][0]=1;h.push(d.uid)}else{if(f.length){for(b in f)this.set_tree_icons(h[b],f[b]);f=[];h=[]}if(a&&
l!=m[a].obj)break}l=l.nextSibling}if(f.length)for(b in f)this.set_tree_icons(h[b],f[b])};this.set_tree_icons=function(a,b){var d,e=[],g="",f=b.length;for(d=0;d<f;d++)2<b[d]?e.push({"class":"l3",width:15}):1<b[d]?e.push({"class":"l2",width:15}):0<b[d]?e.push({"class":"l1",width:15}):e.length&&!e[e.length-1]["class"]?e[e.length-1].width+=15:e.push({"class":null,width:15});for(d=e.length-1;0<=d;d--)g=e[d]["class"]?g+('<div class="tree '+e[d]["class"]+'" />'):g+('<div style="width:'+e[d].width+'px" />');
g&&$("#rcmtab"+this.html_identifier(a,!0)).html(g)};this.update_thread_root=function(a,b){if(this.env.threading){var d=this.message_list.find_root(a);if(a!=d){var e=this.message_list.rows[d];if("read"==b&&e.unread_children)e.unread_children--;else if("unread"==b&&e.has_children)e.unread_children=(e.unread_children||0)+1;else if("unflagged"==b&&e.flagged_children)e.flagged_children--;else if("flagged"==b&&e.has_children)e.flagged_children=(e.flagged_children||0)+1;else return;this.set_message_icon(d);
this.set_unread_children(d);this.set_flagged_children(d)}}};this.update_thread=function(a){if(!this.env.threading||!this.message_list.rows[a])return 0;var b,d,e=0,g=this.message_list,k=g.rows,h=k[a],l=k[a].depth,m=[];h.depth||e--;h.depth&&h.unread&&(d=g.find_root(a),k[d].unread_children--,this.set_unread_children(d));h.depth&&h.flagged&&(d=g.find_root(a),k[d].flagged_children--,this.set_flagged_children(d));d=h.parent_uid;for(h=h.obj.nextSibling;h;){if(1==h.nodeType&&(b=k[h.uid])){if(!b.depth||b.depth<=
l)break;b.depth--;$("#rcmtab"+b.id).width(15*b.depth).html("");b.depth?(b.depth==l&&(b.parent_uid=d),b.unread&&m.length&&m[m.length-1].unread_children++):(e++,b.parent_uid=0,b.has_children&&($("#"+b.id+" .leaf").first().attr("id","rcmexpando"+b.id).attr("class","none"!=b.obj.style.display?"expanded":"collapsed").mousedown({uid:b.uid},function(a){return f.expand_message_row(a,a.data.uid)}),b.unread_children=0,m.push(b)),"none"==b.obj.style.display&&$(b.obj).show())}h=h.nextSibling}for(b=0;b<m.length;b++)this.set_unread_children(m[b].uid),
this.set_flagged_children(m[b].uid);return e};this.delete_excessive_thread_rows=function(){for(var a=this.message_list.rows,b=this.message_list.tbody.firstChild,d=this.env.pagesize+1;b;)1==b.nodeType&&(r=a[b.uid])&&(!r.depth&&d&&d--,d||this.message_list.remove_row(b.uid)),b=b.nextSibling};this.set_message_icon=function(a){var b="",d=this.message_list.rows[a];if(!d)return!1;d.icon&&(a="msgicon",d.deleted?(a+=" deleted",b+=this.get_label("deleted")+" "):d.unread?(a+=" unread",b+=this.get_label("unread")+
" "):d.unread_children&&(a+=" unreadchildren"),d.msgicon==d.icon&&(d.replied&&(a+=" replied",b+=this.get_label("replied")+" "),d.forwarded&&(a+=" forwarded",b+=this.get_label("forwarded")+" "),a+=" status"),$(d.icon).attr({"class":a,title:b}));d.msgicon&&d.msgicon!=d.icon&&(b="",a="msgicon",!d.unread&&d.unread_children&&(a+=" unreadchildren"),d.replied&&(a+=" replied",b+=this.get_label("replied")+" "),d.forwarded&&(a+=" forwarded",b+=this.get_label("forwarded")+" "),$(d.msgicon).attr({"class":a,title:b}));
d.flagicon&&(a=d.flagged?"flagged":"unflagged",b=this.get_label(a),$(d.flagicon).attr("class",a).attr({"aria-label":b,title:b}))};this.set_message_status=function(a,b,d){var e=this.message_list.rows[a];if(!e)return!1;"unread"==b?e.unread!=d&&this.update_thread_root(a,d?"unread":"read"):"flagged"==b&&this.update_thread_root(a,d?"flagged":"unflagged");-1<$.inArray(b,["unread","deleted","replied","forwarded","flagged"])&&(e[b]=d)};this.set_message=function(a,b,d){var e=this.message_list&&this.message_list.rows[a];
if(!e)return!1;b&&this.set_message_status(a,b,d);if(-1<$.inArray(b,["unread","deleted","flagged"]))$(e.obj)[e[b]?"addClass":"removeClass"](b);this.set_unread_children(a);this.set_message_icon(a)};this.set_unread_children=function(a){a=this.message_list.rows[a];if(!a.parent_uid){var b=!a.unread&&a.unread_children&&!a.expanded;$(a.obj)[b?"addClass":"removeClass"]("unroot")}};this.set_flagged_children=function(a){a=this.message_list.rows[a];if(!a.parent_uid){var b=a.flagged_children&&!a.expanded;$(a.obj)[b?
"addClass":"removeClass"]("flaggedroot")}};this.copy_messages=function(a,b,d){if(a&&"object"===typeof a)a.uids&&(d=a.uids),a=a.id;else if(!a)return d=this.env.uid?[this.env.uid]:this.message_list.get_selection(),this.folder_selector(b,function(a,g){f.command("copy",{id:a,uids:d},g,b,!0)});a&&a!=this.env.mailbox&&(a=this.selection_post_data({_target_mbox:a,_uid:d}),a._uid&&this.http_post("copy",a,this.display_message("copyingmessage","loading")))};this.move_messages=function(a,b,d){if(a&&"object"===
typeof a)a.uids&&(d=a.uids),a=a.id;else if(!a)return d=this.env.uid?[this.env.uid]:this.message_list.get_selection(),this.folder_selector(b,function(a,e){f.command("move",{id:a,uids:d},e,b,!0)});if(a&&(a!=this.env.mailbox||this.is_multifolder_listing())){var e=!1;a=this.selection_post_data({_target_mbox:a,_uid:d});a._uid&&("show"==this.env.action&&(e=this.set_busy(!0,"movingmessage")),this.enable_command(this.env.message_commands,!1),this.with_selected_messages("move",a,e),"show"!=this.env.action&&
this.show_contentframe(!1))}};this.delete_messages=function(a){var b=this.message_list,d=this.env.trash_mailbox;if(this.env.flag_for_deletion)return this.mark_message("delete"),!1;d&&this.env.mailbox!=d?this.env.delete_junk&&this.env.junk_mailbox&&this.env.mailbox==this.env.junk_mailbox?this.permanently_remove_messages():b&&b.modkey==SHIFT_KEY||a&&rcube_event.get_modifier(a)==SHIFT_KEY?this.confirm_dialog(this.get_label("deletemessagesconfirm"),"delete",function(){f.permanently_remove_messages()}):
this.move_messages(d):this.permanently_remove_messages();return!0};this.permanently_remove_messages=function(){var a=this.selection_post_data();a._uid&&(this.with_selected_messages("delete",a),this.show_contentframe(!1))};this.with_selected_messages=function(a,b,d,e){var g=0,f="delete"==a||!this.is_multifolder_listing();if(this.message_list){var h,l,m,q,p=[],s=b._uid,t=this.check_display_next();"*"===s?s=this.message_list.get_selection():"string"==typeof s&&(s=s.split(","));h=0;for(l=s.length;h<l;h++)m=
s[h],this.env.threading&&(g+=this.update_thread(m),q=this.message_list.find_root(m),q!=m&&0>$.inArray(q,p)&&p.push(q)),f&&this.message_list.remove_row(m,t&&h==s.length-1);!t&&f&&this.message_list.clear_selection();h=0;for(l=p.length;h<l;h++)this.add_tree_icons(p[h])}0>g?b._count=-1*g:0<g&&f&&this.delete_excessive_thread_rows();f||(b._refresh=1);d||(d=this.display_message("move"==a?"movingmessage":"deletingmessage","loading"));this.http_post(e||a,b,d)};this.selection_post_data=function(a){"object"!=
typeof a&&(a={});a._uid||(a._uid=this.env.uid?[this.env.uid]:this.message_list.get_selection());a._mbox=this.env.mailbox;a._uid=this.uids_to_list(a._uid);this.env.action&&(a._from=this.env.action);this.env.search_request&&(a._search=this.env.search_request);this.env.display_next&&this.env.next_uid&&(a._next_uid=this.env.next_uid);return a};this.check_display_next=function(){return this.env.display_next&&(this.preview_id||!this.env.contentframe)};this.mark_message=function(a,b){var d=[],e=[],g,f,h,
l=this.message_list;b?d[0]=b:this.env.uid?d[0]=this.env.uid:l&&(d=l.get_selection());if(l)for(l.focus(),f=0,g=d.length;f<g;f++)h=d[f],("read"==a&&l.rows[h].unread||"unread"==a&&!l.rows[h].unread||"delete"==a&&!l.rows[h].deleted||"undelete"==a&&l.rows[h].deleted||"flagged"==a&&!l.rows[h].flagged||"unflagged"==a&&l.rows[h].flagged)&&e.push(h);else e=d;if(e.length||this.select_all_mode)switch(a){case "read":case "unread":this.toggle_read_status(a,e);break;case "delete":case "undelete":this.toggle_delete_status(e);
break;case "flagged":case "unflagged":this.toggle_flagged_status(a,d)}};this.toggle_read_status=function(a,b){var d,e=b.length,g=this.selection_post_data({_uid:b,_flag:a}),f=this.display_message("markingmessage","loading");for(d=0;d<e;d++)this.set_message(b[d],"unread","unread"==a?!0:!1);this.http_post("mark",g,f)};this.toggle_flagged_status=function(a,b){var d,e=b.length,g=this.env.contentframe?this.get_frame_window(this.env.contentframe):window,f=this.selection_post_data({_uid:b,_flag:a}),h=this.display_message("markingmessage",
"loading");for(d=0;d<e;d++)this.set_message(b[d],"flagged","flagged"==a?!0:!1);if("show"==this.env.action||0<=$.inArray(this.preview_id,b))$(g.document.body)["flagged"==a?"addClass":"removeClass"]("status-flagged");this.http_post("mark",f,h)};this.toggle_delete_status=function(a){var b,d,e=!0,g=a.length,f=this.message_list?this.message_list.rows:{};if(1==g)return!this.message_list||f[a[0]]&&!f[a[0]].deleted?this.flag_as_deleted(a):this.flag_as_undeleted(a),!0;for(b=0;b<g;b++)if(d=a[b],f[d]&&!f[d].deleted){e=
!1;break}e?this.flag_as_undeleted(a):this.flag_as_deleted(a);return!0};this.flag_as_undeleted=function(a){var b,d=a.length,e=this.selection_post_data({_uid:a,_flag:"undelete"}),g=this.display_message("markingmessage","loading");for(b=0;b<d;b++)this.set_message(a[b],"deleted",!1);this.http_post("mark",e,g)};this.flag_as_deleted=function(a){for(var b=[],d=this.selection_post_data({_uid:a,_flag:"delete"}),e=this.display_message("markingmessage","loading"),g=this.message_list,f=g?g.rows:{},h=0,l=this.check_display_next(),
m=0,q=a.length;m<q;m++)uid=a[m],f[uid]&&(f[uid].unread&&(b[b.length]=uid),this.env.skip_deleted?(h+=this.update_thread(uid),g.remove_row(uid,l&&m==g.get_selection(!1).length-1)):this.set_message(uid,"deleted",!0));this.env.skip_deleted&&g&&(l&&g.rowcount||g.clear_selection(),0>h?d._count=-1*h:0<h&&this.delete_excessive_thread_rows());b.length&&(d._ruid=this.uids_to_list(b));this.env.skip_deleted&&this.env.display_next&&this.env.next_uid&&(d._next_uid=this.env.next_uid);this.http_post("mark",d,e)};
this.flag_deleted_as_read=function(a){var b,d,e,g=this.message_list?this.message_list.rows:{};"string"==typeof a&&(a=a.split(","));d=0;for(e=a.length;d<e;d++)b=a[d],g[b]&&this.set_message(b,"unread",!1)};this.uids_to_list=function(a){if(this.select_all_mode)return"*";!$.isArray(a)||1!=a.length&&-1!=String(a[0]).indexOf("-")||(a=a.join(","));return a};this.set_button_titles=function(){var a="deletemessage";this.env.flag_for_deletion||!this.env.trash_mailbox||this.env.mailbox==this.env.trash_mailbox||
this.env.delete_junk&&this.env.junk_mailbox&&this.env.mailbox==this.env.junk_mailbox||(a="movemessagetotrash");this.set_alttext("delete",a)};this.init_pagejumper=function(a){$(a).addClass("rcpagejumper").on("focus",function(b){var d,e="";for(d=1;d<=f.env.pagecount;d++)e+="<li>"+d+"</li>";e='<ul class="toolbarmenu menu">'+e+"</ul>";f.pagejump||(f.pagejump=$('<div id="pagejump-selector" class="popupmenu"></div>').appendTo(document.body).on("click","li",function(){f.busy||$(a).val($(this).text()).change()}));
f.pagejump.data("count")!=d&&f.pagejump.html(e);f.pagejump.attr("rel","#"+this.id).data("count",d);f.show_menu("pagejump-selector",!0,b);$(this).keydown()}).on("keydown keyup click",function(b){var d=$("#pagejump-selector"),e=$("ul",d),g=$("li",e);e.height();var k=parseInt(this.value);if(27!=b.which&&9!=b.which&&13!=b.which&&!d.is(":visible"))return f.show_menu("pagejump-selector",!0,b);if("keydown"==b.type)if(40==b.which)g.length>k&&(this.value=k+=1);else if(38==b.which)1<k&&g.length>k-1&&(this.value=
k-=1);else{if(13==b.which)return $(this).change();if(27==b.which||9==b.which)return f.hide_menu("pagejump-selector",b),$(a).val(f.env.current_page)}$("li.selected",e).removeClass("selected");(b=$(g[k-1])).length&&(b.addClass("selected"),$("#pagejump-selector").scrollTop(e.height()/g.length*(k-1)-d.height()/2))}).on("change",function(a){var d=parseInt(this.value);d&&d!=f.env.current_page&&!f.busy&&(f.hide_menu("pagejump-selector",a),f.list_page(d))})};this.update_pagejumper=function(){$("input.rcpagejumper").val(this.env.current_page).prop("disabled",
2>this.env.pagecount)};this.check_mailvelope=function(a){if("undefined"!==typeof window.mailvelope)this.mailvelope_load(a);else $(window).on("mailvelope",function(){f.mailvelope_load(a)})};this.mailvelope_load=function(a){this.env.browser_capabilities&&(this.env.browser_capabilities.pgpmime=1);var b=this.env.user_id,d=function(b){f.mailvelope_keyring=b;f.mailvelope_init(a,b)};mailvelope.getVersion().then(function(a){mailvelope.VERSION=a;mailvelope.VERSION_MAJOR=Math.floor(parseFloat(a));return mailvelope.getKeyring(b)}).then(d,
function(a){mailvelope.createKeyring(b).then(d,function(a){console.error(a)})})};this.mailvelope_init=function(a,b){if(window.mailvelope)if("show"==a||"preview"==a||"print"==a)if(this.env.is_pgp_content){var d=$(this.env.is_pgp_content).text();f.mailvelope_display_container(this.env.is_pgp_content,d,b)}else{if(this.env.pgp_mime_part){var e=this.display_message("loadingdata","loading"),g=this.env.pgp_mime_container;$.ajax({type:"GET",url:this.url("get",{_mbox:this.env.mailbox,_uid:this.env.uid,_part:this.env.pgp_mime_part}),
error:function(a,b,d){f.http_error(a,b,d,e)},success:function(a){f.mailvelope_display_container(g,a,b,e)}})}}else if("compose"==a){this.env.compose_commands.push("compose-encrypted");var k=2<=mailvelope.VERSION_MAJOR,h=0<$('[name="_is_html"]').val();k&&this.env.compose_commands.push("compose-encrypted-signed");if(this.env.pgp_mime_message){var l=this.set_busy(!0,this.get_label("loadingdata"));$.ajax({type:"GET",url:this.url("get",this.env.pgp_mime_message),error:function(a,b,d){f.http_error(a,b,d,
l);f.enable_command("compose-encrypted",!h);k&&f.enable_command("compose-encrypted-signed",!h)},success:function(a){f.set_busy(!1,null,l);h&&(f.command("toggle-editor",{html:!1,noconvert:!0}),$("#"+f.env.composebody).val(""));f.compose_encrypted({quotedMail:a});f.enable_command("compose-encrypted",!0);f.enable_command("compose-encrypted-signed",!1)}})}else this.enable_command("compose-encrypted",!h),k&&this.enable_command("compose-encrypted-signed",!h);this.addEventListener("actionafter",function(a){a.ret&&
"toggle-editor"==a.action&&(f.enable_command("compose-encrypted",!a.props.html),k&&f.enable_command("compose-encrypted-signed",!a.props.html))})}else"edit-identity"==a&&f.mailvelope_identity_keygen()};this.compose_encrypted_signed=function(a){a=a||{};a.signMsg=!0;this.compose_encrypted(a)};this.compose_encrypted=function(a){var b,d=$("#"+this.env.composebody).parent();f.mailvelope_editor?(f.mailvelope_editor=null,f.compose_skip_unsavedcheck=!1,f.set_button("compose-encrypted","act"),d.removeClass("mailvelope").find("iframe:not([aria-hidden=true])").remove(),
$("#"+f.env.composebody).show(),$("[name='_pgpmime']").remove(),f.enable_command("toggle-editor","insert-response","save-response",!0),f.enable_command("spellcheck",!!window.googie),f.enable_command("insert-sig",!!(f.env.signatures&&f.env.identity&&f.env.signatures[f.env.identity])),f.triggerEvent("compose-encrypted",{active:!1})):(this.spellcheck_state()&&this.editor.spellcheck_stop(),b=a.quotedMail?{quotedMail:a.quotedMail,quotedMailIndent:!1}:{predefinedText:$("#"+this.env.composebody).val()},
a.signMsg&&(b.signMsg=a.signMsg),"reply"==this.env.compose_mode&&(b.quotedMailIndent=!0,b.quotedMailHeader=this.env.compose_reply_header),mailvelope.createEditorContainer("#"+d.attr("id"),f.mailvelope_keyring,b).then(function(a){f.mailvelope_editor=a;f.compose_skip_unsavedcheck=!0;f.set_button("compose-encrypted","sel");d.addClass("mailvelope");$("#"+f.env.composebody).hide();f.enable_command("spellcheck","insert-sig","toggle-editor","insert-response","save-response",!1);f.triggerEvent("compose-encrypted",
{active:!0});f.env.attachments&&!$.isEmptyObject(f.env.attachments)&&(f.alert_dialog(f.get_label("encryptnoattachments")),$.each(f.env.attachments,function(a,b){f.remove_from_attachment_list(a)}))},function(a){console.error(a);console.log(b)}))};this.mailvelope_submit_messageform=function(a,b){var d=[];$.each(["to","cc","bcc"],function(a,b){for(var e,f=$.trim($('[name="_'+b+'"]').val());f.length&&rcube_check_email(f,!0);)e=RegExp.$2.replace(/^<+/,"").replace(/>+$/,""),d.push(e),f=f.substr(f.indexOf(e)+
e.length+1).replace(/^\s*,\s*/,"")});var e=0<d.length;f.mailvelope_keyring.validKeyForAddress(d).then(function(g){var k=[];$.each(g,function(a,b){!1===b&&(e=!1,k.push(a))});if(!e&&k.length)return f.simple_dialog(f.get_label("nopubkeyfor").replace("$email",k.join(", "))+"<p>"+f.get_label("searchpubkeyservers")+"</p>","encryptedsendialog",function(){f.mailvelope_search_pubkeys(k,function(){return!0})},{button:"search"}),!1;if(!e)return d.length||f.alert_dialog(f.get_label("norecipientwarning"),function(){$("[name='_to']").focus()}),
!1;var h=[],l=f.env.identities[$("[name='_from'] option:selected").val()];$.each(f.env.identities,function(a,b){h.push(b.email)});f.mailvelope_keyring.validKeyForAddress(h).then(function(e){valid_sender=null;$.each(e,function(a,b){if(!1!==b&&(valid_sender=a,valid_sender==l))return!1});if(!valid_sender&&!confirm(f.get_label("nopubkeyforsender")))return!1;d.push(valid_sender);f.mailvelope_editor.encrypt(d).then(function(d){var e=f.gui_objects.messageform,g=$("[name='_pgpmime']",e),k=f.set_busy(!0,a||
b?"savingmessage":"sendingmessage");e.target=f.get_save_target();e._draft.value=a?"1":"";e.action=f.add_url(e.action,"_unlock",k);e.action=f.add_url(e.action,"_framed",1);b&&(e.action=f.add_url(e.action,"_saveonly",1));g.length||(g=$('<input type="hidden" name="_pgpmime">').appendTo(e));g.val(d);e.submit()},function(a){console.log(a)})},function(a){console.error(a)})},function(a){console.error(a)});return!1};this.mailvelope_display_container=function(a,b,d,e){var g=function(b){$(a+" > iframe").remove();
f.hide_message(e);f.display_message(b.message,"error")};mailvelope.createDisplayContainer(a,b,d,{senderAddress:this.env.sender}).then(function(b){if(b.error&&b.error.message)return g(b.error);f.hide_message(e);$(a).addClass("mailvelope").children().not("iframe").hide();f.env.pgp_mime_part&&$("#attach"+f.env.pgp_mime_part).remove();setTimeout(function(){$(window).resize()},10)},g)};this.mailvelope_search_pubkeys=function(a,b,d){var e=[],g=new PublicKey(this.env.keyservers),k=f.display_message("","loading");
$.each(a,function(a,b){var d=$.Deferred();g.search(b,function(a,e){null!==e?d.resolve([b]):d.resolve([b].concat(a))});e.push(d)});$.when.apply($,e).then(function(){var a=[],e=[];$.each(arguments,function(b,d){var g=d.shift();d.length?e=e.concat(d):a.push(g)});f.hide_message(k);b(!0);e.length&&f.mailvelope_key_import_dialog(e,d);a.length&&f.display_message(f.get_label("nopubkeyfor").replace("$email",a.join(", ")),"warning")}).fail(function(){console.error("Pubkey lookup failed with",arguments);f.hide_message(k);
f.display_message("pubkeysearcherror","error");b(!1)})};this.mailvelope_key_import_dialog=function(a,b){var d=$("<div>").addClass("listing pgpkeyimport");$.each(a,function(a,b){var k=$("<div>").addClass("key");b.revoked&&k.addClass("revoked");b.disabled&&k.addClass("disabled");b.expired&&k.addClass("expired");k.append($("<label>").addClass("keyid").text(f.get_label("keyid")));k.append($("<a>").text(b.keyid.substr(-8).toUpperCase()).attr({href:b.info,target:"_blank",tabindex:"-1"}));k.append($("<label>").addClass("keylen").text(f.get_label("keylength")));
k.append($("<span>").text(b.keylen));b.expirationdate&&(k.append($("<label>").addClass("keyexpired").text(f.get_label("keyexpired"))),k.append($("<span>").text((new Date(1E3*b.expirationdate)).toDateString())));b.revoked&&k.append($("<span>").addClass("keyrevoked").text(f.get_label("keyrevoked")));var h=$("<ul>").addClass("uids");$.each(b.uids,function(a,b){var d=$("<li>").addClass("uid");b.revoked&&d.addClass("revoked");b.disabled&&d.addClass("disabled");b.expired&&d.addClass("expired");h.append(d.text(b.uid))});
k.append(h);k.append($("<button>").attr("rel",b.keyid).text(f.get_label("import")).addClass("button import importkey").prop("disabled",b.revoked||b.disabled||b.expired));d.append(k)});f.simple_dialog($("<div>").append($("<p>").html(f.get_label("encryptpubkeysfound"))).append(d),f.get_label("importpubkeys"),null,{cancel_label:"close",cancel_button:"close"});d.on("click","button.importkey",function(){var a=$(this),d=a.attr("rel"),k=new PublicKey(f.env.keyservers),h=f.display_message("","loading");k.get(d,
function(k,m){f.hide_message(h);m?f.display_message("keyservererror","error"):b?b(k):f.mailvelope_keyring.importPublicKey(k).then(function(b){"REJECTED"!==b&&(b=d.substr(-8).toUpperCase(),a.closest(".key").fadeOut(),f.display_message(f.get_label("keyimportsuccess").replace("$key",b),"confirmation"))},function(a){console.log(a)})})})};this.mailvelope_identity_keygen=function(){var a=$(this.gui_objects.editform).find(".identity-encryption").first(),b=$.trim($(this.gui_objects.editform).find(".ff_email").val());
a.length&&b&&this.mailvelope_keyring.createKeyGenContainer&&this.mailvelope_keyring.validKeyForAddress([b]).then(function(a){var e=[];if(a&&a[b]&&Array.isArray(a[b].keys)){for(var g=[],k=0;k<a[b].keys.length;k++)g.push(function(a){return f.mailvelope_keyring.hasPrivateKey(a.fingerprint).then(function(b){b&&e.push(a)})}(a[b].keys[k]));return Promise.all(g).then(function(){return e})}return e}).then(function(d){var e=a.find(".identity-encryption-block").empty();if(d&&d.length){$("<p>").text(f.get_label("encryptionprivkeysinmailvelope").replace("$nr",
d.length)).appendTo(e);var g=$("<ul>").addClass("keylist").appendTo(e);$.each(d,function(a,d){$("<li>").appendTo(g).append($("<strong>").addClass("fingerprint").text(String(d.fingerprint).toUpperCase())).append($("<span>").addClass("identity").text("<"+b+"> "))})}else $("<p>").text(f.get_label("encryptionnoprivkeysinmailvelope")).appendTo(e);$("<button>").attr("type","button").addClass("button create").text(f.get_label("encryptioncreatekey")).appendTo(e).on("click",function(){f.mailvelope_show_keygen_container(e,
b)});$("<span>").addClass("space").html("&nbsp;").appendTo(e);$("<button>").attr("type","button").addClass("button settings").text(f.get_label("openmailvelopesettings")).appendTo(e).on("click",function(){f.mailvelope_keyring.openSettings()});a.show();f.triggerEvent("identity-encryption-show",{container:a})}).catch(function(a){console.error("Mailvelope keyring error",a)})};this.mailvelope_show_keygen_container=function(a,b){var d=(new Date).getTime(),e={userIds:[{email:b,fullName:$.trim($(f.gui_objects.editform).find(".ff_name").val())}],
keySize:4096};$("<div>").attr("id","mailvelope-keygen-container-"+d).css({height:"245px",marginBottom:"10px"}).appendTo(a.empty());this.mailvelope_keyring.createKeyGenContainer("#mailvelope-keygen-container-"+d,e).then(function(d){if(d instanceof Error)throw d;$("<button>").attr("type","button").addClass("button mainaction generate").text(f.get_label("generate")).appendTo(a).on("click",function(){var a=$(this).prop("disabled",!0);d.generate().then(function(a){"string"===typeof a&&0<a.indexOf("BEGIN PGP")&&
(f.display_message(f.get_label("keypaircreatesuccess").replace("$identity",b),"confirmation"),f.mailvelope_identity_keygen())}).catch(function(b){debugger;f.display_message(b.message||"errortitle","error");a.prop("disabled",!1)})});$("<span>").addClass("space").html("&nbsp;").appendTo(a);$("<button>").attr("type","button").addClass("button cancel").text(f.get_label("cancel")).appendTo(a).on("click",function(){f.mailvelope_identity_keygen()});f.triggerEvent("identity-encryption-update",{container:a})}).catch(function(a){f.display_message("errortitle",
"error");f.mailvelope_identity_keygen()})};this.expunge_mailbox=function(a){var b,d={_mbox:a};a==this.env.mailbox&&(b=this.set_busy(!0,"loading"),d._reload=1,this.env.search_request&&(d._search=this.env.search_request));this.http_post("expunge",d,b)};this.purge_mailbox=function(a){this.confirm_dialog(this.get_label("purgefolderconfirm"),"delete",function(){var b,d={_mbox:a};a==f.env.mailbox&&(b=f.set_busy(!0,"loading"),d._reload=1);f.http_post("purge",d,b)});return!1};this.purge_mailbox_test=function(){return this.env.exists&&
(this.env.mailbox==this.env.trash_mailbox||this.env.mailbox==this.env.junk_mailbox||this.env.mailbox.startsWith(this.env.trash_mailbox+this.env.delimiter)||this.env.mailbox.startsWith(this.env.junk_mailbox+this.env.delimiter))};this.mark_all_read=function(a,b){var d,e,g=[],k=this.message_list,h=a||this.env.mailbox,l={_uid:"*",_flag:"read",_mbox:h,_folders:b};if("string"!=typeof b){d=this.mark_all_read_state(h);if(!d)return;if(1<d){$.each({cur:1,sub:2,all:4},function(a,b){var e="readallmode"+a,k=$("<label>").attr("for",
e).text(f.get_label("folders-"+a)),e=$("<input>").attr({type:"radio",value:a,name:"mode",id:e,disabled:!(d&b)});g.push($("<li>").append([e,k]))});e=$('<ul class="proplist">').append(g);$("input:not([disabled])",e).first().attr("checked",!0);this.simple_dialog(e,this.get_label("markallread"),function(){f.mark_all_read(h,$("input:checked",e).val());return!0},{button:"mark",button_class:"save"});return}l._folders="cur"}$.each(k?k.rows:[],function(a,d){if(d.unread){var e=f.env.messages[a].mbox;("all"==
b||e==f.env.mailbox||"sub"==b&&e.startsWith(f.env.mailbox+f.env.delimiter))&&f.set_message(a,"unread",!1)}});this.http_post("mark",l,this.display_message("markingmessage","loading"))};this.mark_all_read_state=function(a){var b=0,d=this.treelist.get_item(a||this.env.mailbox);a=$(d).is(".unread")?1:0;var d=$("li.unread",d).length,e=$("li.unread",f.gui_objects.folderlist).length,b=b+a+(d?2:0),b=b+(e>a+d?4:0);this.enable_command("mark-all-read",0<b);return b};this.bounce=function(a,b,d){a=this.get_single_uid();
a=this.url("bounce",{_framed:1,_uid:a,_mbox:this.get_message_mailbox(a)});var e=$("<iframe>").attr("src",a),g=function(){var a=$("iframe",e)[0].contentWindow.rcmail;return{rc:a,form:a.gui_objects.messageform}},k=function(){var a={},b=g();$.each($(b.form).serializeArray(),function(){a[this.name]=this.value});a._uid=b.rc.env.uid;a._mbox=b.rc.env.mailbox;delete a._action;delete a._task;if(a._to||a._cc||a._bcc)f.http_post("bounce",a,f.set_busy(!0,"sendingmessage")),e.dialog("close")};this.hide_menu("forwardmenu",
d);e=this.simple_dialog(e,this.gettext("bouncemsg"),function(){var a=g();return"object"==typeof a.form&&a.rc.check_compose_address_fields(k,a.form)?k():!1},{button:"bounce",width:400,height:300});return!0};this.open_compose_step=function(a){a=this.url("mail/compose",a);this.env.compose_extwin&&!this.env.extwin?this.open_window(a):(this.redirect(a),this.env.extwin&&window.resizeTo(Math.max(this.env.popup_width,$(window).width()),$(window).height()+24))};this.init_messageform=function(){if(!this.gui_objects.messageform)return!1;
var a,b,d=$("[name='_from']"),e=$("[name='_to']"),g=$("[name='_subject']"),f=$("[name='_message']").get(0),h="1"==$("[name='_is_html']").val(),l=this.opener();l&&"compose"==l.env.action&&(setTimeout(function(){1<opener.history.length?opener.history.back():l.redirect(l.get_task_url("mail"))},100),this.env.opened_extwin=!0);h||(f.value&&void 0!==f.defaultValue&&(f.value=f.defaultValue),b=this.env.top_posting&&this.env.compose_mode?0:f.value.length,"select-one"==d.prop("type")&&(this.set_caret_pos(f,
0),this.change_identity(d[0])),this.set_caret_pos(f,b),b&&$(f).scrollTop(f.scrollHeight));this.env.save_localstorage&&this.compose_restore_dialog(0,h);""==e.val()?a=e:""==g.val()?a=g:f&&(a=f);this.env.compose_focus_elem=this.init_messageform_inputs(a);this.compose_field_hash(!0);this.auto_save_start()};this.init_messageform_inputs=function(a){var b,d=$("[name='_to']"),e=["cc","bcc","replyto","followupto"];this.init_address_input_events(d);for(b in e)this.init_address_input_events($("[name='_"+e[b]+
"']"));a||(a=d);return $(a).focus().get(0)};this.compose_restore_dialog=function(a,b){var d,e,g,k=this.local_storage_get_item("compose.index",[]),h=function(a){++a<k.length&&f.compose_restore_dialog(a,b)};for(d=a||0;d<k.length;d++)if(e=k[d],g=this.local_storage_get_item("compose."+e,null,!0)){if(g.changed&&e==this.env.compose_id){this.restore_compose_form(e,b);break}if(!(this.env.draft_id&&g.draft_id&&g.draft_id!=this.env.draft_id||this.env.reply_msgid&&g.reply_msgid!=this.env.reply_msgid)&&g.changed&&
g.session!=this.env.session_id){this.show_popup_dialog(this.get_label("restoresavedcomposedata").replace("$date",(new Date(g.changed)).toLocaleString()).replace("$subject",g._subject).replace(/\n/g,"<br/>"),this.get_label("restoremessage"),[{text:this.get_label("restore"),"class":"mainaction restore",click:function(){f.restore_compose_form(e,b);f.remove_compose_data(e);f.save_compose_form_local();$(this).dialog("close")}},{text:this.get_label("delete"),"class":"delete",click:function(){f.remove_compose_data(e);
$(this).dialog("close");h(d)}},{text:this.get_label("ignore"),"class":"cancel",click:function(){$(this).dialog("close");h(d)}}]);break}}};this.init_address_input_events=function(a,b){!b&&0<this.env.autocomplete_threads&&(b={threads:this.env.autocomplete_threads,sources:this.env.autocomplete_sources});a.keydown(function(a){return f.ksearch_keydown(a,this,b)}).attr({autocomplete:"off","aria-autocomplete":"list","aria-expanded":"false",role:"combobox"});var d=function(a){f.ksearch_pane&&a.target===f.ksearch_pane.get(0)||
f.ksearch_hide()};$(document).on("click",d);document.addEventListener("scroll",d,!0)};this.submit_messageform=function(a,b){var d=this.gui_objects.messageform;if(d){if(!b&&this.env.is_sent)return this.simple_dialog(this.get_label("messageissent"),"",function(){f.submit_messageform(!1,!0);return!0});if(this.mailvelope_editor)return this.mailvelope_submit_messageform(a,b);var e=this.set_busy(!0,a||b?"savingmessage":"sendingmessage"),g=this.spellcheck_lang(),k=[];$("li",this.gui_objects.attachmentlist).each(function(){k.push(this.id.replace(/^rcmfile/,
""))});$('[name="_attachments"]',d).val(k.join());d.target=this.get_save_target();d._draft.value=a?"1":"";d.action=this.add_url(d.action,"_unlock",e);d.action=this.add_url(d.action,"_framed",1);g&&(d.action=this.add_url(d.action,"_lang",g));b&&(d.action=this.add_url(d.action,"_saveonly",1));this.submit_timer=setTimeout(function(){f.set_busy(!1,null,e);f.display_message("requesttimedout","error")},1E3*this.env.request_timeout);d.submit()}};this.compose_recipient_select=function(a){var b,d=0,e=a.get_selection();
for(b=0;b<e.length;b++)a=e[b],this.env.contactdata[a]&&d++;this.enable_command("add-recipient",d)};this.compose_add_recipient=function(a){a||(a=$(this.env.focused_field).filter(":visible"),a=a.length?a.attr("id").replace("_",""):"to");var b=[],d=$("#_"+a),e=this.contact_list.get_selection();if(this.contact_list&&e.length)for(var g,f=0;f<e.length;f++)if((g=e[f])&&this.env.contactdata[g]&&(b.push(this.env.contactdata[g]),"E"==g.charAt(0)&&0>this.env.contactdata[g].indexOf("@")&&d.length)){var h=g.substr(1);
this.group2expand[h]={name:this.env.contactdata[g],input:d.get(0)};this.http_request("group-expand",{_source:this.env.source,_gid:h},!1)}b.length&&d.length&&((e=d.val())&&!/[,;]\s*$/.test(e)&&(e+=", "),d.val(e+b.join(", ")+", ").change(),this.triggerEvent("add-recipient",{field:a,recipients:b}));return b.length};this.check_compose_input=function(a){var b,d=$("[name='_subject']");for(b in this.env.attachments)if("object"===typeof this.env.attachments[b]&&!this.env.attachments[b].complete)return this.alert_dialog(this.get_label("notuploadedwarning")),
!1;if(!this.env.nosubject_warned&&""==d.val()){var e,g=$("<input>").attr({type:"text",size:40});b=$('<div class="prompt">').append($('<p class="message">').text(this.get_label("nosubjectwarning"))).append(g);var k=function(){d.val(g.val());e.dialog("close");f.check_compose_input(a)&&f.command(a,{nocheck:!0})};e=this.show_popup_dialog(b,this.get_label("nosubjecttitle"),[{text:this.get_label("sendmessage"),"class":"mainaction send",click:function(){k()}},{text:this.get_label("cancel"),"class":"cancel",
click:function(){d.focus();e.dialog("close")}}],{dialogClass:"warning"});g.select().keydown(function(a){13==a.which&&k()});this.env.nosubject_warned=!0;return!1}if(!this.mailvelope_editor&&!this.editor.get_content()&&!confirm(this.get_label("nobodywarning")))return this.editor.focus(),!1;if(!this.check_compose_address_fields(a))return!1;this.editor.save();return!0};this.check_compose_address_fields=function(a,b){b||(b=window.document);var d,e,g=this.env.max_disclosed_recipients,k=$("[name='_to']",
b),h=$("[name='_cc']",b),l=$("[name='_bcc']",b),m=$("[name='_from']",b),q=function(a){a=$.map(a,function(a){a=$.trim(a.val());return a.length?a:null});return a.join(",").replace(/^[\s,;]+/,"").replace(/[\s,;]+$/,"")};if("text"==m.prop("type")&&!rcube_check_email(m.val(),!0))return this.alert_dialog(this.get_label("nosenderwarning"),function(){m.focus()}),!1;if(!rcube_check_email(q([k,h,l]),!0))return this.alert_dialog(this.get_label("norecipientwarning"),function(){k.focus()}),!1;if(g&&!this.env.disclosed_recipients_warned&&
rcube_check_email(d=q([k,h]),!0,!0)>g){var p=function(b){b&&(b=l.val(),l.val((b?b+", ":"")+d).change(),k.val("").change(),h.val("").change());e.dialog("close");"function"==typeof a?a():a&&f.command(a,{nocheck:!0})};e=this.show_popup_dialog(this.get_label("disclosedrecipwarning"),this.get_label("disclosedreciptitle"),[{text:this.get_label("sendmessage"),click:function(){p(!1)},"class":"mainaction"},{text:this.get_label("bccinstead"),click:function(){p(!0)}},{text:this.get_label("cancel"),click:function(){e.dialog("close")},
"class":"cancel"}],{dialogClass:"warning"});this.env.disclosed_recipients_warned=!0;return!1}return!0};this.toggle_editor=function(a,b,d){b=this.editor.toggle(a.html,a.noconvert||!1);d=$("#"+this.editor.id).data("control")||$(d?d.target:[]);a=b?a.html?"html":"plain":a.html?"plain":"html";$("[name='_is_html']").val("html"==a?1:0);d.is("[type=checkbox]")?d.prop("checked","html"==a):d.val(a);return b};this.insert_response=function(a){this.editor.replace(this.env.textresponses[a]);this.display_message("responseinserted",
"confirmation")};this.save_response=function(){var a={},b=this.editor.get_content({selection:!0,format:"text",nosig:!0}),d='<form class="propform"><div class="prop block"><label for="ffresponsename">'+this.get_label("responsename")+'</label><input type="text" name="name" id="ffresponsename" size="40" /></div><div class="prop block"><label for="ffresponsetext">'+this.get_label("responsetext")+'</label><textarea name="text" id="ffresponsetext" cols="40" rows="8"></textarea></div></form>';a[this.get_label("save")]=
function(a){a=$("#ffresponsename").val();var b=$("#ffresponsetext").val();if(!b)return $("#ffresponsetext").select(),!1;a||(a=b.replace(/[\r\n]+/g," ").substring(0,40));var d=f.display_message("savingresponse","loading");f.http_post("settings/responses",{_insert:1,_name:a,_text:b},d);$(this).dialog("close")};a[this.get_label("cancel")]=function(){$(this).dialog("close")};this.show_popup_dialog(d,this.get_label("newresponse"),a,{button_classes:["mainaction save","cancel"]});$("#ffresponsetext").val(b);
$("#ffresponsename").select()};this.add_response_item=function(a){var b=a.key;this.env.textresponses[b]=a;if(this.gui_objects.responseslist){var d=$("<li>").appendTo(this.gui_objects.responseslist);$("<a>").addClass("insertresponse active").attr({href:"#",rel:b,tabindex:"0"}).html(this.quote_html(a.name)).appendTo(d).mousedown(function(a){return rcube_event.cancel(a)}).on("mouseup keypress",function(a){if("mouseup"==a.type||13==rcube_event.get_keycode(a))return f.command("insert-response",$(this).attr("rel")),
$(document.body).trigger("mouseup"),rcube_event.cancel(a)})}};this.edit_responses=function(){};this.delete_response=function(a){!a&&this.responses_list&&(a=this.responses_list.get_selection()[0]);a&&this.confirm_dialog(this.get_label("deleteresponseconfirm"),"delete",function(){f.http_post("settings/delete-response",{_key:a},!1)})};this.spellcheck_state=function(){var a=this.editor.spellcheck_state();$.each(this.buttons.spellcheck||[],function(b,d){$("#"+d.id)[a?"addClass":"removeClass"]("selected")});
return a};this.spellcheck_lang=function(){return this.editor.get_language()};this.spellcheck_lang_set=function(a){this.editor.set_language(a)};this.spellcheck_resume=function(a){this.editor.spellcheck_resume(a)};this.set_draft_id=function(a){if(a&&a!=this.env.draft_id){var b={task:"mail",action:""};(b=this.opener(!1,b)||this.opener(!0,b))&&b.env.mailbox==this.env.drafts_mailbox&&b.command("checkmail");this.env.draft_id=a;$("[name='_draft_saveid']").val(a)}this.remove_compose_data(this.env.compose_id);
this.compose_skip_unsavedcheck=!1};this.get_save_target=function(){this.dummy_iframe("savetarget","about:blank").on("load error",function(){$(this).remove()});return"savetarget"};this.auto_save_start=function(){this.env.draft_autosave&&(this.save_timer=setTimeout(function(){f.command("savedraft")},1E3*this.env.draft_autosave));!this.local_save_timer&&window.localStorage&&this.env.save_localstorage&&(this.compose_type_activity=this.compose_type_activity_last=0,$(document).keypress(function(a){f.compose_type_activity++}),
this.local_save_timer=setInterval(function(){f.compose_type_activity>f.compose_type_activity_last&&(f.save_compose_form_local(),f.compose_type_activity_last=f.compose_type_activity)},5E3),$(window).on("unload",function(){f.env.server_error||f.remove_compose_data(f.env.compose_id)}));window.onbeforeunload||(window.onbeforeunload=function(){if(!f.compose_skip_unsavedcheck&&f.cmp_hash!=f.compose_field_hash())return f.get_label("notsentwarning")});this.busy=!1};this.compose_field_hash=function(a){var b,
d,e,g="",f=["to","cc","bcc","subject"];for(b=0;b<f.length;b++)if(e=$('[name="_'+f[b]+'"]').val())g+=e+":";g+=this.editor.get_content({refresh:!1});if(this.env.attachments)for(d in this.env.attachments)g+=d;this.mailvelope_editor&&(g+=";"+(new Date).getTime());a&&(this.cmp_hash=g);return g};this.save_compose_form_local=function(){if(this.env.save_localstorage){var a={session:this.env.session_id,changed:(new Date).getTime()},b=!0;this.editor.save();this.env.draft_id&&(a.draft_id=this.env.draft_id);
this.env.reply_msgid&&(a.reply_msgid=this.env.reply_msgid);$("input, select, textarea",this.gui_objects.messageform).each(function(d,e){switch(e.tagName.toLowerCase()){case "input":if("button"==e.type||"submit"==e.type||"hidden"==e.type&&"_is_html"!=e.name)break;a[e.name]="checkbox"!=e.type||e.checked?$(e).val():"";""!=a[e.name]&&"hidden"!=e.type&&(b=!1);break;case "select":a[e.name]=$("option:checked",e).val();break;default:a[e.name]=$(e).val(),""!=a[e.name]&&(b=!1)}});if(!b){var d=this.local_storage_get_item("compose.index",
[]),e=this.env.compose_id;0>$.inArray(e,d)&&d.push(e);this.local_storage_set_item("compose."+e,a,!0);this.local_storage_set_item("compose.index",d)}}};this.restore_compose_form=function(a,b){var d=this.local_storage_get_item("compose."+a,!0);d&&"object"==typeof d&&($.each(d,function(a,b){if("_"==a[0]){var d=$("[name="+a+"]");d[0]&&"checkbox"==d[0].type?d.prop("checked",""!=b):d.val(b).change()}}),("1"==d._is_html&&!b||"1"!=d._is_html&&b)&&this.command("toggle-editor",{id:this.env.composebody,html:!b,
noconvert:!0}))};this.remove_compose_data=function(a){var b=this.local_storage_get_item("compose.index",[]);0<=$.inArray(a,b)&&(this.local_storage_remove_item("compose."+a),this.local_storage_set_item("compose.index",$.grep(b,function(b,e){return b!=a})))};this.clear_compose_data=function(){var a,b=this.local_storage_get_item("compose.index",[]);for(a=0;a<b.length;a++)this.local_storage_remove_item("compose."+b[a]);this.local_storage_remove_item("compose.index")};this.change_identity=function(a,b){if(!a||
!a.options)return!1;var d=$(a).val(),e=this.env.signatures&&this.env.signatures[d],g=this.env.identity,k=b?b:this.env.show_sig;e?(this.enable_command("insert-sig",!0),this.env.compose_commands.push("insert-sig"),e=!0):this.enable_command("insert-sig",!1);if(!this.env.identities_initialized&&(this.env.identities_initialized=!0,this.env.show_sig_later&&(this.env.show_sig=!0),this.env.opened_extwin))return;$.each(["replyto","bcc"],function(){var a,b=g&&f.env.identities[g]?f.env.identities[g][this]:"",
e=d&&f.env.identities[d]?f.env.identities[d][this]:"",k=$('[name="_'+this+'"]'),p=k.val();b&&p&&(a=RegExp("\\s*"+RegExp.escape(b)+"\\s*"),p=p.replace(a,""));p=String(p).replace(/[,;]\s*[,;]/g,",").replace(/^[\s,;]+/,"");e&&-1==p.indexOf(e)&&-1==p.indexOf(e.replace(/"/g,""))&&(p&&(p=p.replace(/[,;\s]+$/,"")+", "),p+=e+", ");(b||e)&&k.val(p).change()});this.editor&&this.editor.change_signature(d,k);b&&e&&this.display_message("siginserted","confirmation");this.env.identity=d;this.triggerEvent("change_identity");
return!0};this.upload_input=function(a){$("#"+a+' input[type="file"]').click()};this.upload_file=function(a,b,d){if(a){var e,g=[];$("input",a).each(function(){if(this.files){e=this.name;for(var a=0;a<this.files.length;a++)g.push(this.files[a])}});return this.file_upload(g,{_id:this.env.compose_id||""},{name:e,action:b,lock:d})}};this.add2attachment_list=function(a,b,d){d&&this.triggerEvent("fileuploaded",{name:a,attachment:b,id:d});this.env.attachments||(this.env.attachments={});d&&this.env.attachments[d]&&
delete this.env.attachments[d];this.env.attachments[a]=b;if(!this.gui_objects.attachmentlist)return!1;var e,g,f=$("<li>");!b.complete&&0>b.html.indexOf("<")&&(b.html='<span class="uploading">'+b.html+"</span>");!b.complete&&this.env.loadingicon&&(b.html='<img src="'+this.env.loadingicon+'" alt="" class="uploading" />'+b.html);b.complete||(e=this.get_label("cancel"),b.html='<a title="'+e+'" onclick="return rcmail.cancel_attachment_upload(\''+a+'\');" href="#cancelupload" class="cancelupload">'+(this.env.cancelicon?
'<img src="'+this.env.cancelicon+'" alt="'+e+'" />':'<span class="inner">'+e+"</span>")+"</a>"+b.html);f.attr("id",a).addClass(b.classname).html(b.html).find(".attachment-name").on("mouseover",function(){rcube_webmail.long_subject_title_ex(this)});d&&(g=document.getElementById(d))?f.replaceAll(g):f.appendTo(this.gui_objects.attachmentlist);e=$(this.gui_objects.attachmentlist).attr("data-tabindex")||"0";f.find("a").attr("tabindex",e);this.triggerEvent("fileappended",{name:a,attachment:b,id:d,item:f});
return!0};this.remove_from_attachment_list=function(a){this.env.attachments&&(delete this.env.attachments[a],$("#"+a).remove())};this.remove_attachment=function(a){a&&this.env.attachments[a]&&this.http_post("remove-attachment",{_id:this.env.compose_id,_file:a});return!1};this.cancel_attachment_upload=function(a){if(!a||!this.uploads[a])return!1;this.remove_from_attachment_list(a);this.uploads[a].abort();return!1};this.rename_attachment=function(a){var b=this.env.attachments?this.env.attachments[a]:
null;if(b){var d=$("<input>").attr({type:"text",size:50}).val(b.name),e=$("<label>").text(this.get_label("namex")).append(d);this.simple_dialog(e,"attachmentrename",function(){var e;if((e=d.val())&&e!=b.name)return f.http_post("rename-attachment",{_id:f.env.compose_id,_file:a,_name:e},f.set_busy(!0,"loading")),!0})}};this.rename_attachment_handler=function(a,b){var d=this.env.attachments?this.env.attachments[a]:null;d&&b&&(d.name=b,$("#"+a+" .attachment-name").text(b).attr("title",""))};this.add_contact=
function(a,b){a&&this.http_post("addcontact",{_address:a,_reload:b})};this.qsearch=function(a){if(""!=a||$(this.gui_objects.qsearchbox).val()||$(this.gui_objects.search_interval).val()){var b=this.set_busy(!0,"searching");a=this.search_params(a);var d="compose"==this.env.action&&this.contact_list?"search-contacts":"search";this.message_list?this.clear_message_list():this.contact_list&&this.list_contacts_clear();this.env.source&&(a._source=this.env.source);this.env.group&&(a._gid=this.env.group);this.env.current_page=
1;a=this.http_request(d,a,b);this.env.qsearch={lock:b,request:a};this.enable_command("set-listmode",this.env.threads&&"base"==(this.env.search_scope||"base"));return!0}return!1};this.continue_search=function(a){var b=this.set_busy(!0,"stillsearching");setTimeout(function(){var d=f.search_params();d._continue=a;f.env.qsearch={lock:b,request:f.http_request("search",d,b)}},100)};this.search_params=function(a,b){var d,e={},g=[],f=this.env.search_mods,h=this.env.search_scope||"base",l="all"==h?"*":this.env.mailbox;
!b&&this.gui_objects.search_filter&&(b=this.gui_objects.search_filter.value);!a&&this.gui_objects.qsearchbox&&(a=this.gui_objects.qsearchbox.value);this.gui_objects.search_interval&&(e._interval=$(this.gui_objects.search_interval).val());if(a&&(e._q=a,f&&this.message_list&&(f=f[l]||f["*"]),f)){for(d in f)g.push(d);e._headers=g.join(",")}e._layout=this.env.layout;e._filter=b;e._scope=h;l&&"all"!=h&&(e._mbox=l);return e};this.reset_search_filter=function(){this.filter_disabled=!0;this.gui_objects.search_filter&&
$(this.gui_objects.search_filter).val("ALL").change();this.filter_disabled=!1};this.reset_qsearch=function(a){this.gui_objects.qsearchbox&&(this.gui_objects.qsearchbox.value="");this.gui_objects.search_interval&&$(this.gui_objects.search_interval).val("");this.env.qsearch&&this.abort_request(this.env.qsearch);a&&(this.env.search_scope="base",this.reset_search_filter());this.env.qsearch=null;this.env.search_request=null;this.env.search_id=null;this.select_all_mode=!1;this.enable_command("set-listmode",
this.env.threads)};this.set_searchscope=function(a){var b=this.env.search_scope;this.env.search_scope=a;a!=b&&this.env.search_request&&(!this.qsearch(this.gui_objects.qsearchbox.value)&&this.env.search_filter&&"ALL"!=this.env.search_filter&&this.filter_mailbox(this.env.search_filter),"all"!=a&&this.select_folder(this.env.mailbox,"",!0))};this.set_searchinterval=function(a){var b=this.env.search_interval;this.env.search_interval=a;a!=b&&this.env.search_request&&(!this.qsearch(this.gui_objects.qsearchbox.value)&&
this.env.search_filter&&"ALL"!=this.env.search_filter&&this.filter_mailbox(this.env.search_filter),a&&this.select_folder(this.env.mailbox,"",!0))};this.set_searchmods=function(a){var b=this.env.mailbox;"all"==(this.env.search_scope||"base")&&(b="*");this.env.search_mods||(this.env.search_mods={});b&&(this.env.search_mods[b]=a)};this.is_multifolder_listing=function(){return void 0!==this.env.multifolder_listing?this.env.multifolder_listing:this.env.search_request&&"base"!=(this.env.search_scope||"base")};
this.sent_successfully=function(a,b,d,e){this.display_message(b,a);this.compose_skip_unsavedcheck=!0;if(this.env.extwin){e||this.lock_form(this.gui_objects.messageform);var g={task:"mail",action:""};if(g=this.opener(!1,g)||this.opener(!0,g))g.display_message(b,a),d&&0<=$.inArray(g.env.mailbox,d)&&g.command("checkmail");e||setTimeout(function(){window.close()},1E3)}else e||setTimeout(function(){f.list_mailbox()},500);e&&(this.env.is_sent=!0)};this.image_rotate=function(){var a=this.image_style?this.image_style.rotate||
0:0;this.image_style.rotate=180<a?0:a+90;this.apply_image_style()};this.image_scale=function(a){this.image_style.scale=Math.max(0.1,(this.image_style?this.image_style.scale||1:1)+0.1*("-"==a?-1:1));this.apply_image_style()};this.apply_image_style=function(){var a=[],b=$(this.gui_objects.messagepartframe).contents().find("head");$("#image-style",b).remove();$.each({scale:"",rotate:"deg"},function(b,e){var g=f.image_style[b];g&&a.push(b+"("+g+e+")")});a&&b.append($('<style id="image-style">').text("img { transform: "+
a.join(" ")+"}"))};this.import_state_set=function(a){this.import_dialog&&(this.import_state=a,$(this.import_dialog).parent().find(".ui-dialog-buttonset > button").first().attr("disabled","error"!=a))};this.ksearch_keydown=function(a,b,d){this.ksearch_timer&&clearTimeout(this.ksearch_timer);var e=rcube_event.get_keycode(a);switch(e){case 38:case 40:if(!this.ksearch_visible())return;b=38==e?1:0;e=this.ksearch_pane.find("li.selected")[0];e||(e=this.ksearch_pane.__ul.firstChild);e&&this.ksearch_select(b?
e.previousSibling:e.nextSibling);return rcube_event.cancel(a);case 9:if(rcube_event.get_modifier(a)==SHIFT_KEY||!this.ksearch_visible()){this.ksearch_hide();return}case 13:if(!this.ksearch_visible())return!1;this.insert_recipient(this.ksearch_selected);this.ksearch_hide();return 9==e?null:rcube_event.cancel(a);case 27:this.ksearch_hide();return;case 37:case 39:return}this.ksearch_timer=setTimeout(function(){f.ksearch_get_results(d)},200);this.ksearch_input=b;return!0};this.ksearch_visible=function(){return null!==
this.ksearch_selected&&void 0!==this.ksearch_selected&&this.ksearch_value};this.ksearch_select=function(a){this.ksearch_pane&&a&&this.ksearch_pane.find("li.selected").removeClass("selected").removeAttr("aria-selected");a&&($(a).addClass("selected").attr("aria-selected","true"),this.ksearch_selected=a._rcm_id,$(this.ksearch_input).attr("aria-activedescendant","rcmkSearchItem"+this.ksearch_selected))};this.insert_recipient=function(a){if(null!==a&&this.env.contacts[a]&&this.ksearch_input){var b=!1,
d="";a=this.env.contacts[a];this.ksearch_destroy();"object"===typeof a&&"group"==a.type&&!a.email&&a.id?(d=a.name+", ",this.group2expand[a.id]=$.extend({input:this.ksearch_input},a),this.http_request("mail/group-expand",{_source:a.source,_gid:a.id},!1)):"object"===typeof a&&a.name?(d=a.name+", ",b=!0):"string"===typeof a&&(d=a+", ",b=!0);this.ksearch_input_replace(this.ksearch_value,d);b&&(this.triggerEvent("autocomplete_insert",{field:this.ksearch_input,insert:d,data:a,search:this.ksearch_value_last,
result_type:"person"}),this.ksearch_value_last=null,this.compose_type_activity++)}};this.replace_group_recipients=function(a,b){this.group2expand[a]&&(this.ksearch_input_replace(this.group2expand[a].name,b,this.group2expand[a].input),this.triggerEvent("autocomplete_insert",{field:this.group2expand[a].input,insert:b,data:this.group2expand[a],search:this.ksearch_value_last,result_type:"group"}),this.ksearch_value_last=null,this.group2expand[a]=null,this.compose_type_activity++)};this.ksearch_get_results=
function(a){this.ksearch_pane&&this.ksearch_pane.is(":visible")&&this.ksearch_pane.hide();var b=this.ksearch_input_get(),d=this.env.autocomplete_min_length,e=this.ksearch_data,b=$.trim(b);b!=this.ksearch_value&&(this.ksearch_destroy(),b.length&&b.length<d?this.ksearch_info||(this.ksearch_info=this.display_message(this.get_label("autocompletechars").replace("$min",d))):(d=this.ksearch_value,this.ksearch_value_last=this.ksearch_value=b,!b.length||d&&d.length&&b.startsWith(d)&&(!e||0>=e.num)&&this.env.contacts&&
!this.env.contacts.length||(e=a&&a.sources?a.sources:[""],this.ksearch_data={id:this.multi_thread_http_request({items:e,threads:a&&a.threads?a.threads:1,action:a&&a.action?a.action:"mail/autocomplete",postdata:{_search:b,_source:"%s"},lock:this.display_message("searching","loading")}),sources:e.slice(),num:e.length})))};this.ksearch_query_results=function(a,b,d){this.multi_thread_http_response(a,d);if(this.ksearch_value&&(!this.ksearch_input||b==this.ksearch_value)){var e,g,k,h,l;g=this.is_framed();
var m=this.ksearch_value,q=this.env.autocomplete_max?this.env.autocomplete_max:15;this.ksearch_pane||(b=$("<ul>"),this.ksearch_pane=$("<div>").attr({id:"rcmKSearchpane",role:"listbox","class":"select-menu inline"}).css({position:"absolute","z-index":3E4}).append(b).appendTo(g?parent.document.body:document.body),this.ksearch_pane.__ul=b[0],this.triggerEvent("autocomplete_create",{obj:this.ksearch_pane}));b=this.ksearch_pane.__ul;if(d&&this.ksearch_pane.data("reqid")==d)q-=b.childNodes.length;else{this.ksearch_pane.data("reqid",
d);b.innerHTML="";this.env.contacts=[];l=(e=$("html").is(".layout-small,.layout-phone")&&1==$(this.ksearch_input).parents(".ac-input").length)?$(this.ksearch_input).parents(".ac-input")[0]:$(this.ksearch_input)[0];var p=$(l).offset();p.left-=$(document.documentElement).scrollLeft();p.top-=$(document.documentElement).scrollTop();if(g)try{parent.$("iframe").each(function(){if(this.contentWindow==window){var a=$(this).offset();p.left+=a.left;p.top+=a.top}})}catch(s){}var t=$(g?parent:window).width();
g=$(l).outerWidth();h=200<t-p.left?p.left:t-200;l=p.top+l.offsetHeight+1;t=Math.min(400,t-h);this.ksearch_pane.css({left:(e?p.left:h)+"px",top:l+"px",maxWidth:(e?g:t)+"px",minWidth:"200px",width:e?g+"px":"auto",display:"none"})}if(a&&(k=a.length))for(e=0;e<k&&0<q;e++)h="object"===typeof a[e]?a[e].display||a[e].name:a[e],l="object"===typeof a[e]?a[e].type:"",g=e+this.env.contacts.length,$("<li>").attr({id:"rcmkSearchItem"+g,role:"option"}).html('<i class="icon"></i>'+this.quote_html(h.replace(RegExp("("+
RegExp.escape(m)+")","ig"),"##$1%%")).replace(/##([^%]+)%%/g,"<b>$1</b>")).addClass(l||"").appendTo(b).mouseover(function(){f.ksearch_select(this)}).mouseup(function(){f.ksearch_click(this)}).get(0)._rcm_id=g,q-=1;b.childNodes.length&&($(this.ksearch_input).attr({"aria-haspopup":"true","aria-expanded":"true","aria-owns":"rcmKSearchpane"}),this.ksearch_pane.show(),this.env.contacts.length||this.ksearch_select($("li",b)[0]));k&&(this.env.contacts=this.env.contacts.concat(a));this.ksearch_data.id==d&&
this.ksearch_data.num--}};this.ksearch_input_get=function(){if(!this.ksearch_input)return"";var a=this.get_caret_pos(this.ksearch_input);return this.ksearch_input.value.substr(0,a).split(/[,;]/).pop()};this.ksearch_input_replace=function(a,b,d){if(this.ksearch_input||d){d||(d=this.ksearch_input);var e=this.get_caret_pos(d),g=d.value.lastIndexOf(a,e),f=d.value.substring(0,g),g=d.value.substring(g+a.length,d.value.length);d.value=f+b+g;this.set_caret_pos(d,e+b.length-a.length);$(d).trigger("change",
[!0])}};this.ksearch_click=function(a){this.ksearch_input&&this.ksearch_input.focus();this.insert_recipient(a._rcm_id);this.ksearch_hide()};this.ksearch_blur=function(){this.ksearch_timer&&clearTimeout(this.ksearch_timer);this.ksearch_input=null;this.ksearch_hide()};this.ksearch_hide=function(){this.ksearch_selected=null;this.ksearch_value="";this.ksearch_pane&&this.ksearch_pane.hide();$(this.ksearch_input).attr({"aria-haspopup":"false","aria-expanded":"false"}).removeAttr("aria-activedescendant").removeAttr("aria-owns");
this.ksearch_destroy()};this.ksearch_destroy=function(){this.ksearch_data&&this.multi_thread_request_abort(this.ksearch_data.id);this.ksearch_info&&this.hide_message(this.ksearch_info);this.ksearch_msg&&this.hide_message(this.ksearch_msg);this.ksearch_msg=this.ksearch_info=this.ksearch_data=null};this.contactlist_select=function(a){this.preview_timer&&clearTimeout(this.preview_timer);var b,d,e=0,g=!1;d=!1;var k=a.get_selection().length,h=this.env.source?this.env.address_sources[this.env.source]:null;
this.env.contentframe&&!a.multi_selecting&&(b=a.get_single_selection())?this.preview_timer=setTimeout(function(){f.load_contact(b,"show")},this.preview_delay_click):this.env.contentframe&&this.show_contentframe(!1);k&&(a.draggable=!1,this.env.selection_sources=[],h&&this.env.selection_sources.push(this.env.source),$.each(a.get_selection(),function(b,d){var e,k=a.data[d];h?g=g||!h.readonly&&!k.readonly:(e=String(d).replace(/^[^-]+-/,""))&&f.env.address_sources[e]&&(g=g||!f.env.address_sources[e].readonly&&
!k.readonly,f.env.selection_sources.push(e));"group"!=k._type&&(a.draggable=!0)}),this.env.selection_sources=$.unique(this.env.selection_sources),h&&h.groups&&$.each(this.env.contactgroups,function(){this.source===f.env.source&&e++}),d=$.map(this.env.address_sources,function(a,b){return a.readonly?null:b}),d=0<$.grep(d,function(a){return 0>jQuery.inArray(a,f.env.selection_sources)}).length);this.enable_command("group-assign-selected",0<e&&g);this.enable_command("group-remove-selected",this.env.group&&
g);this.enable_command("print","qrcode",1==k);this.enable_command("export-selected",0<k);this.enable_command("edit",b&&g);this.enable_command("delete","move",g);this.enable_command("copy",d);return!1};this.list_contacts=function(a,b,d,e){var g,k=-1,h={},l=void 0===a&&void 0===b&&void 0===d,m=window;a||(a=this.env.source);l&&(b=this.env.group);a!=this.env.source?(d=this.env.current_page=1,this.reset_qsearch()):l||b==this.env.group||(d=this.env.current_page=1);this.env.search_id?g="S"+this.env.search_id:
this.env.search_request||(g=b?"G"+a+b:a);this.env.source=a;this.env.group=b;$.each(this.env.address_group_stack,function(a,b){if(f.env.group==b.id)return k=a,!1});this.env.address_group_stack=0>k?[]:this.env.address_group_stack.slice(0,k);this.destroy_entity_selector("contactgroup-selector");this.env.group?(e||(e={}),e.id=this.env.group,this.env.address_group_stack.push(e),g="G"+a+this.env.address_group_stack[0].id):this.gui_objects.addresslist_title&&$(this.gui_objects.addresslist_title).text(this.get_label("contacts"));
this.env.search_id||this.select_folder(g,"",!0);if(this.gui_objects.contactslist)this.list_contacts_remote(a,b,d);else{if(e=this.get_frame_window(this.env.contentframe))m=e,h._framed=1;b&&(h._gid=b);d&&(h._page=d);a&&(h._source=a);this.env.search_request&&(h._search=this.env.search_request);this.set_busy(!0,"loading");this.location_href(h,m)}};this.list_contacts_remote=function(a,b,d){this.list_contacts_clear();var e={},g=this.set_busy(!0,"loading");a&&(e._source=a);d&&(e._page=d);b&&(e._gid=b);this.env.source=
a;this.env.group=b;this.env.search_request&&(e._search=this.env.search_request);this.http_request("mail"==this.env.task?"list-contacts":"list",e,g);"mail"!=this.env.task&&this.update_state({_source:a,_page:d&&1<d?d:null,_gid:b})};this.list_contacts_clear=function(){this.contact_list.data={};this.contact_list.clear(!0);this.show_contentframe(!1);this.enable_command("delete","move","copy","print",!1)};this.set_group_prop=function(a){if(this.gui_objects.addresslist_title){var b=$(this.gui_objects.addresslist_title).html("");
if(1<this.env.address_group_stack.length||1==this.env.address_group_stack.length&&this.env.address_group_stack[0].search_request)$('<a href="#list">...</a>').attr("title",this.get_label("uponelevel")).addClass("poplink").appendTo(b).click(function(a){return f.command("popgroup","",this)}),b.append("&nbsp;&raquo;&nbsp;");b.append($("<span>").text(a?a.name:this.get_label("contacts")))}};this.load_contact=function(a,b,d){var e,g={},f=window,h=this.contact_list?this.contact_list.data[a]:null;if(e=this.get_frame_window(this.env.contentframe))g._framed=
1,f=e,this.show_contentframe(!0),a||this.contact_list.clear_selection(),this.enable_command("export-selected","print",h&&"group"!=h._type);else if(d)return!1;!b||!a&&"add"!=b||this.drag_active||(this.env.group&&(g._gid=this.env.group),this.env.search_request&&(g._search=this.env.search_request),a&&(g._cid=this.preview_id=a),g._action=b,g._source=this.env.source,this.location_href(g,f,!0));return!0};this.group_member_change=function(a,b,d,e){"add"!=a&&(a="del");var g=this.display_message("add"==a?
"addingmember":"removingmember","loading");this.http_post("group-"+a+"members",{_cid:b,_source:d,_gid:e},g)};this.contacts_drag_menu=function(a,b){var d="group"==b.type?b.source:b.id,e=this.env.source;if(!this.env.address_sources[d]||this.env.address_sources[d].readonly)return!0;""==e&&1==this.env.selection_sources.length&&(e=this.env.selection_sources[0]);return"group"==b.type&&d==e?(e=this.contact_list.get_selection().join(","),this.group_member_change("add",e,d,b.id),!0):this.commands.move||rcube_event.get_modifier(a)==
SHIFT_KEY?this.drag_menu(a,b):(this.copy_contacts(b),!0)};this.copy_contacts=function(a,b,d){if(!a)return d=this.contact_list.get_selection(),this.addressbook_selector(b,function(a,b){a=$(b).data("source")?f.env.contactgroups["G"+$(b).data("source")+$(b).data("gid")]:f.env.address_sources[a];f.copy_contacts(a,null,d)});b="group"==a.type?a.source:a.id;var e=this.env.source,g=this.env.group?this.env.group:"";(d=d?d.join(","):this.contact_list.get_selection().join(","))&&this.env.address_sources[b]&&
!this.env.address_sources[b].readonly&&(""==e&&1==this.env.selection_sources.length&&(e=this.env.selection_sources[0]),"group"==a.type?b!=e&&(e=this.display_message("copyingcontact","loading"),a={_cid:d,_source:this.env.source,_to:b,_togid:a.id,_gid:g},this.http_post("copy",a,e)):a.id!=e&&(e=this.display_message("copyingcontact","loading"),a={_cid:d,_source:this.env.source,_to:a.id,_gid:g},this.http_post("copy",a,e)))};this.move_contacts=function(a,b,d){if(!a)return d=this.contact_list.get_selection(),
this.addressbook_selector(b,function(a,b){a=$(b).data("source")?f.env.contactgroups["G"+$(b).data("source")+$(b).data("gid")]:f.env.address_sources[a];f.move_contacts(a,null,d)});b="group"==a.type?a.source:a.id;var e=this.env.source;this.env.address_sources[b]&&!this.env.address_sources[b].readonly&&(""==e&&1==this.env.selection_sources.length&&(e=this.env.selection_sources[0]),"group"==a.type?b!=e&&this._with_selected_contacts("move",{_to:b,_togid:a.id,_cid:d}):a.id!=e&&this._with_selected_contacts("move",
{_to:a.id,_cid:d}))};this.delete_contacts=function(){if(this.env.source&&this.env.address_sources[this.env.source].undelete)this._with_selected_contacts("delete",{_cid:this.contact_list.get_selection()});else{var a=this.contact_list.get_selection();this.confirm_dialog(this.get_label("deletecontactconfirm"),"delete",function(){f._with_selected_contacts("delete",{_cid:a})})}};this._with_selected_contacts=function(a,b){var d=b._cid;if(d.length||this.env.cid){var e,g=[],f=this.display_message("delete"==
a?"contactdeleting":"movingcontact","loading"),h=this.check_display_next();if(this.env.cid)g.push(this.env.cid);else{for(e=0;e<d.length;e++)id=d[e],g.push(id),this.contact_list.remove_row(id,h&&e==d.length-1);h||this.contact_list.clear_selection()}b||(b={});b._source=this.env.source;b._from=this.env.action;b._cid=g.join(",");this.env.group&&(b._gid=this.env.group);this.env.search_request&&(b._search=this.env.search_request);this.http_post(a,b,f);return!0}};this.update_contact_row=function(a,b,d,e,
g){var f=this.contact_list;a=this.html_identifier(a);f.rows[a]||(a=a+"-"+e,d&&(d=d+"-"+e));f.update_row(a,b,d,!0);f.data[a]=g};this.add_contact_row=function(a,b,d,e){if(!this.gui_objects.contactslist)return!1;var g,f=this.contact_list,h={cols:[]};h.id="rcmrow"+this.html_identifier(a);h.className="contact "+(d||"");f.in_selection(a)&&(h.className+=" selected");for(g in b)d={},d.className=String(g).toLowerCase(),d.innerHTML=b[g],h.cols.push(d);f.data[a]=e;f.insert_row(h);this.enable_command("export",
0<f.rowcount)};this.init_contact_form=function(){var a;if(this.env.coltypes)for(a in this.set_photo_actions($("#ff_photo").val()),this.env.coltypes)this.init_edit_field(a,null);$(".contactfieldgroup .row a.deletebutton").click(function(){f.delete_edit_field(this);return!1});$("select.addfieldmenu").change(function(){f.insert_edit_field($(this).val(),$(this).attr("rel"),this);this.selectedIndex=0});$.datepicker&&this.env.date_format&&($.datepicker.setDefaults({dateFormat:this.env.date_format,changeMonth:!0,
changeYear:!0,yearRange:"-120:+10",showOtherMonths:!0,selectOtherMonths:!0}),$("input.datepicker").datepicker());"search"==this.env.action&&$(this.gui_objects.editform).append($('<input type="submit">').hide()).submit(function(){$("input.mainaction").click();return!1})};this.group_create=function(){var a=$("<input>").attr("type","text"),b=$("<label>").text(this.get_label("namex")).append(a),d=this.env.source;this.simple_dialog(b,"newgroup",function(){var b;if(b=a.val())return f.http_post("group-create",
{_source:d,_name:b},f.set_busy(!0,"loading")),!0})};this.group_rename=function(){if(this.env.group){var a=this.env.contactgroups["G"+this.env.source+this.env.group].name,b=$("<input>").attr("type","text").val(a),d=$("<label>").text(this.get_label("namex")).append(b),e=this.env.source,g=this.env.group;this.simple_dialog(d,"grouprename",function(){var d;if((d=b.val())&&d!=a)return f.http_post("group-rename",{_source:e,_gid:g,_name:d},f.set_busy(!0,"loading")),!0})}};this.group_delete=function(){if(this.env.group){var a=
this.env.group;this.confirm_dialog(this.get_label("deletegroupconfirm"),"delete",function(){var b=f.set_busy(!0,"groupdeleting");f.http_post("group-delete",{_source:f.env.source,_gid:a},b)})}};this.remove_group_item=function(a){var b="G"+a.source+a.id;this.treelist.remove(b)&&(this.destroy_entity_selector("addressbook-selector"),this.destroy_entity_selector("contactgroup-selector"),this.triggerEvent("group_delete",{source:a.source,id:a.id}),delete this.env.contactfolders[b],delete this.env.contactgroups[b]);
a.source==this.env.source&&a.id==this.env.group&&this.list_contacts(a.source,0)};this.group_assign_selected=function(a,b,d){var e=f.contact_list.get_selection(),g=f.env.source;this.contactgroup_selector(d,function(a){f.group_member_change("add",e,g,a)})};this.group_remove_selected=function(){this.http_post("group-delmembers",{_cid:this.contact_list.get_selection(),_source:this.env.source,_gid:this.env.group})};this.remove_group_contacts=function(a){if(void 0!==this.env.group&&this.env.group===a.gid){var b=
this.contact_list.get_selection(),d=this.check_display_next();for(a=0;a<b.length;a++)id=b[a],this.contact_list.remove_row(id,d&&a==b.length-1);d||this.contact_list.clear_selection()}};this.insert_contact_group=function(a){a.type="group";var b="G"+a.source+a.id,d=$("<a>").attr({href:"#",rel:a.source+":"+a.id}).click(function(){return f.command("listgroup",a,this)}).text(a.name);this.env.contactfolders[b]=this.env.contactgroups[b]=a;this.treelist.insert({id:b,html:d,classes:["contactgroup"]},a.source,
"contactgroup");this.destroy_entity_selector("addressbook-selector");this.destroy_entity_selector("contactgroup-selector");this.triggerEvent("group_insert",{id:a.id,source:a.source,name:a.name,li:this.treelist.get_item(b)})};this.update_contact_group=function(a){var b="G"+a.source+a.id,d={};if(a.newid){var e="G"+a.source+a.newid,g=$.extend({},a);this.env.contactfolders[e]=this.env.contactfolders[b];this.env.contactfolders[e].id=a.newid;this.env.group=a.newid;delete this.env.contactfolders[b];delete this.env.contactgroups[b];
g.id=a.newid;g.type="group";d.id=e;d.html=$("<a>").attr({href:"#",rel:a.source+":"+a.newid}).click(function(){return f.command("listgroup",g,this)}).text(a.name)}else $(this.treelist.get_item(b)).children().first().text(a.name),this.env.contactfolders[b].name=this.env.contactgroups[b].name=a.name,a.source==this.env.source&&a.id==this.env.group&&this.set_group_prop(a);this.treelist.update(b,d,!0);this.destroy_entity_selector("addressbook-selector");this.destroy_entity_selector("contactgroup-selector");
this.triggerEvent("group_update",{id:a.id,source:a.source,name:a.name,li:this.treelist.get_item(b),newid:a.newid})};this.update_group_commands=function(){var a=""!=this.env.source?this.env.address_sources[this.env.source]:null,a=a&&a.groups&&!a.readonly;this.enable_command("group-create",a);this.enable_command("group-rename","group-delete",a&&this.env.group)};this.init_edit_field=function(a,b){var d=this.env.coltypes[a].label;b||(b=$(".ff_"+a));d&&!$('label[for="ff_'+a+'"]').length&&b.placeholder(d)};
this.insert_edit_field=function(a,b,d){var e=$("#ff_"+a);if(e.length)$('label[for="ff_'+a+'"]').parent().show(),e.show().focus(),$(d).children('option[value="'+a+'"]').prop("disabled",!0);else{$(".ff_"+a);e=$("#contactsection"+b+" .contactcontroller"+a);if(!e.length){b=$("#contactsection"+b);var g=$(".contactfieldgroup",b).last(),e=$("<fieldset>").addClass("contactfieldgroup contactcontroller"+a);g.length?e.insertAfter(g):b.prepend(e)}if("FIELDSET"==e.get(0).nodeName){var k,g=this.env.coltypes[a],
h=1!=g.limit?"[]":"",l=$(d).data("compact")?!0:!1,m="ff_"+a+(g.count||0),q=$("<div>").addClass("row input-group"),p=$("<div>").addClass("contactfieldcontent "+g.type);g.subtypes_select?(b=$(g.subtypes_select),l?b.addClass("input-group-prepend"):b=$("<div>").addClass("contactfieldlabel label").append(b)):(b=$("<label>").addClass("contactfieldlabel label input-group-text").attr("for",m).text(g.label),l&&(b=$('<span class="input-group-prepend">').append(b)));if("text"==g.type||"date"==g.type)k=$("<input>").addClass("form-control ff_"+
a).attr({type:"text",name:"_"+a+h,size:g.size,id:m}),this.init_edit_field(a,k),"date"==g.type&&$.datepicker&&k.addClass("datepicker").datepicker();else if("textarea"==g.type)k=$("<textarea>").addClass("form-control ff_"+a).attr({name:"_"+a+h,cols:g.size,rows:g.rows,id:m}),this.init_edit_field(a,k);else if("composite"==g.type){var s,t,u=[],w=[],v=p;q.addClass("composite");l&&(v=$('<div class="content input-group-text">'));if(k=this.env[a+"_template"])for(m=0;m<k.length;m++)u.push(k[m][1]),w.push(k[m][2]);
else for(s in g.childs)u.push(s);for(m=0;m<u.length;m++)s=u[m],k=g.childs[s],k=$("<input>").addClass("form-control ff_"+s).attr({type:"text",name:"_"+s+h,size:k.size}).appendTo(v),l||v.append(w[m]||" "),this.init_edit_field(s,k),t||(t=k);k=l?v:t}else if("select"==g.type){k=$("<select>").addClass("custom-select ff_"+a).attr({name:"_"+a+h,id:m});var x=k.attr("options");x[x.length]=new Option("---","");g.options&&$.each(g.options,function(a,b){x[x.length]=new Option(b,a)})}k&&(s=$('<a href="#del"></a>').addClass("contactfieldbutton deletebutton input-group-text icon delete").attr({title:this.get_label("delete"),
rel:a}).html(this.env.delbutton).click(function(){f.delete_edit_field(this);return!1}),q.append(b),l?(q.append(k).append(s),s.wrap('<span class="input-group-append">')):("composite"!=g.type&&p.append(k),q.append(p.append(s))),q.appendTo(e.show()),k.is("div")?k.find("input").first().focus():k.first().focus(),g.count||(g.count=0),++g.count==g.limit&&g.limit&&$(d).children('option[value="'+a+'"]').prop("disabled",!0),this.triggerEvent("insert-edit-field",k))}}};this.delete_edit_field=function(a){var b=
$(a).attr("rel"),d=this.env.coltypes[b],e=$(a).parents("div.row"),g=$(a).parents("fieldset.contactfieldgroup");a=g.parent().find("select.addfieldmenu");0>=--d.count&&d.visible?e.find("input").val("").blur():(e.remove(),g.children("div.row").length||g.hide());a.length&&(e=a.children('option[value="'+b+'"]'),e.length?e.prop("disabled",!1):$("<option>").attr("value",b).html(d.label).appendTo(a),a.show())};this.upload_contact_photo=function(a){a&&a.elements._photo.value&&(this.async_upload_form(a,"upload-photo",
function(a){f.set_busy(!1,null,f.file_upload_id)}),this.file_upload_id=this.set_busy(!0,"uploading"))};this.replace_contact_photo=function(a){var b="-del-"==a?this.env.photo_placeholder:this.env.comm_path+"&_action=photo&_source="+this.env.source+"&_cid="+(this.env.cid||0)+"&_photo="+a;this.set_photo_actions(a);$(this.gui_objects.contactphoto).children("img").attr("src",b)};this.photo_upload_end=function(){this.set_busy(!1,null,this.file_upload_id);delete this.file_upload_id};this.set_photo_actions=
function(a){var b,d=this.buttons["upload-photo"];for(b=0;d&&b<d.length;b++)$("a#"+d[b].id).html(this.get_label("-del-"==a?"addphoto":"replacephoto"));$("#ff_photo").val(a);this.enable_command("upload-photo",this.env.coltypes.photo?!0:!1);this.enable_command("delete-photo",this.env.coltypes.photo&&"-del-"!=a)};this.advanced_search=function(){var a=$("<iframe>").attr("src",this.url("search",{_form:1,_framed:1}));this.simple_dialog(a,this.gettext("advsearch"),function(){var b=!1,d={_adv:1};$.each($(a[0].contentWindow.rcmail.gui_objects.editform).serializeArray(),
function(){this.name.match(/^_search/)&&""!=this.value&&(d[this.name]=this.value,b=!0)});if(b)return f.http_post("search",d,f.set_busy(!0,"searching")),!0},{button:"search",width:600,height:500});return!0};this.unselect_directory=function(){this.select_folder("");this.enable_command("search-delete",!1)};this.insert_saved_search=function(a,b){var d="S"+b,e=$("<a>").attr({href:"#",rel:b}).click(function(){return f.command("listsearch",b,this)}).html(a),g={name:a,id:b};this.savedsearchlist.insert({id:d,
html:e,classes:["contactsearch"]},null,"contactsearch");this.select_folder(d,"",!0);this.enable_command("search-delete",!0);this.env.search_id=b;this.triggerEvent("abook_search_insert",g)};this.search_create=function(){var a=$("<input>").attr("type","text"),b=$("<label>").text(this.get_label("namex")).append(a);this.simple_dialog(b,"searchsave",function(){var b;if(b=a.val())return f.http_post("search-create",{_search:f.env.search_request,_name:b},f.set_busy(!0,"loading")),!0})};this.search_delete=
function(){if(this.env.search_request){var a=this.set_busy(!0,"savedsearchdeleting");this.http_post("search-delete",{_sid:this.env.search_id},a)}};this.remove_search_item=function(a){this.savedsearchlist.remove("S"+a)&&this.triggerEvent("search_delete",{id:a});this.env.search_id=null;this.env.search_request=null;this.list_contacts_clear();this.reset_qsearch();this.enable_command("search-delete","search-create",!1)};this.listsearch=function(a){var b=this.set_busy(!0,"searching");this.contact_list&&
this.list_contacts_clear();this.reset_qsearch();this.savedsearchlist?(this.treelist.select(""),this.savedsearchlist.select("S"+a)):this.select_folder("S"+a,"",!0);this.env.current_page=1;this.http_request("search",{_sid:a},b)};this.qrcode=function(){var a=this.get_label("qrcode"),b=new Image(300,300);b.src=this.url("addressbook/qrcode",{_source:this.env.source,_cid:this.get_single_cid()});return this.simple_dialog(b,a,null,{button:!1,cancel_button:"close",width:300,height:300})};this.section_select=
function(a){var b;(a=a.get_single_selection())&&(b=this.get_frame_window(this.env.contentframe))&&this.location_href({_action:"edit-prefs",_section:a,_framed:1},b,!0)};this.response_select=function(a){a=a.get_single_selection();this.enable_command("delete",!!a&&0>$.inArray(a,this.env.readonly_responses));a&&this.load_response(a,"edit-response")};this.load_response=function(a,b){var d;if(d=this.get_frame_window(this.env.contentframe))if(a||"add-response"==b)a||this.responses_list.clear_selection(),
this.location_href({_action:b,_key:a,_framed:1},d,!0)};this.identity_select=function(a){var b=a.get_single_selection();this.enable_command("delete",!!b&&1<a.rowcount&&2>this.env.identities_level);b&&this.load_identity(b,"edit-identity")};this.load_identity=function(a,b){var d;if(d=this.get_frame_window(this.env.contentframe))if(a||"add-identity"==b)a||this.identity_list.clear_selection(),this.location_href({_action:b,_iid:a,_framed:1},d,!0)};this.delete_identity=function(a){var b=this.identity_list.get_selection();
if(b.length||this.env.iid)a||(a=this.env.iid?this.env.iid:b[0]),a&&this.confirm_dialog(this.get_label("deleteidentityconfirm"),"delete",function(){f.http_post("settings/delete-identity",{_iid:a},!0)})};this.update_identity_row=function(a,b,d){var e=this.identity_list;a=this.html_identifier(a);d?(e.insert_row({id:"rcmrow"+a,cols:[{className:"mail",innerHTML:b}]}),e.select(a)):e.update_row(a,[b])};this.update_response_row=function(a,b){var d=this.responses_list;d&&b?d.update_row(b,[a.name],a.key,!0):
d&&(d.insert_row({id:"rcmrow"+a.key,cols:[{className:"name",innerHTML:a.name}]}),d.select(a.key))};this.remove_response=function(a){this.env.textresponses&&delete this.env.textresponses[a];this.responses_list&&(this.responses_list.remove_row(a),this.show_contentframe(!1));this.enable_command("delete",!1)};this.remove_identity=function(a){var b=this.identity_list,d=this.html_identifier(a);b&&a&&(b.remove_row(d),this.show_contentframe(!1));this.enable_command("delete",!1)};this.init_subscription_list=
function(){var a=RegExp.escape(this.env.delimiter);this.last_sub_rx=RegExp("["+a+"]?[^"+a+"]+$");this.subscription_list=new rcube_treelist_widget(this.gui_objects.subscriptionlist,{selectable:!0,tabexit:!1,parent_focus:!0,id_prefix:"rcmli",id_encode:this.html_identifier_encode,id_decode:this.html_identifier_decode,searchbox:"#foldersearch"});this.subscription_list.addEventListener("select",function(a){f.subscription_select(a.id)}).addEventListener("collapse",function(a){f.folder_collapsed(a)}).addEventListener("expand",
function(a){f.folder_collapsed(a)}).addEventListener("search",function(a){a.query&&f.subscription_select()}).draggable({cancel:"li.mailbox.root,input,div.treetoggle,.custom-control"}).droppable({accept:function(a){if(!a.is(".mailbox"))return!1;a=f.folder_id2name(a.attr("id"));var d=f.folder_id2name(this.id),e=f.env.subscriptionrows[a];return e&&!e[2]&&d!=a.replace(f.last_sub_rx,"")&&!d.startsWith(a+f.env.delimiter)},drop:function(a,d){var e=f.folder_id2name(d.draggable.attr("id")),g=f.folder_id2name(this.id);
f.subscription_move_folder(e,g)}})};this.folder_id2name=function(a){return a?f.html_identifier_decode(a.replace(/^rcmli/,"")):null};this.subscription_select=function(a){var b;a&&"*"!=a&&(b=this.env.subscriptionrows[a])?(this.env.mailbox=a,this.show_folder(a),this.enable_command("delete-folder",!b[2])):(this.env.mailbox=null,this.show_contentframe(!1),this.enable_command("delete-folder","purge",!1))};this.subscription_move_folder=function(a,b){if(a&&null!==b&&a!=b&&b!=a.replace(this.last_sub_rx,"")){var d=
a.split(this.env.delimiter).pop(),e=""===b||"*"===b?d:b+this.env.delimiter+d;e!=a&&this.confirm_dialog(this.get_label("movefolderconfirm"),"move",function(){f.http_post("rename-folder",{_folder_oldname:a,_folder_newname:e},f.set_busy(!0,"foldermoving"))},{button_class:"save move"})}};this.create_folder=function(){this.show_folder("",this.env.mailbox)};this.delete_folder=function(a){a||(a=this.env.mailbox);a&&this.confirm_dialog(this.get_label("deletefolderconfirm"),"delete",function(){f.http_post("delete-folder",
{_mbox:a},f.set_busy(!0,"folderdeleting"))})};this.add_folder_row=function(a,b,d,e,g,k,h,l){if(!this.gui_objects.subscriptionlist)return!1;this.subscription_list.is_search()&&(this.subscription_select(),this.subscription_list.reset_search());this.subscription_list.is_draggable()&&this.subscription_list.draggable("destroy").droppable("destroy");var m,q,p,s,t,u="",w=[],v=[],x=[],y=$(this.gui_objects.subscriptionlist);m=h?h:$($("li",y).get(1)).clone(!0);if(!m.length)return this.goto_url("folders"),!1;
m.attr({id:"rcmli"+this.html_identifier_encode(a),"class":k});h&&h.length||($("ul,div.treetoggle",m).remove(),m.removeData("filtered"));$("a",m).first().text(d).removeAttr("title");$('input[name="_subscribed[]"]',m).first().val(a).prop({checked:g?!0:!1,disabled:e?!0:!1});this.env.subscriptionrows[a]=[b,d,!1];$.each(this.env.subscriptionrows,function(a,b){b[3]=a;w.push(b)});try{t=new Intl.Collator(this.env.locale.replace("_","-"))}catch(z){}w.sort(function(a,b){var d,e,g,k=a[0].split(f.env.delimiter),
h=b[0].split(f.env.delimiter),l=k.length;for(d=0;d<l;d++){e=k[d];g=h[d];if(e!==g)return void 0===g?1:t?t.compare(e,g):e<g?-1:1;if(d==l-1)return-1}});for(q in w)d=w[q][3],w[q][2]?(b=d+this.env.delimiter,b!=this.env.prefix_ns&&(x.push(d),p=b)):p&&d.startsWith(p)?x.push(d):(v.push(d),p=null);for(q=0;q<x.length;q++)a.startsWith(x[q]+this.env.delimiter)&&(s=x[q]);for(q=0;!s&&q<v.length;q++)q&&v[q]==a&&(s=v[q-1]);if(s&&(q=this.subscription_list.get_item(s,!0))){if(p=a.lastIndexOf(this.env.delimiter))u=
a.substring(0,p),u=this.subscription_list.get_item(u,!0),$("div.treetoggle",u).length||$("<div>&nbsp;</div>").addClass("treetoggle collapsed").appendTo(u),$("ul",u).length||$("<ul>").css("display","none").appendTo(u);if(u&&q==u)$("ul",u).first().append(m);else{for(;(d=$(q).parent().parent().get(0))&&(!u||d!=u)&&$(d).is("li.mailbox");)q=d;$(q).after(m)}}else y.append(m);$.extend(this.env.subscriptionrows,l||{});this.subscription_list.reset(!0);this.subscription_select();u&&this.subscription_list.expand(this.folder_id2name(u.id));
m=m.show().get(0);m.scrollIntoView&&m.scrollIntoView(!1);h||this.triggerEvent("clonerow",{row:m,id:a});return m};this.replace_folder_row=function(a,b,d,e,g,k){if(!this.gui_objects.subscriptionlist)return this.is_framed()?window.parent.rcmail.replace_folder_row(a,b,d,e,g,k):!1;this.subscription_list.is_search()&&(this.subscription_select(),this.subscription_list.reset_search());var h={},l=this.subscription_list.get_item(a,!0),m=$(l).parent(),q=a.length,p=this.env.subscriptionrows[a][0].length,s=$('input[name="_subscribed[]"]',
l).first().prop("checked");a==b?$(l).attr("class",k||""):($("li",l).each(function(){var a=f.folder_id2name(this.id),e=f.env.subscriptionrows[a],g=b+a.slice(q);this.id="rcmli"+f.html_identifier_encode(g);$('input[name="_subscribed[]"]',this).first().val(g);e[0]=d+e[0].slice(p);h[g]=e;delete f.env.subscriptionrows[a]}),l=$(l).detach(),delete this.env.subscriptionrows[a],m.get(0)==this.gui_objects.subscriptionlist||$("li",m).length||$("ul,div.treetoggle",m.parent()).remove(),this.add_folder_row(b,d,
e,g,s,k,l,h))};this.remove_folder_row=function(a){this.subscription_list.is_search()&&(this.subscription_select(),this.subscription_list.reset_search());var b=[],d=this.subscription_list.get_item(a,!0);$("li",d).each(function(){b.push(f.folder_id2name(this.id))});this.subscription_list.remove(a);b.push(a);$.each(b,function(a,b){delete f.env.subscriptionrows[b]})};this.subscribe=function(a){this.change_subscription_state(a,!0)};this.unsubscribe=function(a){this.change_subscription_state(a,!1)};this.change_subscription_state=
function(a,b){if(a){var d=b?"":"un",e=this.display_message("folder"+d+"subscribing","loading");this.http_post(d+"subscribe",{_mbox:a},e);$(this.gui_objects.subscriptionlist).find('input[value="'+a+'"]').prop("checked",b)}};this.show_folder=function(a,b,d){var e=window;a="&_action="+(""===a?"add":"edit")+"-folder&_mbox="+urlencode(a);b&&(a+="&_path="+urlencode(b));if(b=this.get_frame_window(this.env.contentframe))e=b,a+="&_framed=1";0<=String(e.location.href).indexOf(a)&&!d?this.show_contentframe(!0):
this.location_href(this.env.comm_path+a,e,!0)};this.disable_subscription=function(a){(a=this.subscription_list.get_item(a,!0))&&$('input[name="_subscribed[]"]',a).first().prop("disabled",!0)};this.reset_subscription=function(a,b){var d=this.subscription_list.get_item(a,!0);d&&$('input[name="_subscribed[]"]',d).first().prop("checked",b)};this.folder_size=function(a){var b=this.set_busy(!0,"loading");this.http_post("folder-size",{_mbox:a},b)};this.folder_size_update=function(a){$("#folder-size").replaceWith(a)};
this.folder_filter=function(a){this.subscription_list.reset_search();this.subscription_list.container.children("li").each(function(){var b,d=f.folder_id2name(this.id);if("---"!=a)if(a){if(d!==a){$(this).data("filtered",!0).hide();return}}else for(b in f.env.ns_roots)if(d===f.env.ns_roots[b]){$(this).data("filtered",!0).hide();return}$(this).removeData("filtered").show()})};this.init_button=function(a,b){var d=document.getElementById(b.id);if(d){var e=!1;"image"==b.type&&(d=d.parentNode,e=!0);d._command=
a;d._id=b.id;b.sel&&(d.onmousedown=function(a){return f.button_sel(this._command,this._id)},d.onmouseup=function(a){return f.button_out(this._command,this._id)},e&&((new Image).src=b.sel));b.over&&(d.onmouseover=function(a){return f.button_over(this._command,this._id)},d.onmouseout=function(a){return f.button_out(this._command,this._id)},e&&((new Image).src=b.over))}};this.init_buttons=function(){for(var a in this.buttons)if("string"===typeof a)for(var b=0;b<this.buttons[a].length;b++)this.init_button(a,
this.buttons[a][b])};this.set_button=function(a,b){var d,e,g,f=this.buttons[a],h=f?f.length:0;for(d=0;d<h;d++)if(e=f[d],(g=document.getElementById(e.id))&&e.status!==b)"image"!=e.type||e.status?e.status||(e.pas=String(g.className)):(e.pas=g._original_src?g._original_src:g.src,g.runtimeStyle&&g.runtimeStyle.filter&&g.runtimeStyle.filter.match(/src=['"]([^'"]+)['"]/)&&(e.pas=RegExp.$1)),e.status=b,"image"==e.type&&e[b]?g.src=e[b]:void 0!==e[b]&&(g.className=e[b]),"input"==e.type||"button"==e.type?g.disabled=
"pas"==b:$(g).attr({tabindex:"pas"==b||"sel"==b?"-1":$(g).attr("data-tabindex")||"0","aria-disabled":"pas"==b||"sel"==b?"true":"false"})};this.set_alttext=function(a,b){var d,e,g,f,h=this.buttons[a],l=h?h.length:0;for(d=0;d<l;d++)e=h[d],g=document.getElementById(e.id),b=this.get_label(b),g&&"image"==e.type?(g.setAttribute("alt",b),(f=g.parentNode)&&"a"==f.tagName.toLowerCase()&&f.setAttribute("title",b)):g&&g.setAttribute("title",b)};this.button_over=function(a,b){this.button_event(a,b,"over")};this.button_sel=
function(a,b){this.button_event(a,b,"sel")};this.button_out=function(a,b){this.button_event(a,b,"act")};this.button_event=function(a,b,d){var e,g,f,h=this.buttons[a],l=h?h.length:0;for(e=0;e<l;e++)g=h[e],g.id==b&&"act"==g.status&&(g[d]&&(f=document.getElementById(g.id))&&(f["image"==g.type?"src":"className"]=g[d]),"sel"==d&&(this.buttons_sel[b]=a))};this.set_pagetitle=function(a){a&&document.title&&(document.title=a)};this.display_message=function(a,b,d,e){a&&a.length&&/^[a-z._]+$/.test(a)&&(a=this.get_label(a));
if(this.is_framed())return parent.rcmail.display_message(a,b,d);if(!this.gui_objects.message)return"loading"!=b&&(this.pending_message=[a,b,d,e]),1;b?"loading"==b&&(e||(e="loading"),d||(d=1E3*this.env.request_timeout),a||(a=this.get_label("loading"))):b="notice";e||(e=this.html_identifier(a));var g=b+(new Date).getTime();if(!d)switch(b){case "error":case "warning":d=2*this.message_time;break;case "uploading":d=0;break;default:d=this.message_time}if(this.messages[e])return this.messages[e].obj&&$("div.content",
this.messages[e].obj).html(a),"loading"==b&&this.messages[e].labels.push({id:g,msg:a}),this.messages[e].elements.push(g),setTimeout(function(){f.hide_message(g,"loading"==b)},d),g;var k=$("<div>").addClass(b+" content").html(a).data("key",e);$(this.gui_objects.message).append(k).show();this.messages[e]={obj:k,elements:[g]};"loading"==b?this.messages[e].labels=[{id:g,msg:a}]:"uploading"!=b&&k.click(function(){return f.hide_message(k)}).attr("role","alert");this.triggerEvent("message",{message:a,type:b,
timeout:d,object:k});0<d&&setTimeout(function(){f.hide_message(g,"loading"!=b)},d);return g};this.hide_message=function(a,b){if(this.is_framed())return parent.rcmail.hide_message(a,b);if(this.gui_objects.message){var d,e,g,f,h=this.messages;if("object"===typeof a)f=$(a),d=f.data("key"),this.hide_message_object(f,b),h[d]&&delete h[d];else for(d in h)for(e in h[d].elements)if(h[d]&&h[d].elements[e]==a)if(h[d].elements.splice(e,1),!h[d].elements.length)this.hide_message_object(h[d].obj,b),delete h[d];
else if("loading"==d)for(g in h[d].labels)h[d].labels[g].id==a?delete h[d].labels[g]:(f=h[d].labels[g].msg,$("div.content",h[d].obj).html(f))}};this.hide_message_object=function(a,b){b?a.fadeOut(600,function(){$(this).remove()}):a.hide().remove()};this.clear_messages=function(){if(this.is_framed())return parent.rcmail.clear_messages();var a,b,d=this.messages;for(a in d)for(b in d[a].elements)d[a].obj&&this.hide_message_object(d[a].obj);this.messages={}};this.display_progress=function(a){if(a&&a.name){var b=
this.messages["progress"+a.name];a.label||(a.label=this.get_label("uploadingmany"));b?!a.total||100<=a.percent?this.hide_message(b.obj):(a.text&&(a.label+=" "+a.text),b.obj.text(a.label)):(!a.percent||100>a.percent)&&this.display_message(a.label,"uploading",0,"progress"+a.name)}};this.show_popup_dialog=function(a,b,d,e){if(this.is_framed())return parent.rcmail.show_popup_dialog(a,b,d,e);var g=$('<div class="popup">');"object"==typeof a?(g.append(a),$(a).is("iframe")&&g.addClass("iframe")):g.html(a);
var f=0;e&&e.button_classes&&$.each(d,function(a,b){var g=e.button_classes[f];if(g){var h=b;"function"==typeof h?h={click:h,text:a,"class":g}:d["class"]=g;d[a]=h}f++});e=$.extend({title:b,buttons:d,modal:!0,resizable:!0,width:500,close:function(a,b){$(this).remove()}},e||{});g.dialog(e);e.width&&g.width(e.width);e.height&&g.height(e.height);b=$(window);a=b.width();b=b.height();var h=g.width(),l=e.height||g[0].scrollHeight+20,m=g.parent(),q=$(".ui-dialog-titlebar",m).outerHeight()||0,p=$(".ui-dialog-buttonpane",
m).outerHeight()||0,s=2*(parseInt(m.css("padding-top"))+parseInt(g.css("padding-top")));g.dialog("option",{height:Math.min(b-40,l+q+p+s+2),width:Math.min(a-20,h+24)});m.on("keydown keyup",function(a){a.stopPropagation()});this.triggerEvent("dialog-open",{obj:g});return g};this.simple_dialog=function(a,b,d,e){e||(e={});b=this.get_label(b);var g=e.button||"save",k=e.button_class||g.replace(/^[^\.]+\./i,""),h=e.cancel_button||"cancel",l=e.cancel_class||h.replace(/^[^\.]+\./i,""),m=function(a,b,d){(f.is_framed()?
parent.$:$)(d||this).dialog("close");e.cancel_func&&e.cancel_func(a,f)},h=[{text:this.get_label(h),"class":l.replace(/close/i,"cancel"),click:m}];d?h.unshift({text:this.get_label(g),"class":"mainaction "+k,click:function(a,b){d(a,f)&&m(a,b,this)}}):h[0]["class"]+=" mainaction";return this.show_popup_dialog(a,b,h,e)};this.alert_dialog=function(a,b,d){d=$.extend(d||{},{cancel_button:"ok",cancel_class:"save",cancel_func:b});return this.simple_dialog(a,d.title||"alerttitle",null,d)};this.confirm_dialog=
function(a,b,d,e){e=$.extend(e||{},{button:b||"continue"});return this.simple_dialog(a,e.title||"confirmationtitle",function(a,b){d(a,b);return!0},e)};this.set_page_buttons=function(){this.enable_command("nextpage","lastpage",this.env.pagecount>this.env.current_page);this.enable_command("previouspage","firstpage",1<this.env.current_page);this.update_pagejumper()};this.select_folder=function(a,b,d){this.savedsearchlist&&this.savedsearchlist.select("");this.treelist?this.treelist.select(a):this.gui_objects.folderlist&&
($("li.selected",this.gui_objects.folderlist).removeClass("selected"),$(this.get_folder_li(a,b,d)).addClass("selected"),this.triggerEvent("selectfolder",{folder:a,prefix:b}))};this.mark_folder=function(a,b,d,e){$(this.get_folder_li(a,d,e)).addClass(b);this.triggerEvent("markfolder",{folder:a,mark:b,status:!0})};this.unmark_folder=function(a,b,d,e){$(this.get_folder_li(a,d,e)).removeClass(b);this.triggerEvent("markfolder",{folder:a,mark:b,status:!1})};this.get_folder_li=function(a,b,d){b||(b="rcmli");
if(this.gui_objects.folderlist)return a=this.html_identifier(a,d),document.getElementById(b+a)};this.set_message_coltypes=function(a,b,d){var e=this.message_list,f=e?e.thead:null,k,h;this.env.listcols=a;this.env.coltypes||(this.env.coltypes={});if(f){if(b){f.innerHTML="";h=document.createElement("tr");c=0;for(a=b.length;c<a;c++)k=document.createElement("th"),k.innerHTML=b[c].html||"",b[c].id&&(k.id=b[c].id),b[c].className&&(k.className=b[c].className),h.appendChild(k);f.appendChild(h)}h=0;for(a=this.env.listcols.length;h<
a;h++)b=this.env.listcols[h],!(k=f.rows[0].cells[h])||"from"!=b&&"to"!=b&&"fromto"!=b||$(k).attr("rel",b).find("span,a").text(this.get_label("fromto"==b?d:b))}this.env.subject_col=null;this.env.flagged_col=null;this.env.status_col=null;this.env.coltypes.folder&&(this.env.coltypes.folder.hidden=!(this.env.search_request||this.env.search_id)||"base"==this.env.search_scope);0<=(h=$.inArray("subject",this.env.listcols))&&(this.env.subject_col=h,e&&(e.subject_col=h));0<=(h=$.inArray("flag",this.env.listcols))&&
(this.env.flagged_col=h);0<=(h=$.inArray("status",this.env.listcols))&&(this.env.status_col=h);e&&(e.hide_column("folder",this.env.coltypes.folder&&this.env.coltypes.folder.hidden||0>$.inArray("folder",this.env.listcols)),e.init_header())};this.set_rowcount=function(a,b){if(b&&b!=this.env.mailbox)return!1;$(this.gui_objects.countdisplay).html(a);this.set_page_buttons()};this.set_mailboxname=function(a){this.gui_objects.mailboxname&&a&&(this.gui_objects.mailboxname.innerHTML=a)};this.set_quota=function(a){this.gui_objects.quotadisplay&&
a&&"text"==a.type&&$(this.gui_objects.quotadisplay).text((a.percent||0)+"%").attr("title",a.title||"");this.triggerEvent("setquota",a);this.env.quota_content=a};this.set_trash_count=function(a){this[(a?"un":"")+"mark_folder"](this.env.trash_mailbox,"empty","",!0)};this.set_unread_count=function(a,b,d,e){if(!this.gui_objects.mailboxlist)return!1;this.env.unread_counts[a]=b;this.set_unread_count_display(a,d);e?this.mark_folder(a,e,"",!0):b||this.unmark_folder(a,"recent","",!0);this.mark_all_read_state()};
this.set_unread_count_display=function(a,b){var d,e,f,k,h;if(f=this.get_folder_li(a,"",!0)){k=this.env.unread_counts[a]?this.env.unread_counts[a]:0;e=$(f).children("a").eq(0);d=e.children("span.unreadcount");!d.length&&k&&(d=$("<span>").addClass("unreadcount skip-content").appendTo(e));e=0;if((h=f.getElementsByTagName("div")[0])&&h.className.match(/collapsed/))for(var l in this.env.unread_counts)l.startsWith(a+this.env.delimiter)&&(e+=this.env.unread_counts[l]);k&&d.length?d.html(this.env.unreadwrap.replace(/%[sd]/,
k)):d.length&&d.remove();d=RegExp(RegExp.escape(this.env.delimiter)+"[^"+RegExp.escape(this.env.delimiter)+"]+$");a.match(d)&&this.set_unread_count_display(a.replace(d,""),!1);0<k+e?$(f).addClass("unread"):$(f).removeClass("unread")}d=/^\([0-9]+\)\s+/i;b&&document.title&&(f="",f=String(document.title),f=k&&f.match(d)?f.replace(d,"("+k+") "):k?"("+k+") "+f:f.replace(d,""),this.set_pagetitle(f))};this.set_headers=function(a){this.gui_objects.all_headers_box&&a&&$(this.gui_objects.all_headers_box).html(a).show()};
this.show_headers=function(a,b){this.gui_objects.all_headers_row&&this.gui_objects.all_headers_box&&this.env.uid&&($(b).removeClass("show-headers").addClass("hide-headers"),$(this.gui_objects.all_headers_row).show(),b.onclick=function(){f.command("hide-headers","",b)},this.gui_objects.all_headers_box.innerHTML||this.http_request("headers",{_uid:this.env.uid,_mbox:this.env.mailbox},this.display_message("","loading")))};this.hide_headers=function(a,b){this.gui_objects.all_headers_row&&this.gui_objects.all_headers_box&&
($(b).removeClass("hide-headers").addClass("show-headers"),$(this.gui_objects.all_headers_row).hide(),b.onclick=function(){f.command("show-headers","",b)})};this.folder_selector=function(a,b){this.entity_selector("folder-selector",b,this.env.mailboxes_list,function(a,b){var g=0,k=0,h=f.env.delimiter,l=f.env.mailboxes[a],m=l.id,q=$("<li>");l.virtual?b.addClass("virtual").attr({"aria-disabled":"true",tabindex:"-1"}):b.addClass("active").data("id",l.id);for(l["class"]&&q.addClass(l["class"]);0<=(k=m.indexOf(h,
k));)g++,k++;b.css("padding-left",g?16*g+"px":0);b.append($("<span>").text(l.name));return q.append(b)},a)};this.addressbook_selector=function(a,b){var d=[];this.entity_selectors["addressbook-selector"]||$.each(this.env.address_sources,function(){if(!this.readonly){var a=this;d.push(a);$.each(f.env.contactgroups,function(){a.id===this.source&&d.push(this)})}});this.entity_selector("addressbook-selector",b,d,function(a,b){"group"==a.type?b.attr("rel",a.source+":"+a.id).addClass("contactgroup active").data({source:a.source,
gid:a.id,id:a.source+":"+a.id}).css("padding-left","16px"):b.addClass("addressbook active").data("id",a.id);b.append($("<span>").text(a.name));return $("<li>").append(b)},a)};this.contactgroup_selector=function(a,b){this.entity_selector("contactgroup-selector",b,this.env.contactgroups,function(a,b){if(f.env.source===a.source)return b.addClass("contactgroup active").data({id:a.id}).append($("<span>").text(a.name)),$("<li>").append(b)},a)};this.entity_selector=function(a,b,d,e,f){var k=this.entity_selectors[a];
if(!k){var h=[],k=$("<div>").attr("id",a).addClass("popupmenu"),l=$("<ul>").addClass("toolbarmenu menu"),m=document.createElement("a");m.href="#";m.className="icon";$.each(d,function(a){var b=$(m.cloneNode(!1)).attr("rel",this.id);h.push(e(this,b,a))});l.append(h).appendTo(k);k.css({left:"-1000px",top:"-1000px"}).appendTo(document.body).show();10<h.length&&k.css("max-height",10*$("li",k)[0].offsetHeight+9);k.on("click","a.active",function(a){k.data("callback")($(this).data("id"),this)});this.entity_selectors[a]=
k}k.data("callback",b);this.show_menu(a,!0,f)};this.destroy_entity_selector=function(a){$("#"+a).remove();delete this.entity_selectors[a]};this.show_menu=function(a,b,d){var e="object"==typeof a?a.menu:a,f=$("#"+e),k=d&&d.target?$(d.target):$(f.attr("rel")||"#"+e+"link"),h=rcube_event.is_keyboard(d),l=f.attr("data-align")||"",m=!1;"A"!=k.get(0).tagName&&k.closest("a").length&&(k=k.closest("a"));"string"==typeof a&&(a={menu:e});f.length||(f=this.triggerEvent("menu-get",{name:e,props:a,originalEvent:d}));
if(!f||!f.length)return this.triggerEvent(!1===b?"menu-close":"menu-open",{name:e,props:a,originalEvent:d});f.appendTo(document.body);"undefined"==typeof b&&(b=f.is(":visible")?!1:!0);if(b&&k.length){var q=$(window),p=k.offset(),s=0<=l.indexOf("bottom"),m="menuitem"==k.attr("role")||0<k.closest("[role=menuitem]").length;k.offsetWidth=k.outerWidth();k.offsetHeight=k.outerHeight();!s&&p.top+k.offsetHeight+f.height()>q.height()&&(s=!0);0<=l.indexOf("right")?p.left=p.left+k.outerWidth()-f.width():m&&
(p.left=p.left+k.offsetWidth-5,p.top-=k.offsetHeight);p.left+f.width()>q.width()&&(p.left=q.width()-f.width()-12);p.top=Math.max(0,p.top+(s?-f.height():k.offsetHeight));f.css({left:p.left+"px",top:p.top+"px"})}if(b){for(l=this.menu_stack.length-1;m&&0<=l;l--)$(k).parents("#"+this.menu_stack[l]).length||"menuitem"==$(d.target).parent().attr("role")||this.hide_menu(this.menu_stack[l],d);m&&this.menu_stack.length?(f.data("parent",$.last(this.menu_stack)),f.css("z-index",($("#"+$.last(this.menu_stack)).css("z-index")||
0)+1)):!m&&this.menu_stack.length&&this.hide_menu(this.menu_stack[0],d);f.show().attr("aria-hidden","false").data("opener",k.attr("aria-expanded","true").get(0));this.triggerEvent("menu-open",{name:e,obj:f,props:a,originalEvent:d});this.menu_stack.push(e);if(this.menu_keyboard_active=b&&h)this.focused_menu=e,f.find("a,input:not(:disabled)").not("[aria-disabled=true]").first().focus()}else this.hide_menu(e,d);return b};this.hide_menu=function(a,b){if(this.menu_stack.length){for(var d,e=rcube_event.is_keyboard(b),
f=this.menu_stack.length-1;0<=f;f--)d=$("#"+this.menu_stack[f]).hide().attr("aria-hidden","true").data("parent",!1),this.triggerEvent("menu-close",{name:this.menu_stack[f],obj:d,props:{menu:this.menu_stack[f]},originalEvent:b}),this.menu_stack[f]==a&&(f=-1,d.data("opener")&&($(d.data("opener")).attr("aria-expanded","false"),e&&d.data("opener").focus())),this.menu_stack.pop();this.menu_stack.length&&e?(this.menu_keyboard_active=!0,this.focused_menu=$.last(this.menu_stack),d&&d.data("opener")||$("#"+
this.focused_menu).find("a,input:not(:disabled)").not("[aria-disabled=true]").first().focus()):(this.focused_menu=null,this.menu_keyboard_active=!1)}else this.triggerEvent("menu-close",{name:a,props:{menu:a},originalEvent:b})};this.element_position=function(a,b){b=$(b);var d=$(window),e=b.outerWidth(),f=b.outerHeight(),k=b.data("menu-pos"),h=d.height(),l=$(a).height(),m=$(a).width(),q=b.offset(),p=q.top,q=q.left+e;"bottom"==k?(p+=f,q-=e):q-=5;p+l>h&&(p-=l-f,0>p&&(p=Math.max(0,(h-l)/2)));q+m>d.width()&&
(q-=m+e);a.css({left:q+"px",top:p+"px"})};this.editor_init=function(a,b){this.editor=new rcube_text_editor(a,b)};this.html2plain=function(a,b){return this.format_converter(a,"html",b)};this.plain2html=function(a,b){return this.format_converter(a,"plain",b)};this.format_converter=function(a,b,d){if(!a||"html"==b&&!a.replace(/<[^>]+>|&nbsp;|\xC2\xA0|\s/g,"").length||"html"!=b&&!a.replace(/\xC2\xA0|\s/g,"").length)return d&&setTimeout(function(){d("")},50),!0;var e=this.env.editor_warned||confirm(this.get_label("editorwarning"));
this.env.editor_warned=!0;if(!e)return!1;b="?_task=utils&_action="+("html"==b?"html2text":"text2html");var g=this.set_busy(!0,"converting");$.ajax({type:"POST",url:b,data:a,contentType:"application/octet-stream",error:function(a,b,d){f.http_error(a,b,d,g)},success:function(a){f.set_busy(!1,null,g);d&&d(a)}});return!0};this.url=function(a,b){var d="string"===typeof b?b:"";"string"!==typeof a?b=a:b&&"object"===typeof b||(b={});a?b._action=a:this.env.action&&(b._action=this.env.action);var e=this.env.comm_path,
f,k={};a&&a.match(/([a-z0-9_-]+)\/([a-z0-9-_.]+)/)&&(b._action=RegExp.$2,e=e.replace(/\_task=[a-z0-9_-]+/,"_task="+RegExp.$1));0===b._framed&&(e=e.replace("&_framed=1",""),b._framed=null);for(f in b)void 0!==b[f]&&null!==b[f]&&(k[f]=b[f]);if(k=$.param(k))e+=(-1<e.indexOf("?")?"&":"?")+k;d&&(e+=(-1<e.indexOf("?")?"&":"?")+d);return e};this.redirect=function(a,b){!1!==b&&this.set_busy(!0,"loading");this.is_framed()?(a=a.replace(/&_framed=1/,""),parent.rcmail.redirect(a,b)):(this.env.extwin&&("string"==
typeof a?a+=(0>a.indexOf("?")?"?":"&")+"_extwin=1":a._extwin=1),this.location_href(a,window))};this.goto_url=function(a,b,d,e){a=this.url(a,b);e&&(a=this.secure_url(a));this.redirect(a,d)};this.location_href=function(a,b,d){d&&this.lock_frame(b);"object"==typeof a&&(a=this.env.comm_path+"&"+$.param(a));bw.ie&&b==window?$("<a>").attr("href",a).appendTo(document.body).get(0).click():b.location.href=a;this.start_keepalive()};this.update_state=function(a){if(window.history.replaceState)try{window.history.replaceState({},
document.title,rcmail.url("",a))}catch(b){}};this.http_get=this.http_request=function(a,b,d,e){"POST"!=e&&(e="GET");"object"!==typeof b&&(b=rcube_parse_query(b));b._remote=1;b._unlock=d?d:0;var g=this.triggerEvent("request"+a,b);if(!1===g)return b._unlock&&this.set_busy(!1,null,b._unlock),!1;if(g&&g.getResponseHeader)return g;void 0!==g&&(b=g,b._action&&(a=b._action,delete b._action));g=this.url(a);this.start_keepalive();return $.ajax({type:e,url:g,data:b,dataType:"json",success:function(a){f.http_response(a)},
error:function(b,e,g){f.http_error(b,e,g,d,a)}})};this.http_post=function(a,b,d){return this.http_request(a,b,d,"POST")};this.abort_request=function(a){a.request&&a.request.abort();a.lock&&this.set_busy(!1,null,a.lock)};this.http_response=function(a){if(a){a.unlock&&this.set_busy(!1,null,a.unlock);this.triggerEvent("responsebefore",{response:a});this.triggerEvent("responsebefore"+a.action,{response:a});a.env&&this.set_env(a.env);var b;if("object"===typeof a.texts)for(b in a.texts)"string"===typeof a.texts[b]&&
this.add_label(b,a.texts[b]);a.exec&&eval(a.exec);if(a.callbacks&&a.callbacks.length)for(b=0;b<a.callbacks.length;b++)this.triggerEvent(a.callbacks[b][0],a.callbacks[b][1]);switch(a.action){case "mark":"show"!=this.env.action&&"preview"!=this.env.action||"SEEN"!=this.env.last_flag||this.set_unread_message(this.env.uid,this.env.mailbox);break;case "delete":if("addressbook"==this.task){b=this.contact_list.get_selection();var d=!1;b&&this.contact_list.rows[b]&&(d=""==this.env.source?(b=String(b).replace(/^[^-]+-/,
""))&&this.env.address_sources[b]&&!this.env.address_sources[b].readonly:!this.env.address_sources[this.env.source].readonly);this.enable_command("delete","edit",d);this.enable_command("export",this.contact_list&&0<this.contact_list.rowcount);this.enable_command("export-selected","print",!1)}case "move":"show"==this.env.action?(this.enable_command(this.env.message_commands,!0),this.env.list_post||this.enable_command("reply-list",!1)):"addressbook"==this.task&&this.triggerEvent("listupdate",{list:this.contact_list,
folder:this.env.source,rowcount:this.contact_list.rowcount});case "purge":case "expunge":"mail"==this.task&&(this.env.exists||(this.env.contentframe&&this.show_contentframe(!1),this.enable_command(this.env.message_commands,"purge","expunge","select-all","select-none","expand-all","expand-unread","collapse-all",!1)),this.message_list&&this.triggerEvent("listupdate",{list:this.message_list,folder:this.env.mailbox,rowcount:this.message_list.rowcount}));break;case "refresh":case "check-recent":$.each(this.env.recent_flags||
{},function(a,b){f.set_message(a,"deleted",b.deleted);f.set_message(a,"replied",b.answered);f.set_message(a,"unread",!b.seen);f.set_message(a,"forwarded",b.forwarded);f.set_message(a,"flagged",b.flagged)}),delete this.env.recent_flags;case "getunread":case "search":this.env.qsearch=null;case "list":if("mail"==this.task){var d=this.is_multifolder_listing(),e=this.message_list;b=this.env.list_uid;this.enable_command("show","select-all","select-none",0<this.env.messagecount);this.enable_command("expunge",
this.env.exists&&!d);this.enable_command("purge",this.purge_mailbox_test()&&!d);this.enable_command("import-messages",!d);this.enable_command("expand-all","expand-unread","collapse-all",this.env.threading&&this.env.messagecount&&!d);if(e){if("list"==a.action||"search"==a.action)b&&("FIRST"===b?b=e.get_first_row():"LAST"===b?b=e.get_last_row():e.rows[b]||(b+="-"+this.env.mailbox),b&&e.rows[b]&&e.select(b),delete this.env.list_uid),this.enable_command("set-listmode",this.env.threads&&!d),0<e.rowcount&&
!$(document.activeElement).is("input,textarea")&&e.focus(),e.triggerEvent("select");"getunread"!=a.action&&this.triggerEvent("listupdate",{list:e,folder:this.env.mailbox,rowcount:e.rowcount})}}else"addressbook"==this.task&&(e=this.contact_list,b=this.env.list_uid,this.enable_command("export","select-all","select-none",e&&0<e.rowcount),"list"==a.action||"search"==a.action)&&(this.enable_command("search-create",""==this.env.source),this.enable_command("search-delete",this.env.search_id),this.update_group_commands(),
e&&b&&("FIRST"===b?b=e.get_first_row():"LAST"===b&&(b=e.get_last_row()),b&&e.rows[b]&&e.select(b),delete this.env.list_uid,e.triggerEvent("select")),0<e.rowcount&&!$(document.activeElement).is("input,textarea")&&e.focus(),this.triggerEvent("listupdate",{list:e,folder:this.env.source,rowcount:e.rowcount}));break;case "list-contacts":case "search-contacts":this.contact_list&&(0<this.contact_list.rowcount&&this.contact_list.focus(),this.triggerEvent("listupdate",{list:this.contact_list,rowcount:this.contact_list.rowcount}))}a.unlock&&
this.hide_message(a.unlock);this.triggerEvent("responseafter",{response:a});this.triggerEvent("responseafter"+a.action,{response:a});this.start_keepalive()}};this.http_error=function(a,b,d,e,g){d=a.statusText;this.set_busy(!1,null,e);a.abort();this.unload||(a.status&&d?this.display_message(this.get_label("servererror")+" ("+d+")","error"):"timeout"==b?this.display_message("requesttimedout","error"):0==a.status&&"abort"!=b&&this.display_message("connerror","error"),(b=a.getResponseHeader("Location"))&&
"compose"!=this.env.action&&this.redirect(b),403==a.status?(this.is_framed()?parent:window).location.reload():"keep-alive"==g&&setTimeout(function(){f.keep_alive();f.start_keepalive()},3E4))};this.session_error=function(a){this.env.server_error=401;"compose"==this.env.action?(this.save_compose_form_local(),this.compose_skip_unsavedcheck=!0,this.env.session_lifetime=0,this._keepalive&&clearInterval(this._keepalive),this._refresh&&clearInterval(this._refresh)):a&&setTimeout(function(){f.redirect(a,
!0)},2E3)};this.iframe_loaded=function(a){a||(a=this.env.frame_lock);this.set_busy(!1,null,a);this.submit_timer&&clearTimeout(this.submit_timer)};this.multi_thread_http_request=function(a){var b,d,e=(new Date).getTime(),f=a.threads||1;a.reqid=e;a.running=0;a.requests=[];a.result=[];a._items=$.extend([],a.items);a.lock||(a.lock=this.display_message("","loading"));this.http_request_jobs[e]=a;for(b=0;b<f;b++){d=a._items.shift();if(void 0===d)break;a.running++;a.requests.push(this.multi_thread_send_request(a,
d))}return e};this.multi_thread_send_request=function(a,b){var d,e,f;if(a.postdata){e={};for(d in a.postdata)e[d]=String(a.postdata[d]).replace("%s",b);e._reqid=a.reqid}else if("string"==typeof a.query)f=a.query.replace("%s",b),f+="&_reqid="+a.reqid;else if("object"==typeof a.query&&a.query){f={};for(d in a.query)f[d]=String(a.query[d]).replace("%s",b);f._reqid=a.reqid}return e?this.http_post(a.action,e):this.http_request(a.action,f)};this.multi_thread_http_response=function(a,b){var d=this.http_request_jobs[b];
if(d&&!(0>=d.running||d.cancelled)){d.running--;if(d.onresponse&&"function"==typeof d.onresponse)d.onresponse(a);d.result=$.extend(d.result,a);var e=d._items.shift();void 0!==e?(d.running++,d.requests.push(this.multi_thread_send_request(d,e))):0==d.running&&(d.whendone&&"function"==typeof d.whendone&&d.whendone(d.result),this.set_busy(!1,"",d.lock),delete this.http_request_jobs[b])}};this.multi_thread_request_abort=function(a){if(a=this.http_request_jobs[a]){for(var b=0;0<a.running&&b<a.requests.length;b++)a.requests[b].abort&&
a.requests[b].abort();a.running=0;a.cancelled=!0;this.set_busy(!1,"",a.lock)}};this.async_upload_form=function(a,b,d){var e=(new Date).getTime(),f="rcmupload"+e;this.dummy_iframe(f).on("load",{ts:e},d);$(a).attr({target:f,action:this.url(b,{_id:this.env.compose_id||"",_uploadid:e,_from:this.env.action}),method:"POST",enctype:"multipart/form-data"}).submit();return f};this.dummy_iframe=function(a,b){return $("<iframe>").attr({name:a,src:b,style:"width:0;height:0;visibility:hidden","aria-hidden":"true"}).appendTo(document.body)};
this.document_drag_hover=function(a,b){$(this.gui_objects.filedrop)[b?"addClass":"removeClass"]("active")};this.file_drag_hover=function(a,b){a.preventDefault();a.stopPropagation();$(this.gui_objects.filedrop)[b?"addClass":"removeClass"]("hover")};this.file_dropped=function(a){this.file_drag_hover(a,!1);var b;b=a.target.files||a.dataTransfer.files;var d={_id:this.env.compose_id||this.env.cid||"",_remote:1,_from:this.env.action};if(b&&b.length)this.file_upload(b,d,{name:(this.env.filedrop.fieldname||
"_file")+(this.env.filedrop.single?"":"[]"),single:this.env.filedrop.single,filter:this.env.filedrop.filter,action:f.env.filedrop.action});else if(b=a.dataTransfer.getData("roundcube-uri")){var e="upload"+(new Date).getTime();a=$("<span>").text(a.dataTransfer.getData("roundcube-name")||this.get_label("attaching")).html();d._uri=b;d._uploadid=e;this.add2attachment_list(e,{name:"",html:a,classname:"uploading",complete:!1})||(this.file_upload_id=this.set_busy(!0,"attaching"));this.http_post(this.env.filedrop.action||
"upload",d)}};this.file_upload=function(a,b,d){if(!window.FormData||!a||!a.length)return!1;var e,g,k=0,h=0,l=new FormData,m=d.name||"_file[]",q=d.single?1:a.length;args=$.extend({_remote:1,_from:this.env.action},b||{});for(b=0;h<q&&(e=a[b]);b++)if(!d.filter||e.type.match(RegExp(d.filter)))l.append(m,e),k+=e.size,g=e.name,h++;if(h){if(this.env.max_filesize&&this.env.filesizeerror&&k>this.env.max_filesize)return this.display_message(this.env.filesizeerror,"error"),!1;if(this.env.max_filecount&&this.env.filecounterror&&
h>this.env.max_filecount)return this.display_message(this.env.filecounterror,"error"),!1;var p="upload"+(new Date).getTime();a=1<h?this.get_label("uploadingmany"):g;a=$("<span>").text(a).html();this.add2attachment_list(p,{name:"",html:a,classname:"uploading",complete:!1})||d.lock||(d.lock=this.file_upload_id=this.set_busy(!0,"uploading"));args._uploadid=p;args._unlock=d.lock;this.uploads[p]=$.ajax({type:"POST",dataType:"json",url:this.url(d.action||"upload",args),contentType:!1,processData:!1,timeout:0,
data:l,headers:{"X-Roundcube-Request":this.env.request_token},xhr:function(){var a=$.ajaxSettings.xhr();a.upload&&f.labels.uploadprogress&&(a.upload.onprogress=function(a){(a=f.file_upload_msg(a.loaded,a.total))&&$("#"+p).find(".uploading").text(a)});return a},success:function(a){delete f.uploads[p];f.http_response(a)},error:function(a,b,e){delete f.uploads[p];f.remove_from_attachment_list(p);f.http_error(a,b,e,d.lock,"attachment")}})}return!0};this.file_upload_msg=function(a,b){if(b&&a<b){var d=
Math.round(a/b*100),e=f.get_label("uploadprogress");1073741824<=b?(b=parseFloat(b/1073741824).toFixed(1)+" ".this.get_label("GB"),a=parseFloat(a/1073741824).toFixed(1)):1048576<=b?(b=parseFloat(b/1048576).toFixed(1)+" "+this.get_label("MB"),a=parseFloat(a/1048576).toFixed(1)):1024<=b?(b=parseInt(b/1024)+" "+this.get_label("KB"),a=parseInt(a/1024)):b=b+" "+this.get_label("B");return e.replace("$percent",d+"%").replace("$current",a).replace("$total",b)}};this.start_keepalive=function(){if(this.env.session_lifetime&&
!this.env.framed&&!this.env.extwin&&"login"!=this.task&&"print"!=this.env.action){this._keepalive&&clearInterval(this._keepalive);var a=500*Math.min(1800,this.env.session_lifetime);this._keepalive=setInterval(function(){f.keep_alive()},3E4>a?3E4:a)}};this.start_refresh=function(){!this.env.refresh_interval||this.env.framed||this.env.extwin||"login"==this.task||"print"==this.env.action||(this._refresh&&clearInterval(this._refresh),this._refresh=setInterval(function(){f.refresh()},1E3*this.env.refresh_interval))};
this.keep_alive=function(){this.busy||this.http_request("keep-alive")};this.refresh=function(){if(this.busy)setTimeout(function(){f.refresh();f.start_refresh()},1E4);else{var a={},b=this.set_busy(!0,"refreshing");"mail"==this.task&&this.gui_objects.mailboxlist&&(a=this.check_recent_params());a._last=Math.floor(this.env.lastrefresh.getTime()/1E3);this.env.lastrefresh=new Date;this.http_post("refresh",a,b)}};this.check_recent_params=function(){var a={_mbox:this.env.mailbox};this.gui_objects.mailboxlist&&
(a._folderlist=1);this.gui_objects.quotadisplay&&(a._quota=1);this.env.search_request&&(a._search=this.env.search_request);this.gui_objects.messagelist&&(a._list=1,a._uids=$.map(this.message_list.rows,function(a,d){return d}).join(","));return a};this.quote_html=function(a){return String(a).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};this.opener=function(a,b){var d,e=window.opener;try{if(e&&!e.closed&&e!==window){a&&(!e.rcmail||e.rcmail.env.framed)&&e.parent&&e.parent.rcmail&&
(e=e.parent);if(e.rcmail&&b)for(d in b)if(e.rcmail.env[d]!=b[d])return;return e.rcmail}}catch(f){}};this.get_single_uid=function(){var a=this.env.uid||(this.message_list?this.message_list.get_single_selection():null);return f.triggerEvent("get_single_uid",{uid:a})||a};this.get_single_cid=function(){var a=this.env.cid||(this.contact_list?this.contact_list.get_single_selection():null);return f.triggerEvent("get_single_cid",{cid:a})||a};this.get_message_mailbox=function(a){var b;return this.env.messages&&
a&&(b=this.env.messages[a])&&b.mbox?b.mbox:/^[0-9]+-(.*)$/.test(a)?RegExp.$1:this.env.mailbox};this.params_from_uid=function(a,b){b||(b={});b._uid=String(a).split("-")[0];b._mbox=this.get_message_mailbox(a);return b};this.get_caret_pos=function(a){return void 0!==a.selectionEnd?a.selectionEnd:a.value.length};this.set_caret_pos=function(a,b){try{a.setSelectionRange&&a.setSelectionRange(b,b)}catch(d){}};this.get_input_selection=function(a){var b=0,d=0,e="";"number"==typeof a.selectionStart&&"number"==
typeof a.selectionEnd&&(e=a.value,b=a.selectionStart,d=a.selectionEnd);return{start:b,end:d,text:e.substr(b,d-b)}};this.lock_form=function(a,b){a&&a.elements&&(b&&(this.disabled_form_elements=[]),$.each(a.elements,function(){if("hidden"!=this.type)if(b&&this.disabled)f.disabled_form_elements.push(this);else if(b||0>$.inArray(this,f.disabled_form_elements))this.disabled=b}))};this.mailto_handler_uri=function(){return location.href.split("?")[0]+"?_task=mail&_action=compose&_to=%s"};this.register_protocol_handler=
function(a){try{window.navigator.registerProtocolHandler("mailto",this.mailto_handler_uri(),a)}catch(b){this.display_message(String(b),"error")}};this.check_protocol_handler=function(a,b){var d=window.navigator;d&&"function"==typeof d.registerProtocolHandler?"function"==typeof d.isProtocolHandlerRegistered?(d=d.isProtocolHandlerRegistered("mailto",this.mailto_handler_uri()))&&$(b).parent().find(".mailtoprotohandler-status").html(d):$(b).click(function(){f.register_protocol_handler(a);return!1}):$(b).addClass("disabled").click(function(){f.display_message("nosupporterror",
"error");return!1})};this.browser_capabilities_check=function(){this.env.browser_capabilities||(this.env.browser_capabilities={});$.each(["pdf","flash","tiff","webp"],function(){void 0===f.env.browser_capabilities[this]&&(f.env.browser_capabilities[this]=f[this+"_support_check"]())})};this.browser_capabilities=function(){if(!this.env.browser_capabilities)return"";var a,b=[];for(a in this.env.browser_capabilities)b.push(a+"="+this.env.browser_capabilities[a]);return b.join()};this.tiff_support_check=
function(){this.image_support_check("tiff");return 0};this.webp_support_check=function(){this.image_support_check("webp");return 0};this.image_support_check=function(a){window.setTimeout(function(){var b=new Image;b.onload=function(){f.env.browser_capabilities[a]=1};b.onerror=function(){f.env.browser_capabilities[a]=0};b.src=f.assets_path("program/resources/blank."+a)},10)};this.pdf_support_check=function(){var a,b=navigator.mimeTypes?navigator.mimeTypes["application/pdf"]:{},d=navigator.plugins,
e=d.length,g=/Adobe Reader|PDF|Acrobat/i;if(b&&b.enabledPlugin)return 1;if("ActiveXObject"in window){try{if(b=new ActiveXObject("AcroPDF.PDF"))return 1}catch(k){}try{if(b=new ActiveXObject("PDF.PdfCtrl"))return 1}catch(h){}}for(a=0;a<e;a++)if(b=d[a],"String"===typeof b){if(g.test(b))return 1}else if(b.name&&g.test(b.name))return 1;window.setTimeout(function(){$("<object>").attr({data:f.assets_path("program/resources/dummy.pdf"),type:"application/pdf",style:'position: "absolute"; top: -1000px; height: 1px; width: 1px'}).on("load error",
function(a){f.env.browser_capabilities.pdf="load"==a.type?1:0;$(this).remove()}).appendTo(document.body)},10);return 0};this.flash_support_check=function(){var a=navigator.mimeTypes?navigator.mimeTypes["application/x-shockwave-flash"]:{};if(a&&a.enabledPlugin)return 1;if("ActiveXObject"in window)try{if(new ActiveXObject("ShockwaveFlash.ShockwaveFlash"))return 1}catch(b){}return 0};this.assets_path=function(a){this.env.assets_path&&!a.startsWith(this.env.assets_path)&&(a=this.env.assets_path+a);return a};
this.set_cookie=function(a,b,d){setCookie(a,b,d,this.env.cookie_path,this.env.cookie_domain,this.env.cookie_secure)};this.get_local_storage_prefix=function(){this.local_storage_prefix||(this.local_storage_prefix="roundcube."+(this.env.user_id||"anonymous")+".");return this.local_storage_prefix};this.local_storage_get_item=function(a,b,d){var e,f;try{e=localStorage.getItem(this.get_local_storage_prefix()+a),f=JSON.parse(e)}catch(k){}return f||b||null};this.local_storage_set_item=function(a,b,d){try{return localStorage.setItem(this.get_local_storage_prefix()+
a,JSON.stringify(b)),!0}catch(e){return!1}};this.local_storage_remove_item=function(a){try{return localStorage.removeItem(this.get_local_storage_prefix()+a),!0}catch(b){return!1}};this.print_dialog=function(){bw.safari?setTimeout("window.print()",10):window.print()}}rcube_webmail.long_subject_title=function(f,a,b){f.title||(b=$(b||f),b.width()+15*(a||0)>b.parent().width()&&(f.title=rcube_webmail.subject_text(b[0])))};
rcube_webmail.long_subject_title_ex=function(f){if(!f.title){var a=$(f),b=$.trim(a.text()),d=$("span.branch",a).width()||0,b=$("<span>").text(b).css({position:"absolute","float":"left",visibility:"hidden","font-size":a.css("font-size"),"font-weight":a.css("font-weight")}).appendTo(document.body),e=b.width();b.remove();e+15*d>a.width()&&(f.title=rcube_webmail.subject_text(f))}};rcube_webmail.subject_text=function(f){f=$(f).clone();f.find(".skip-on-drag,.skip-content,.voice").remove();return $.trim(f.text())};
rcube_webmail.set_iframe_events=function(f){$("iframe").each(function(){var a=$(this);$.each(f,function(b,d){a.on("load",function(a){try{$(this).contents().on(b,d)}catch(e){}});try{a.contents().on(b,d)}catch(e){}})})};rcube_webmail.prototype.get_cookie=getCookie;rcube_webmail.prototype.addEventListener=rcube_event_engine.prototype.addEventListener;rcube_webmail.prototype.removeEventListener=rcube_event_engine.prototype.removeEventListener;rcube_webmail.prototype.triggerEvent=rcube_event_engine.prototype.triggerEvent;
