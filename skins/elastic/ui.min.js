/**
 * Roundcube webmail functions for the Elastic skin
 *
 * Copyright (c) The Roundcube Dev Team
 *
 * The contents are subject to the Creative Commons Attribution-ShareAlike
 * License. It is allowed to copy, distribute, transmit and to adapt the work
 * by keeping credits to the original autors in the README file.
 * See http://creativecommons.org/licenses/by-sa/3.0/ for details.
 *
 * @license magnet:?xt=urn:btih:90dc5c0be029de84e523b9b3922520e79e0e6f08&dn=cc0.txt CC0-1.0
 */
/*
 magnet:?xt=urn:btih:90dc5c0be029de84e523b9b3922520e79e0e6f08&dn=cc0.txt CC0-1.0
*/
function rcube_elastic_ui(){var e,t,a=this,i="normal",n=!1,o=!1,s=rcmail.is_framed(),r={config:{standard_windows:rcmail.env.standard_windows,message_extwin:rcmail.env.message_extwin,compose_extwin:rcmail.env.compose_extwin,help_open_extwin:rcmail.env.help_open_extwin},checkboxes:0,small_screen_config:{standard_windows:!0,message_extwin:!1,compose_extwin:!1,help_open_extwin:!1}},l={},c=[],d=[],u={menu:$("#layout-menu"),sidebar:$("#layout-sidebar"),list:$("#layout-list"),content:$("#layout-content")},p={menu:$("a.task-menu-button"),back_sidebar:$("a.back-sidebar-button"),back_list:$("a.back-list-button"),back_content:$("a.back-content-button")};function m(e,t,a,i){var n,o=!0,r=$("<a>"),l=e.attr("id")||(new Date).getTime(),c=l+"-clone",u=e[0].className+(a?" "+a:"");return t?(n=e.data("popup"))&&(r.data({popup:n,"toggle-button":e.data("toggle-button")}),S(r[0]),o=!1,rcmail.register_menu_button(r[0],n)):(u=$.trim(u.replace("btn-primary","primary").replace(/(btn[a-z-]*|button|disabled)/g,"")),u+=" button"+(i?"":" disabled")),r.attr({id:c,href:"#",class:u}).append($('<span class="inner">').text(e.text())),o&&r.on("click",function(t){e.click()}),s&&!t?(r.data("target",e),d.push($.extend({button_id:c},h(e[0].id)))):function(e,t,a){var i=h(e);i&&rcmail.register_button(i.command,t,i.data.type,a,i.data.sel)}(l,c,u.replace(" disabled","")),r}function h(e){var t,a,i;for(i in rcmail.buttons)for(t=0;t<rcmail.buttons[i].length;t++)if((a=rcmail.buttons[i][t]).id==e)return{command:i,index:t,data:a}}function f(){$("[data-list]").filter("ul,table").each(function(){var e=$(this),t=e.data("list");if(rcmail[t]&&rcmail[t].multiselect){var a,i,o=e.parents("layout-sidebar,#layout-list,#layout-content").last(),s=o.find(".header"),r=s.find("ul");if(r.length?(i=r.find("a.select").data("toggle-button"))&&(i=$("#"+i)):r=s,rcmail[t].enable_checkbox_selection(),!i)if(i=$("<a>").attr({class:"button selection disabled",role:"button",title:rcmail.gettext("select")}).on("click",function(){$(this).is(".active")&&e.toggleClass("withselection")}).append($('<span class="inner">').text(rcmail.gettext("select"))),r.is(".menu")){if(i.prependTo(r).wrap('<li role="menuitem">'),u.content){var l=m(i,!0,"hidden-big hidden-large");$('<li role="menuitem">').append(l).appendTo("#toolbar-menu"),i=i.add(l)}}else(a=e.data("list-select-replace"))?$(a).replaceWith(i):(i.appendTo(r).addClass("icon"),o.is("#layout-sidebar")||i.addClass("toolbar-button"));rcmail.addEventListener("listupdate",function(e){e.list&&e.list==rcmail[t]&&(e.rowcount?i.addClass("active").removeClass("disabled").attr("tabindex",0):i.removeClass("active").addClass("disabled").attr("tabindex",-1))})}n&&rcmail[t]&&("function"==typeof rcmail[t].draggable?rcmail[t].draggable("destroy"):"boolean"==typeof rcmail[t].draggable&&(rcmail[t].draggable=!1))}),window.MutationObserver&&$("[data-label-msg]").filter("ul,table").each(function(){var e,t=$('<div class="listing-info hidden">').insertAfter(this),a=$(this),i=function(){var e,i,n=a.data("label-msg"),o=a.is("ul")?a:a.children("tbody");if(!rcmail.env.search_request&&!rcmail.env.qsearch&&n&&!o.children(":visible").length)return e=a.data("label-ext"),i=a.data("create-command"),!e||i&&!rcmail.commands[i]||(n+=" "+e),void t.text(n).removeClass("hidden");t.addClass("hidden")};e=function(){if(rcmail.busy||!a.is(":visible"))return setTimeout(e,250);clearTimeout(r.list_timer),r.list_timer=setTimeout(i,50)},new MutationObserver(e).observe(a[0],{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style"]}),e()}),"print"!=rcmail.env.action&&$("#attachment-list > li").each(function(){W(this)});var e=function(e){"phone"==i&&rcmail.display_message(rcmail.gettext(e),"confirmation")};if(rcmail.addEventListener("fileappended",function(t){t.attachment.complete&&(W(t.item),"text/vcard"==t.attachment.mimetype&&rcmail.commands["attach-vcard"]&&e("vcard_attachments.vcardattached"))}).addEventListener("managesieve.insertrow",function(e){v(e.obj)}).addEventListener("add-recipient",function(){e("recipientsadded")}),rcmail.init_pagejumper(".pagenav > input"),"mail"==rcmail.task){if("compose"==rcmail.env.action&&(rcmail.addEventListener("compose-encrypted",function(e){$("a.mode-html, button.attach").prop("disabled",e.active),$("a.attach, a.responses:not(.edit)")[e.active?"addClass":"removeClass"]("disabled")}),$("#layout-sidebar > .footer:not(.pagenav) > a.button").click(function(){$(this).is(".disabled")&&rcmail.display_message(rcmail.gettext("nocontactselected"),"warning")}),window.MutationObserver)){var t=$("#attachment-list"),a=function(){R("attach",t.children().length>0)};new MutationObserver(a).observe(t[0],{childList:!0}),a()}rcmail.env.extwin||"compose"!=rcmail.env.action&&"show"!=rcmail.env.action||$("a.mail",u.menu).attr({"aria-disabled":!1,onclick:"return rcmail.command('list','',this,event);"}),"preview"!=rcmail.env.action&&"show"!=rcmail.env.action||$("a").filter('[href^="mailto:"]').each(function(){var e,t;t=(e=this).onclick,e.onclick=null,$(e).on("click",function(a,i){return i||q($("#mailto-menu"),e,a,t)})})}else"settings"==rcmail.task&&(rcmail.addEventListener("identity-encryption-show",function(e){v(e.container)}),rcmail.addEventListener("identity-encryption-update",function(e){v(e.container)}));rcmail.set_env({thread_padding:"1.5rem",popup_width_small:1025,popup_width:1200}),rcmail.env.devel_mode&&window.less?less.pageLoadFinished.then(function(){k(),rcmail.env.compose_focus_elem&&$(rcmail.env.compose_focus_elem).focus()}):k();var o,s=rcmail.env.date_format_localized;s&&(o=function(e){$(e).filter(".datepicker").attr("placeholder",s),$(e).parent().find("select").each(function(){K(this)})},$("input.datepicker").each(function(){o(this)}),rcmail.addEventListener("insert-edit-field",o))}function v(e){if(e||(e=document),$("input.button,button",e).not(".btn").addClass("btn").not(".btn-primary,.primary,.mainaction").addClass("btn-secondary"),$("input.button.mainaction,button.primary,button.mainaction",e).addClass("btn-primary"),$("button.btn.delete,button.btn.discard",e).addClass("btn-danger"),$.each(["warning","error","information","confirmation"],function(){var t=this;$(".box"+t+":not(.ui.alert)",e).each(function(){M(this,t,!0)})}),e!=document&&1==$(".popup",e).children().length){var t=$(".popup",e).children().first();if(t.is("img"))$(".popup",e).addClass("justified");else if(t.is("label")){var a=t.find("input").detach(),i=t.detach(),n=a.attr("id");n||a.attr("id",n="dialog-input-elastic"),$(".popup",e).addClass("formcontent").append($('<div class="form-group row">').append(i.attr("for",n).addClass("col-sm-2 col-form-label")).append($('<div class="col-sm-10">').append(a))),a.focus()}}var o="input:not(.button,.no-bs,[type=button],[type=radio],[type=checkbox]),textarea";$(o,$(".propform",e)).addClass("form-control"),$("[type=checkbox]",$(".propform",e)).addClass("form-check-input"),$("select",e).addClass("form-control custom-select"),e!=document&&$(o,e).addClass("form-control"),$("table.propform",e).each(function(){var e=0,t=0,a=["sm",4,8];$(this).attr("class").match(/cols-([a-z]+)-(\d)-(\d)/)&&(a=[RegExp.$1,RegExp.$2,RegExp.$3]),$(this).find("> tbody > tr, > tr").each(function(){var i,n,o=$(this),s=["form-group","row"],r=o.children("td");2==r.length?(i=r.first(),n=r.last(),$("label",i).addClass("col-form-label"),i.addClass("col-"+a[0]+"-"+a[1]),n.addClass("col-"+a[0]+"-"+a[2]),1!=n.find("[type=checkbox]").length||n.find(".proplist").length?n.find("input:not([type=hidden]),textarea,radio,select").length?t++:(n.addClass("form-control-plaintext"),e++):(s.push("form-check"),n.find("a").length&&s.push("with-link"),t++),n.children(".datepicker")&&2==n.children("input").length&&n.addClass("datetime")):1==r.length&&r.css("width","100%"),o.addClass(s.join(" "))}),e>t&&$(this).addClass("text-only")}),$("td.input-group",e).each(function(){$(this).children().slice(1).addClass("input-group-append")}),$("fieldset.propform:not(.groupped) div.row",e).each(function(){var e=$("input:not([type=hidden]),select,textarea",this).length>0;e&&$(o,this).addClass("form-control"),$(this).children().last().addClass("col-sm-8"+(e?"":" form-control-plaintext")),$(this).children().first().addClass("col-sm-4 col-form-label"),$(this).addClass("form-group")}),$("fieldset.propform.groupped fieldset",e).each(function(){$(".row",this).each(function(){var e,t=$("input,select,textarea",this).length>0,a=$(this).children();t&&$(o,this).addClass("form-control"),a.length<2||((e=a.first()).is("select")?e.addClass("input-group-prepend"):e.wrap('<span class="input-group-prepend">').addClass("input-group-text"),t||a.last().addClass("form-control-plaintext"),$(".content",this).addClass("input-group-prepend input-group-append input-group-text"),$("a.deletebutton",this).addClass("input-group-text icon delete").wrap('<span class="input-group-append">'),$(this).addClass("input-group"))})}),$("fieldset.advanced",e).each(function(){var e=$(this).children(".propform").first();e.wrap($("<div>").addClass("collapse")),$(this).children("legend").first().addClass("closed").on("click",function(){e.parent().collapse("toggle"),$(this).toggleClass("closed")})}),$(".propform > .prop.block:not(.row)",e).each(function(){$(this).addClass("form-group row").each(function(){$("label",this).addClass("col-form-label").wrap($('<div class="col-sm-4">')),$("input,select,textarea",this).wrap($('<div class="col-sm-8">')),$(o,this).addClass("form-control")})}),$("td.rowbuttons > a",e).addClass("btn"),$("form.tabbed,div.tabbed",e).each(function(e,t){var a=[],i=$("<ul>").attr({class:"nav nav-tabs",role:"tablist"});$(this).addClass("tab-content").children("fieldset").each(function(t,i){var n,o=i.id||"tab"+e+"-"+t,s=$(i).data("navlink-class");$(i).addClass("tab-pane").attr({id:o,role:"tabpanel"}),n=$("<li>").addClass("nav-item").append($("<a>").addClass("nav-link"+(s?" "+s:"")).attr({role:"tab",href:"#"+o}).text($("legend",i).first().text()).click(function(e){return $(this).tab("show"),D(e),!1})),$("legend",i).first().hide(),a.push(n)}),i.append(a).insertBefore(t),$("a.nav-link",i).first().click()}),$("input[type=file]:not(.custom-file-input)",e).each(function(){var e=rcmail.gettext("choosefile"+(this.multiple?"s":"")),t=$("<label>").attr({class:"custom-file-label","data-browse":rcmail.gettext("browse")}).text(e);$(this).addClass("custom-file-input").wrap('<div class="custom-file">'),$(this).on("change",function(){var t=e;this.files.length&&(t=this.files[0].name,this.files.length>1&&(t+=", ...")),$(this).next().text(t)}).parent().append(t)}),$("table:not(.table,.compact-table,.propform,.listing,.ui-datepicker-calendar)",e).filter(function(){return!$(this).parent().is(".propform")&&!$(this).parents(".message-htmlpart,.message-partheaders,.boxinformation,.raw-tables").length}).each(function(){var e=$(this).addClass("table");e.parent().addClass("table-responsive-sm"),e.find("thead").addClass("thead-default")}),$("input.pretty-checkbox, .propform input[type=checkbox], .form-check input, .popupmenu.form input[type=checkbox], .menu input[type=checkbox]",e).each(function(){F(this)}),$(e).is(".actionrow")&&$("input[type=checkbox]",e).each(function(){F(this)}),$(".input-group-combo > select",e).first().on("change",function(){var e=$(this),t=function(){e[e.next().is(":visible")?"removeClass":"addClass"]("alone")};setTimeout(t,50),setTimeout(t,2e3)}).trigger("change"),$("#message-objects",e).children(":not(.ui.alert)").add(".part-notice").each(function(){var e=String($(this).removeClass("notice part-notice").attr("class")).split(/\s/)[0]||"warning";M(this,e),$(this).addClass("box"+e),$("a",this).addClass("btn btn-primary btn-sm")}),$(".error",e).addClass("is-invalid"),"login"==rcmail.env.task&&e==document&&($("#rcmloginsubmit").addClass("btn-lg text-uppercase w-100"),$("#login-form table tr").each(function(){var e=$("input,select",this),t=$("label",this),a=e.data("icon"),i=$("<i>").attr("class","input-group-text icon "+e.attr("name").replace("_",""));a&&i.addClass(a),$(this).addClass("form-group row"),t.parent().css("display","none"),e.addClass(e.is("select")?"custom-select":"form-control").attr("placeholder",t.text()).before($('<span class="input-group-prepend">').append(i)).parent().addClass("input-group input-group-lg")})),$("select:not([multiple])",e).each(function(){K(this)})}function g(e){var t=[],a=$("#"+e.id).parent().is(".html-editor");if(e.config.plugins+=" autoresize",Q().touch&&(e.config.toolbar_items_size=null,e.config.toolbar="undo redo | insert | styleselect",e.config.plugins.match(/emoticons/)&&(e.config.toolbar+=" emoticons")),"mail"==rcmail.task&&"compose"==rcmail.env.action){var i=$("#compose-content > form"),n=function(e){"Tab"==e.key&&e.shiftKey&&$("#compose-content > form").scrollTop(0)};t.push(function(e){e.on("keypress",n)}),$("#composebody").on("keypress",n),i.on("scroll",function(){var e=$(".mce-container-body",i),t=$(".mce-top-part",e),a=e.offset(),n=i.offset().top;a&&a.top-n<0?t.css({position:"fixed",top:n+"px",width:e.width()+"px"}):t.css({position:"relative",top:0,width:"auto"})}),$(window).resize(function(){i.trigger("scroll")})}a&&(e.config.toolbar="plaintext | "+e.config.toolbar,e.config.setup_callback=function(e){e.addButton("plaintext",{tooltip:rcmail.gettext("plaintoggle"),icon:"plaintext",onclick:function(t){rcmail.command("toggle-editor",{id:e.id,html:!1},"",t.originalEvent)&&$("#"+e.id).parent().removeClass("ishtml")}})}),rcmail.addEventListener("editor-load",function(e){$.each(t,function(){this(e.ref.editor)})})}function b(e){if($("ul",e.obj).addClass("menu listing iconized"),$(e.obj).addClass("popupmenu popover"),v(e.obj),$("input",e.obj).addClass("form-control"),X()&&$(e.obj).is(".googie_window")){var t=rcmail.gettext("close"),a=$("<a>").attr("class","button icon cancel").text(t).click(function(t){t.stopPropagation(),$(".popover-overlay").remove(),$(e.obj).hide()});$('<h3 class="popover-header">').append(a).prependTo(e.obj),$(".popover-overlay").length||$("<div>").attr("class","popover-overlay").appendTo("body").click(function(){$(this).remove()}),$("ul,button",e.obj).click(function(e){$(e.target).is("input")||$(".popover-overlay").remove()})}}function _(e){if(s&&$.each(d,function(t,a){e.command==a.command&&parent.$("#"+a.button_id)[e.status?"removeClass":"addClass"]("disabled")}),"mail"==rcmail.task)switch(e.command){case"reply-list":if(1==rcmail.env.reply_all_mode){var t=rcmail.gettext(e.status?"replylist":"replyall");$(".toolbar a.reply-all").attr("title",t).find(".inner").text(t)}break;case"compose-encrypted":$(".toolbar a.encrypt").parent().show();break;case"compose-encrypted-signed":$("#encryption-menu-button").show()}}function w(){var e=$(window).width();n=e<=1024,i=e<=480?"phone":e>1200?"large":e>768?"normal":"small"}function k(){var e;w(),x(),function(){var e=Q(),t=$(document.documentElement);t[0].className.match(/layout-([a-z]+)/)?RegExp.$1!=e.mode&&t.removeClass("layout-"+RegExp.$1).addClass("layout-"+e.mode):t.addClass("layout-"+e.mode);e.touch&&!t.is(".touch")?t.addClass("touch"):!e.touch&&t.is(".touch")&&t.removeClass("touch")}(),(e=X())?(rcmail.set_env(r.small_screen_config),rcmail.enable_command("extwin",!1)):(rcmail.set_env(r.config),rcmail.enable_command("extwin",!0)),$.each(c,function(){$(this)[e?"hide":"show"]()})}function x(){if(!s||u.sidebar.length||u.list.length){switch(i){case"phone":C(),j(!1);break;case"small":C(),j(!0);break;case"normal":!function(){var e;u.list.length&&(e=u.list.is(r.last_selected)||!u.sidebar.is(r.last_selected)&&!u.sidebar.is(".layout-sticky"),u.list[e?"removeClass":"addClass"]("hidden"));u.sidebar.length&&(e=!u.list.length||u.sidebar.is(r.last_selected)||u.sidebar.is(".layout-sticky"),u.sidebar[e?"removeClass":"addClass"]("hidden"));u.content.removeClass("hidden"),j(!0),E(),u.list.length&&$(".header > ul.menu",u.list).addClass("popupmenu")}();break;case"large":$.each(u,function(e,t){t.removeClass("hidden")}),E(),u.list&&$(".header > ul.menu.popupmenu",u.list).removeClass("popupmenu")}!function(e){"phone"==e&&$("#logo").data("src-small")?$("#logo").attr("src",$("#logo").data("src-small")):$("#logo").attr("src",$("#logo").data("src-default"))}(i),y(),bw.webkit&&bw.ipad&&bw.agent.match(/OS 9/)&&$(".iframe-wrapper").each(function(){var e=$(this).height();e&&$(this).children("iframe").height(e)})}else y()}function y(){$("#layout > div > .header").each(function(){var e,t=0,a=0,i={left:0,right:0};$(this).children(":visible:not(.position-absolute)").each(function(){e||!$(this).is(".header-title")?i[e?"right":"left"]+=this.offsetWidth:e=$(this)}),0+i.right>=i.left?(t=0,a=i.right+0-i.left):(a=0,t=i.left-(0+i.right)),$(e).css({"margin-right":t+"px","margin-left":a+"px","padding-right":"0px"})})}function C(){var e,t=!1;u.content.length&&(e=t=u.content.is(r.last_selected),u.content[e?"removeClass":"addClass"]("hidden"),$(".header > ul.menu",u.content).addClass("popupmenu")),u.list.length&&(e=!t&&u.list.is(r.last_selected),u.list[e?"removeClass":"addClass"]("hidden"),$(".header > ul.menu",u.list).addClass("popupmenu")),u.sidebar.length&&(e=!t&&(u.sidebar.is(r.last_selected)||!u.list.length),u.sidebar[e?"removeClass":"addClass"]("hidden")),t&&p.back_list.show()}function E(){p.back_list.filter(function(){return 0==$(this).parents("#layout-sidebar").length}).hide(),$("ul.menu.popupmenu").removeClass("popupmenu")}function T(e){u.list.addClass("hidden"),u.sidebar.removeClass("hidden"),e&&u.sidebar.addClass("layout-sticky"),"small"!=i&&"phone"!=i||u.content.addClass("hidden"),y(),r.last_selected=u.sidebar[0]}function L(e){u.list.length||u.sidebar.length?(u.sidebar.addClass("hidden").removeClass("layout-sticky"),u.list.removeClass("hidden"),"small"!=i&&"phone"!=i||(r.last_selected=u.list[0]||u.sidebar[0],x(),rcmail.show_contentframe(!1),$("[data-list]",u.list).each(function(){var e=$(this).data("list");rcmail[e]&&(rcmail[e].clear_selection?rcmail[e].clear_selection():rcmail[e].select&&rcmail[e].select())})),e&&u.list.children(".scroller").scrollTop(0),r.last_selected=u.list[0]):history.back(),y()}function j(e){e?("phone"==i&&($('<div id="menu-overlay" class="popover-overlay">').on("click",function(){j(!1)}).appendTo("body"),r.menu_initialized||(r.menu_initialized=!0,$("a",u.menu).on("click",function(e){"phone"==i&&j()})),u.menu.addClass("popover")),u.menu.removeClass("hidden")):($("#menu-overlay").remove(),u.menu.addClass("hidden").removeClass("popover"))}function z(e){"loading"==e.type&&$(".iframe-loader:visible").length?rcmail.hide_message(e.object):(M(e.object,e.type,!0),$(e.object).attr("role","alert"))}function M(e,t,a){var i,n="ui alert",o=!$(e).is(".noicon");a&&o&&!$(e).is(".aligned-buttons")&&$(e).html($("<span>").html($(e).html())),(i={information:"alert-info",notice:"alert-info",confirmation:"alert-success",warning:"alert-warning",error:"alert-danger",loading:"alert-info loading",uploading:"alert-info loading",vcardattachment:"alert-info"}[t=t.split(" ")[0]])&&(n+=" "+i,o&&$("<i>").attr("class","icon").prependTo(e)),$(e).addClass(n)}function O(e){var t=$(),i=$("a.button.options",e),n=$("input:not([type=hidden])",e),o=n.attr("placeholder"),s=($("form",e),function(){$(e).is(".open")&&i.click()}),r=function(){$(e)[!(n.val()||"mail"==rcmail.task&&$("#s_interval").val()||rcmail.gui_objects.search_filter&&"ALL"!=$(rcmail.gui_objects.search_filter).val()||rcmail.gui_objects.foldersfilter&&"---"!=$(rcmail.gui_objects.foldersfilter).val())?"removeClass":"addClass"]("active"),t[rcmail.gui_objects.search_filter&&"UNSEEN"==$(rcmail.gui_objects.search_filter).val()?"addClass":"removeClass"]("selected")};n.is("#mailsearchform")&&(t=$("<a>").attr({class:"button unread",href:"#",role:"button",title:rcmail.gettext("showunread")}).on("click",function(e){$(rcmail.gui_objects.search_filter).val($(e.target).is(".selected")?"ALL":"UNSEEN"),rcmail.command("search")}).insertBefore(i)),i.on("click",function(t){var n=$(this).data("target"),o=$("#"+n),s=$(e).is(".open");o.length&&(s||(a[n]?a[n](o.get(0),this,t):"function"==typeof window[n]&&window[n](o.get(0),this,t)),o.next()[s?"show":"hide"](),o.toggleClass("hidden"),$(".floating-action-buttons").toggleClass("hidden"),$(e).toggleClass("open"),$("button.search",o).off("click.search").on("click.search",function(){i.click(),r()}))}),n.on("input change",r).on("focus blur",function(e){n.attr("placeholder","blur"==e.type?o:"")}),$("a.reset",e).on("click",function(t){n.val("").change().trigger("keyup.treelist",{keyCode:27}),$(e).is(".open")&&i.click(),rcmail.gui_objects.search_filter&&$(rcmail.gui_objects.search_filter).val("ALL"),rcmail.gui_objects.foldersfilter&&($(rcmail.gui_objects.foldersfilter).val("---").change(),rcmail.folder_filter("---")),r()}),rcmail.addEventListener("init",r).addEventListener("responsebeforesearch",r).addEventListener("beforelist",s).addEventListener("afterlist",r).addEventListener("beforesearch",s)}function S(e,t){if(s&&X())return parent.UI.popup_init(e,t||window);t||(t=window);var i,n=$(e).data("popup"),o=$(t.$("#"+n).get(0)),r=o,c=$(e).attr("title");$(e).attr({"aria-haspopup":"true","aria-expanded":"false","aria-owns":n}).popover({content:function(){return t!=window&&(o=r.clone(!0,!0)).attr("id",n+"-clone").appendTo(document.body).find("li > a").attr("onclick","").off("click").on("click",function(a){return $(this).is(".disabled")||($(e).popover("hide"),t.$("#"+$(this).attr("id")).click()),!1}),o.get(0)},trigger:$(e).data("popup-trigger")||"click",placement:$(e).data("popup-pos")||"bottom",animation:!0,boundary:"window",html:!0}).on("show.bs.popover",function(s){var r=o.data("popup-init");n&&l[n]&&(l[n].transitioning=!0),r&&a[r]?a[r](o.get(0),e,s):r&&t[r]&&t[r](o.get(0),e,s),i=$("div.popover:visible").length+1,o.removeClass("hidden").attr("aria-hidden",!1).find('[aria-haspopup="true"]').data("level",i+1).off("click.popup").on("click.popup",function(e){e.stopPropagation()}),X()||o.css("max-height",Math.min(539,$(window).height()-30))}).on("shown.bs.popover",function(t){var a=X(),o=$("#"+$(e).attr("aria-describedby"));if(i=$(e).data("level")||1,a){var s=i>1?"back":"close",r=rcmail.gettext(s),c="button icon "+("back"==s?"back":"cancel");$(".popover-header",o).empty().append($("<a>").attr("class",c).text(r).on("click",function(t){$(e).popover("hide"),i>1&&t.stopPropagation()}).on("mousedown",function(e){e.stopPropagation()}))}$.each(l,function(e,t){$(t.target).data("level")==i&&e!=n&&A(e)}),"key"==$(e).data("event")&&(o.off("keydown.popup").on("keydown.popup","a.active",function(t){var a,i,n="next";switch(t.which){case 27:case 9:return $(e).popover("toggle").focus(),!1;case 38:case 63232:n="previous";case 40:case 63233:for(a=t.target.parentNode;a=a[n+"Sibling"];)if(i=$(a).children(".active")[0]){i.focus();break}return!1}}),o.find("a.active").first().focus()),n&&l[n]&&(l[n].transitioning=!1),a&&!$(".popover-overlay").length&&$("<div>").attr("class","popover-overlay").appendTo("body").click(function(){$(this).remove()}),$(".popover-body",o).addClass("webkit-scroller")}).on("hide.bs.popover",function(){1==i&&$(".popover-overlay").remove(),n&&l[n]&&o.is(":visible")&&(l[n].transitioning=!0)}).on("hidden.bs.popover",function(){/-clone$/.test(o.attr("id"))?o.remove():o.attr("aria-hidden",!0).addClass("hidden").appendTo(o.data("popup-parent")||document.body),$(".popover-body:empty").each(function(){$(this).parent().remove()}),n&&l[n]&&delete l[n]}).on("click",function(){$(this).data("event","mouse")}).on("keydown",function(e){if(e.originalEvent)switch(e.originalEvent.which){case 13:case 32:e.preventDefault(),$(this).data("event","key").popover("toggle");break;case 27:$(this).popover("hide")}}),c&&$(e).attr("title",c),o.attr("aria-hidden","true").data("button",e),o.data("editable")&&o.on("click mousedown",function(e){e.stopPropagation()})}function D(e){t&&t>(new Date).getTime()-250||$(".popover.show").each(function(){var t=$(".popover-body",this).children().first().data("button");t&&e.target!=t&&!$(t).find(e.target).length&&"string"!=typeof t&&$(t).popover("hide"),t||$(this).remove()})}function I(e){if(e&&e.name&&(!e.props||!1!==e.props.skinable)){if(s&&X())return e.win||(e.win=window),parent.UI.menu_toggle(e);if("messagelistmenu"==e.name)!function(e){var t=$("#listoptions-menu"),a=(t.width(),t.clone(!0));$('select[name="sort_col"]',a).val(rcmail.env.sort_col||""),$('select[name="sort_ord"]',a).val(rcmail.env.sort_order||"ASC"),$('select[name="mode"]',a).val(rcmail.env.threading?"threads":"list"),$("select",a).each(function(){this.id=this.id+"-clone"}),$("label",a).each(function(){$(this).attr("for",$(this).attr("for")+"-clone")});a=rcmail.simple_dialog(a,rcmail.gettext("listoptionstitle"),function(e){rcube_event.is_keyboard(e.originalEvent)&&$("#listmenulink").focus();var t=$('select[name="sort_col"]',a).val(),i=$('select[name="sort_ord"]',a).val(),n=$('select[name="mode"]',a).val();return rcmail.set_list_options([],t,i,"threads"==n?1:0),!0},{closeOnEscape:!0,minWidth:400})}();else if("menu-open"==e.event){var t,a,i=$("ul",e.obj).first(),n=e.props&&e.props.link?e.props.link:e.originalEvent.target;$(n).is("span")&&(n=$(n).parents("a,li")[0]),e.name.match(/^drag/)&&(a=rcube_event.get_mouse_pos(e.originalEvent),n=$("<a>").css({position:"absolute",left:a.x,top:a.y,height:"1px",width:"1px",visibility:"hidden"}).appendTo(document.body).get(0)),a=$(n).data("popup-pos")||"right","folder-selector"==e.name?i.addClass("listing folderlist"):"addressbook-selector"==e.name||"contactgroup-selector"==e.name?i.addClass("listing contactlist"):i.hasClass("menu")&&i.addClass("listing"),"pagejump-selector"==e.name&&(i.addClass("simplelist"),e.obj.addClass("simplelist"),a="top"),l[e.name]&&A(e.name,e.originalEvent),(t=function(){if(l[e.name]&&l[e.name].transitioning)return setTimeout(t,50);$(n).data("popup")||($(n).data({event:rcube_event.is_keyboard(e.originalEvent)?"key":"mouse",popup:e.name,"popup-pos":a,"popup-trigger":"manual"}),S(n,e.win)),l[e.name]={target:n},setTimeout(()=>{$(n).popover("show")},1)})()}else A(e.name,e.originalEvent);e.originalEvent.stopPropagation()}}function A(e,t){var a=function(e){var t;l[e]?t=l[e].target:(t=$("#"+e).data("button"))||(e.match(/(?!-)menu$/)&&(e=e.substr(0,e.length-4)),t=$("#"+e+"-menu").data("button"));return t}(e);e.match(/^drag/)?$(a).popover("dispose").remove():($(a).popover("hide"),"forwardmenu"==e&&D(t))}function N(e,t){var a,i,n=rcmail.env.task,o=rcmail.env.search_mods,s=rcmail.env.mailbox,r=$("#s_scope",e).val(),l=$("#s_interval",e).val();"all"==r&&(s="*"),o||(o={}),"mail"==n?(o[s]||(o[s]=rcube_clone_object(o["*"])),i=o[s],a="text",rcmail.env.search_scope=r,rcmail.env.search_interval=l):(i=o,a="*"),t&&(t.checked?i[t.value]=1:delete i[t.value],t.value==a&&$('input[name="s_mods[]"]',e).map(function(){this!=t&&(this.checked=!0,t.checked?(this.disabled=!0,delete i[this.value]):(this.disabled=!1,i[this.value]=1))}),rcmail.set_searchmods(i))}function R(e,t){var a=$("#composestatusbar"),i=a.find("a.button.icon."+e);t?i.length||$("<a>").attr("class","button icon "+e).on("click",function(){T()}).appendTo(a):i.remove()}function P(e,t,a){var i=$(t).parent().attr("id").replace(/^attach/,"");return $.each(["open","download","rename"],function(){var t=this;$("#attachmenu"+t,e).off("click").attr("onclick","").click(function(e){return rcmail.command(t+"-attachment",i,this,e.originalEvent)})}),rcmail.command("menu-open",{menu:"attachmentmenu",id:i},e,a)}function W(e){if(!(e=$(e)).is(".no-menu")&&!e.children(".dropdown").length){var t=rcmail.gettext("options"),a=e.find("a.filename"),i=$("<a>").attr({href:"#",tabindex:a.attr("tabindex")||0,title:t,class:"button icon dropdown skip-content"}).on("click",function(e){return P($("#attachmentmenu"),i,e)}).append($("<span>").attr("class","inner").text(t));a.length?i.insertAfter(a):i.appendTo(e)}}function q(e,t,a,i){var n=$(t).attr("href").replace(/^mailto:/,"");return n.indexOf("@")<0||(e.find("a").off("click").removeClass("active"),rcmail.env.has_writeable_addressbook&&$(".addressbook",e).addClass("active").on("click",function(e){var a=n,i=$(t).filter(".rcmContactAddress").text();return a=a.split("?")[0].split(",")[0].replace(/(^<|>$)/g,""),i&&(i=i.replace("<"+a+">",""),a='"'+$.trim(i)+'" <'+a+">"),rcmail.command("add-contact",a,this,e.originalEvent)}),$(".compose",e).addClass("active").on("click",function(e){return i?(t.onclick=i,$(t).trigger("click",[!0]),t.onclick=null):rcmail.command("compose",n,this,e.originalEvent),!1}),rcmail.command("menu-open",{menu:"mailto-menu",link:t},t,a.originalEvent))}function U(e){var t=$("#quotadisplay"),a=t.find(".bar"),i=e.total?e.percent:0;a.length||(a=$('<span class="bar"><span class="value"></span></span>').appendTo(t)),i>0&&i<10&&(i=10),a.find(".value").css("width",i+"%")[i>=90?"addClass":"removeClass"]("warning"),t.attr({"data-original-title":"",title:t.find(".count").attr("title")}),e.table?t.css("cursor","pointer").data("popup-pos","top").off("click").on("click",function(t){rcmail.simple_dialog(e.table,"quota",null,{cancel_button:"close"})}):t.tooltip("dispose").tooltip({trigger:X()?"click":"hover"})}function H(e){e=$.trim(e.replace(/[,;\s]*[\r\n]+/g,","));var t=[],a=new RegExp('(<(\\S+|("[^"]+"))@\\S+>)'),i=new RegExp('((\\S+|("[^"]+"))@\\S+)'),n=e.match(/(?=\S)[^",;]*(?:"[^\\"]*(?:\\[,;\S][^\\"]*)*"[^",;]*)*/g);return $.each(n||[],function(){if(this.length&&(a.test(this)||i.test(this))){var n=RegExp.$1,o=$.trim(this.replace(n,""));t.push({name:o,email:n.replace(/(^<|>$)/g,""),text:this}),e=e.replace(this,"")}}),e=e.replace(/[,;]+/,",").replace(/^[,;\s]+/,""),{recipients:t,text:e}}function B(e){if((e=$(e)).length){var t=$('<div class="iframe-loader">').append($('<div class="spinner spinner-border" role="status">').append($('<span class="sr-only">').text(rcmail.gettext("loading"))));e.on("load error loaded",function(){setTimeout(function(){t.remove()},500)}).parent().append(t),o&&e.parent().addClass("ios-scroll")}}function F(e){var t,a;(e=$(e)).is(".custom-control-input")||((a=e.attr("id"))||(a="icochk"+ ++r.checkboxes,e.attr("id",a)),e.parent().is("label")?(t=e.parent(),e=e.detach(),t.before(e)):t=$("<label>"),t.attr({for:a,class:"custom-control-label",title:e.attr("title")||""}).on("click",function(e){e.stopPropagation()}),e.addClass("form-check-input custom-control-input").wrap('<div class="custom-control custom-switch">').parent().append(t))}function Y(e){var t,a=$(e.row).find("input[id^=icochk]");a.length&&(t="icochk"+ ++r.checkboxes,a.attr("id",t).next("label").attr("for",t))}function K(e){if(!bw.iphone&&!bw.ipad&&!(e=$(e)).is(".pretty-select")){var a="select"+e.attr("id")+e.attr("name"),i=function(){if(e[0].ownerDocument.defaultView.$(".select-menu .listing").data("ident")==a)return!0},n=function(){var t=i();return e.popover("dispose").focus(),!t};e.addClass("pretty-select custom-select form-control").on("mousedown keydown",function(o){if(!(e=$(o.target)).prop("disabled"))return 9==o.which?(n(),!0):27==o.which||"mousedown"==o.type&&i()?n():(e.focus(),e.prop("disabled",!0),setTimeout(function(){e.prop("disabled",!1)},0),o.stopPropagation(),"mousedown"==o.type||13==o.which||32==o.which||40==o.which||63233==o.which?(function(t){var i,o=-1,s=[],r=[],l=e.closest(".ui-dialog")[0],c=(document.documentElement.clientHeight||$(document.body).height())-75,d=$(document.body).width()-20,u=Math.min(e.outerWidth(),d),p=e.val();X()||(c*=.5),D(t),$("option",e).each(function(){var e=$(this).text(),t=$('<a href="#">').data("value",this.value).addClass(this.disabled?"disabled":"active"+(this.value==p?" selected":""));e.length?(t.text(e),r.push(this.disabled?"":e.charAt(0).toLowerCase())):(t.html("&nbsp;"),r.push("")),s.push($("<li>").append(t))});var m=$('<ul class="listing selectable iconized">').attr("data-ident",a).data("button",e[0]).append(s).on("click","a.active",function(){var t=$(this).data("value"),a=n();return e.val(t).change(),a}).on("keydown","a.active",function(e){var t,a,s,l,c="next";switch(e.which){case 27:case 9:return n();case 13:case 32:return $(this).click(),!1;case 38:case 63232:c="previous";case 40:case 63233:for(t=e.target.parentNode;t=t[c+"Sibling"];)if(l=$(t).children(".active")[0]){l.focus();break}return!1;default:(a=e.originalEvent.key)&&1==a.length&&(a=a.toLowerCase(),i!=a&&(o=-1),((s=r.indexOf(a,o+1))>-1||(s=r.indexOf(a))>-1)&&m.find("a").eq(s).focus(),i=a,o=s)}});e.popover("dispose").popover({container:l||document.body,content:m[0],placement:"bottom",trigger:"manual",boundary:"viewport",html:!0,offset:"0,2",sanitize:!1,template:'<div class="popover select-menu" style="min-width: '+u+"px; max-width: "+d+'px"><div class="popover-header"></div><div class="popover-body" style="max-height: '+c+'px"></div></div>'}).on("shown.bs.popover",function(){e.focus(),m.parent().prev().empty().append($('<a class="button icon cancel">').text(rcmail.gettext("close")).on("click",function(e){return e.stopPropagation(),n()}));var a=m.find("a.selected").first();if(a.focus().length){var s=m.parent();o=m.find("a").index(a[0]),i=r[o],o>5&&s.scrollTop(s.scrollTop()+s.height()/2)}else rcube_event.is_keyboard(t)&&m.find("a.active").first().focus();m.on("mousedown",function(e){e.stopPropagation()})}).popover("show")}(o),t=(new Date).getTime(),!1):void 0)})}}function V(e,t,a,i,n,o){var s=$('<div class="input-group"><input type="text" class="form-control"><span class="input-group-append"><a class="icon reset input-group-text" href="#"></a></span></div>'),r={value:t,name:a+"[]"};return n&&(r.size=n),$("input",s).attr(r).keydown(function(t){var a=$(this);if(13==t.which){var i=a.attr("name").replace(/\[\]$/,""),o=(new Date).getTime(),s=V(e,"",i,o,n,a.parent());$("input",s).focus()}else if((8==t.which||46==t.which)&&""==a.val()){var r=a.parent();if(e.children().length>1)return r.prev().length?r.prev().children("input").focus():r.next().children("input").focus(),r.remove(),!1}}),$("a.reset",s).click(function(){var t=$(this.parentNode.parentNode);e.children().length>1?($("input",t.next().length?t.next():t.prev()).focus(),t.remove()):$("input",t).val("").focus()}),$(s).find("input,a").on("focus",function(){e.addClass("focused")}).on("blur",function(){e.removeClass("focused")}),o?o.after(s):s.appendTo(e),s}function G(t){var a=t.find(".scroller .listing").first().attr("id"),i=rcmail.env.task+"."+(a||rcmail.env.action+"."+t.attr("id")),n=function(t){e||(e=rcmail.local_storage_get_item("prefs.elastic",{}));if(null==e[t]){var a=rcmail.get_cookie(t);null!=a&&(e[t]=a,rcmail.local_storage_set_item("prefs.elastic",e)&&rcmail.set_cookie(t,a,new Date))}return e[t]}(i),o=t.is(".sidebar-right"),s=function(e){t.css({width:Math.max(100,e),flex:"none"})};t[o?"prev":"next"]().length&&($('<div class="column-resizer">').appendTo(t).on("mousedown",function(a){var n,r=$(this),l=t.position().left;r.width(1e4).css(o?"left":"right",-5e3),document.body.style.userSelect="none",$(document).on("mousemove.resizer",function(e){clearTimeout(n),n=setTimeout(function(){o&&(l=t.position().left);var a=rcube_event.get_mouse_pos(e).x,i=o?t.width()+(l-a):a-l;s(i)},5)}).on("mouseup.resizer",function(){$(document).off(".resizer"),$("iframe").off(".resizer"),document.body.style.userSelect="auto",r.width(6).css(o?"left":"right",-3),function(t,a){if(e[t]=a,!rcmail.local_storage_set_item("prefs.elastic",e)){var i=new Date;i.setYear(i.getFullYear()+1),rcmail.set_cookie(t,a,i)}}(i,t.width())})}),n&&s(n))}function J(e){if(!X()||!0===arguments[3])return r.open_window.apply(rcmail,arguments);e=rcmail.add_url(e,"_framed",1),e=rcmail.add_url(e,"_extwin",1);var t,a="",i={cancel_button:"close",width:768,height:768},n=$("<iframe>").attr({id:"windowframe",src:e});return/_action=([a-z_]+)/.test(e)&&(t=rcmail.labels[RegExp.$1])&&(a=t),/_frame=1/.test(e)&&(i.dialogClass="no-titlebar"),rcmail.simple_dialog(n,a,null,i),!0}function Q(){if(s){var e=$(parent.document.documentElement);return{mode:e[0].className.match(/layout-([a-z]+)/)?RegExp.$1:i,touch:e.is(".touch")}}return{mode:i,touch:n}}function X(){var e=Q();return"phone"==e.mode||"small"==e.mode}this.register_content_buttons=function(e){if(r.frame_nav&&e&&e.length){var t=r.frame_nav.children(".buttons");c=[],$.each(e,function(){this.data("target")&&c.push(this.data("target"))}),t.html("").append(e)}},this.menu_hide=A,this.menu_toggle=I,this.menu_destroy=function(e){$("[aria-owns="+e+"]").popover("dispose").data("popup",null)},this.popup_init=S,this.about_dialog=function(e){var t,a,i=!1,n=$("<iframe>").attr({id:"aboutframe",src:rcmail.url("settings/about",{_framed:1})}),o=$("#supportlink");o.length&&(t=o.attr("href"))&&(i=o.text(),a=function(e){t.indexOf("mailto:")<0?window.open(t):location.href=t});rcmail.simple_dialog(n,$(e).text(),a,{button:i,button_class:"help",cancel_button:"close",height:400})},this.headers_dialog=function(){var e={_uid:rcmail.env.uid,_mbox:rcmail.env.mailbox,_framed:1},t=$("<iframe>").attr({id:"headersframe",src:rcmail.url("headers",e)});rcmail.simple_dialog(t,rcmail.gettext("arialabelmessageheaders"),null,{cancel_button:"close",height:400})},this.import_dialog=function(){if(!rcmail.commands["import-messages"])return;var e=$("#uploadform").clone(!0);rcmail.simple_dialog(e,rcmail.gettext("importmessages"),function(t){return rcmail.command("import-messages",$(e.find("form")[0]))},{button:"import",closeOnEscape:!0,minWidth:400})},this.headers_show=function(e){var t=$(e).parent().prev();t[t.is(".hidden")?"removeClass":"addClass"]("hidden")},this.spellmenu=function(e){var t,a,i=[],n=rcmail.spellcheck_lang(),o=$("ul",e);if(!o.length){for(t in o=$('<ul class="selectable listing iconized" role="menu">'),rcmail.env.spell_langs)a=$('<li role="menuitem">'),$('<a href="#'+t+'" tabindex="0"></a>').text(rcmail.env.spell_langs[t]).addClass("active").data("lang",t).on("click keypress",function(e){if("keypress"!=e.type||13==rcube_event.get_keycode(e))return rcmail.spellcheck_lang_set($(this).data("lang")),rcmail.hide_menu("spell-menu",e),!1}).appendTo(a),i.push(a);o.append(i).appendTo(e)}$("li",o).each(function(){var e=$("a",this);e.data("lang")==n?e.addClass("selected").attr("aria-selected","true"):e.hasClass("selected")&&e.removeClass("selected").removeAttr("aria-selected")})},this.searchmenu=function(e){var t,a,i=$('input[name="s_mods[]"]',e),n=$("#s_scope",e),o=rcmail.env.mailbox,s=rcmail.env.search_mods,r=rcmail.env.search_scope||"base";$(e).data("initialized")||($(e).data("initialized",!0),i.length&&(i.on("change",function(){N(e,this)}),rcmail.addEventListener("beforesearch",function(){N(e)})));if(rcmail.env.search_mods)if("mail"==rcmail.env.task?("all"==r&&(o="*"),s=s[o]?s[o]:s["*"],a="text",n.val(r)):a="*",s[a])i.map(function(){this.checked=!0,this.disabled=this.value!=a});else for(t in i.prop("disabled",!1).prop("checked",!1),s)i.filter('[value="'+t+'"]').prop("checked",!0)},this.headersmenu=function(e,t,a){$("li > a",e).each(function(){var e=$(this),t="#compose_"+e.data("target");e[$(t).is(":visible")?"removeClass":"addClass"]("active").off().on("click",function(){$(t).removeClass("hidden").find(".recipient-input input").focus(),e.removeClass("active"),rcmail.set_menu_buttons()})})},this.header_reset=function(e){$("#"+e).val("").change().closest(".form-group").nextAll(":not(.hidden)").first().find("input").focus(),$("a[data-target="+e.replace(/^_/,"")+"]").addClass("active"),rcmail.set_menu_buttons()},this.compose_status=R,this.attachmentmenu=P,this.mailtomenu=q,this.recipient_selector=function(e,t){t||(t={});var a=rcmail.gettext(t.title||"insertcontact"),i=$("#recipient-dialog"),n=i.parent(),o=function(){i.is(":visible")&&rcmail.env.recipient_dialog.dialog("close")};rcmail.env.recipient_selector_initialized||(rcmail.addEventListener("add-recipient",o),rcmail.env.recipient_selector_initialized=!0);e&&(rcmail.env.focused_field="#_"+e);rcmail.contact_list.clear_selection(),rcmail.contact_list.multiselect=!("multiselect"in t)||t.multiselect,rcmail.env.recipient_dialog=rcmail.simple_dialog(i,a,function(){if(t.action)return t.action(),void o();rcmail.command("add-recipient")},{button:rcmail.gettext(t.button||"insert"),button_class:t.button_class||"insert recipient",height:600,classes:{"ui-dialog-content":"p-0"},open:function(){$("#directorylist a").first().focus()},close:function(){i.appendTo(n),$(this).remove(),$(t.focus||rcmail.env.focused_field).focus()}})},this.show_list=L,this.show_sidebar=T,this.smart_field_init=function(e){var t=e.id+"_list",a=$('<div class="multi-input"><div class="content"></div><div class="invalid-feedback"></div></div>'),i=e.value?e.value.split("\n"):[""];if($("#"+t).length)return;$.each(i,function(t,i){V($(".content",a),i,e.name,t,$(e).data("size"))}),a.attr("id",t),(e=$(e)).attr("disabled")?a.hide():e.prop("disabled",!0);e.data("hidden")&&a.hide();e.after(a),e.hasClass("is-invalid")&&(a.addClass("is-invalid"),$(".invalid-feedback",a).text(e.data("error-msg")))},this.smart_field_reset=function(e,t){var a=e.id+"_list",i=t.length?t:[""],n=$("#"+a).children(".content");n.empty(),$.each(i,function(t,a){V(n,a,e.name,t,$(e).data("size"))})},this.form_errors=function(e){$.each(e,function(){var e=$("#"+this[0]).addClass("is-invalid");if("list"==e.data("type"))return e.data("error-msg",this[2]),void $("#"+this[0]+"_list > .invalid-feedback").text(this[2]);e.after($('<span class="invalid-feedback">').text(this[2]))})},this.switch_nav_list=function(e){var t,a,i=$("a",e),n=$(e).next();n.height()?(n.animate({height:"0"},250),i.addClass("expand").removeClass("collapse"),$(e).removeClass("expanded")):(t=$("tr,li",n).filter(function(){return"none"!=this.style.display}),a=$(t[0]).height()||50,n.animate({height:Math.min(5,t.length)*a+1+"px"},250),i.addClass("collapse").removeClass("expand"),$(e).addClass("expanded"))},this.searchbar_init=O,this.pretty_checkbox=F,this.pretty_select=K,this.datepicker_init=function(e){window.MutationObserver&&$(e).not("[data-observed]").each(function(){var e,t=!0,a=s?parent:window;$(this).attr("data-observed","1"),s&&($(this).detach().appendTo(parent.document.body),$('<div id="ui-datepicker-div" class="hidden">').appendTo(document.body)),new MutationObserver(function(i){$.each(i,function(i,n){if("attributes"==n.type){var o="true"==$(n.target).attr("aria-hidden");o!=t&&(o?e&&e.remove():e=$("<div>").attr("class","ui-widget-overlay datepicker").appendTo(a.document.body).click(function(e){$(this).remove(),s&&$.datepicker._hideDatepicker()}),t=o)}else n.addedNodes.length&&(a.UI.bootstrap_style(n.target),s&&(a.$("select.ui-datepicker-month",n.target).on("change",function(){$.datepicker._selectMonthYear($.datepicker._lastInput,this,"M")}),a.$("select.ui-datepicker-year",n.target).on("change",function(){$.datepicker._selectMonthYear($.datepicker._lastInput,this,"Y")})))})}).observe(this,{childList:!0,subtree:!1,attributes:!0,attributeFilter:["aria-hidden"]})})},this.bootstrap_style=v,w(),function(){r.last_selected=$("#layout > div.selected")[0],!r.last_selected&&u.content.length&&$.each(["sidebar","list","content"],function(){if(u[this].length)return r.last_selected=u[this][0],u[this].addClass("selected"),!1});if($(window).on("resize",function(){clearTimeout(r.resize_timeout),r.resize_timeout=setTimeout(function(){k()},25)}),r.open_window=rcmail.open_window,rcmail.open_window=J,rcmail.addEventListener("message",z).addEventListener("menu-open",I).addEventListener("menu-close",I).addEventListener("editor-init",g).addEventListener("autocomplete_create",b).addEventListener("googiespell_create",b).addEventListener("setquota",U).addEventListener("enable-command",_).addEventListener("clonerow",Y).addEventListener("init",f),window.MutationObserver&&window.tinymce){new MutationObserver(function(e){$.each(e,function(){$.each(this.addedNodes,function(){!function(e){if($(e).is(".mce-window")){var t=$(e).find(".mce-window-body"),a=$(e).find(".mce-foot > .mce-container-body");if(t.length&&v(t[0]),t.find("button").filter(function(){return $(this).parent(".mce-btn").length>0}).removeClass("btn btn-secondary"),5===a.children(".mce-widget").length&&a.addClass("mce-search-foot"),$(e).find(".mce-charmap").parent().parent().addClass("mce-charmap-dialog"),$(e).find(".mce-combobox").each(function(){$(this).children(".mce-btn").length||$(this).addClass("mce-combobox-fake")}),$(e).find(".mce-form > .mce-container-body").each(function(){$(this).children(".mce-formitem").length>4&&$(this).addClass("mce-form-split")}),$(e).find(".mce-form").next(":not(.mce-formitem)").addClass("mce-form"),!X()){var n=0,o=t.height();$(e).find(".mce-form").each(function(){n=Math.max(n,$(this).height())}),o<n&&(n+=(t.find(".mce-tabs").height()||0)+25,t.height(n),$(e).height($(e).height()+(n-o)),$(e).css("top",($(window).height()-$(e).height())/2+"px"))}}else if($(e).is(".mce-menu")&&($(e).prepend($('<h3 class="popover-header">').append($('<a class="button icon "cancel">').text(rcmail.gettext("close")).on("click",function(){$(document.body).click()}))),window.MutationObserver)){new MutationObserver(function(){if("phone"!=i)return;$(".mce-menu:visible").length?$("div.mce-overlay").length||$("<div>").attr("class","popover-overlay mce-overlay").appendTo("body").click(function(){$(this).remove()}):$("div.mce-overlay").click()}).observe(e,{attributes:!0})}}(this)})})}).observe(document.body,{childList:!0})}if((u.list.length||u.content.length)&&X()){var e=[];$("[data-fab]").each(function(){var t=$(this),a=t.data("fab-task")||"*",i=t.data("fab-action")||"*";"*"!=a&&a!=rcmail.env.task||"*"!=i&&i!=rcmail.env.action&&("none"!=i||rcmail.env.action)||e.push(m(t,!1,!1,!0))}),e.length&&$('<div class="floating-action-buttons">').append(e).appendTo(u.list.length?u.list:u.content)}u.sidebar.length&&G(u.sidebar);u.list.length&&G(u.list)}(),v(),function(){if(r.got_smart_toolbar)return;r.got_smart_toolbar=!0;var e,t=[],a=[],i=Q(),n=function(e,t,a){var i=$('<li role="menuitem">'),e=a?m($(e),!0,"hidden-big hidden-large"):$(e).detach();e.contents().filter(function(){3!=this.nodeType||$.trim(this.nodeValue).length||$(this).remove()}),e.is(".spacer")?i.addClass("spacer"):i.append(e),t.push(i)};if(u.content.find(".header > .menu").each(function(){var e=$(this);e.children().each(function(){n(this,t)}),e.remove()}),u.list.find(".header > .menu").each(function(){var o=$(this);e=o.next(),o.children().each(function(){"large"!=i.mode&&$(this).data("popup-pos","right"),n(this,t,!0),n(this,a)}),o.remove()}),$('ul[data-menu="toolbar-small"] > li > a').each(function(){var e=$(this).clone();e.attr("id",this.id+"_clone"),t.push($('<li role="menuitem">').addClass("hidden-big").append(e))}),a.length){var o=u.list.children(".header"),s={class:"menu toolbar popupmenu listing iconized",id:"toolbar-list-menu"},l=$('<a class="button icon toolbar-list-button" href="#list-menu">').attr({"data-popup":"toolbar-list-menu"}),c=$("<ul>").attr(s).data("popup-parent",o).append(a);e.length?c.insertBefore(e):o.append(c),o.append(l)}if(t.length){var o=u.content.children(".header"),s={class:"menu toolbar popupmenu listing iconized",id:"toolbar-menu"},l=$('<a class="button icon toolbar-menu-button" href="#menu">').attr({"data-popup":"toolbar-menu"});o.append($("<ul>").attr(s).data("popup-parent",o).append(t)).append(l),u.list.find("a.toolbar-menu-button").click(function(e){e.stopPropagation(),l.click()})}}(),function(){if(!u.list.length)return;var e=r.last_selected,t=function(e){"string"==typeof e&&e.length||(e=$("h1.voice").text()||$("title").text()||""),u.content.find(".header > .header-title").text(e)},a=function(a,i,n,o){X()&&r.frame_nav&&function(e,t){if(e.match(/_action=(create|add)/)||e.match(/_nav=hide/))return void $(r.frame_nav).addClass("hide-nav-buttons");var a,i,n,o=$("[data-list]",u.list).data("list");if(!o||!(n=rcmail[o]))return void($(r.frame_nav).is(".hide-nav-buttons")&&!$(".buttons",r.frame_nav).children().length&&$(r.frame_nav).addClass("hidden"));$(r.frame_nav).removeClass("hide-nav-buttons hidden"),(i=n.get_single_selection())&&(n.rows&&n.rows[i]&&!n.rows[i].expanded?n.expand_row(t,i):n.get_node&&(a=n.get_node(i))&&a.collapsed&&n.expand(i));var s,l,c=$("#"+rcmail.env.contentframe),d=$("a.button.next",r.frame_nav).off("click").addClass("disabled"),p=$("a.button.prev",r.frame_nav).off("click").addClass("disabled");((l=n.get_next())||rcmail.env.current_page<rcmail.env.pagecount)&&d.removeClass("disabled").on("click",function(){r.content_lock=!0,B(c),l?n.select(l):(rcmail.env.list_uid="FIRST",rcmail.command("nextpage"))});((s=n.get_prev())&&("*"!=s||"subscription_list"!=o)||rcmail.env.current_page>1)&&p.removeClass("disabled").on("click",function(){r.content_lock=!0,B(c),s?n.select(s):(rcmail.env.list_uid="LAST",rcmail.command("previouspage"))})}(i,a),n&&!u.content.is(":visible")?r.last_selected=u.content[0]:n||r.last_selected==e||r.content_lock||(r.last_selected=e),x(),t(o&&n?o:null),r.content_lock=!1},n=function(e){"large"!=i&&!r.content_lock&&e.force&&L(),r.content_lock=!1,e.title&&$(".header > .header-title",u.list).text(e.title)},o=function(e){var t={};if("addressbook"!=rcmail.env.task&&"mail"!=rcmail.env.task||(t.force=!0),"mail"==rcmail.env.task&&!rcmail.env.action){var a="string"==$.type(e)?e:rcmail.env.mailbox,i=rcmail.env.mailboxes[a];t.title=i?i.name:""}n(t)};u.content.find("iframe").on("load",function(e){var i="",n=!0;$(this).parent(".iframe-wrapper").scrollTop(0);try{i=e.target.contentWindow.location.href,n=!i.endsWith(rcmail.env.blankpage),$(e.target.contentWindow).on("unload",t)}catch(e){}a(e,i,n)}),rcmail.addEventListener("afterlist",o).addEventListener("afterlistgroup",o).addEventListener("afterlistsearch",o).addEventListener("show-list",function(e){e.force=!0,n(e)}).addEventListener("show-content",function(e){e.obj&&!$(e.obj).is("iframe")&&($(e.scrollElement||e.obj).scrollTop(0),X()&&B(e.obj)),a(e.event||new Event,"_action="+(e.mode||"edit"),!0,e.title)})}(),$("[data-popup]").each(function(){S(this)}),$(document).on("click",D),rcube_webmail.set_iframe_events({mousedown:D,touchstart:D}),function(){var e,t,i=[];$.ui&&$.widget("ui.dialog",$.ui.dialog,{open:function(){return $(this.element).is(".iframe")&&(this.options.width=Math.max(576,this.options.width)),this._super(),e=this,t=$(e.uiDialog),a=t.width(),i=t.height(),n=$(window).width(),o=$(window).height(),n<=480?t.css({width:"100%",height:"100%"}):(i>o&&t.css("height","100%"),a>n&&t.css("width","100%")),$(document).click(),B($("div.popup > iframe",t)),v(e.uiDialog),this;var e,t,a,i,n,o},close:function(){return this._super(),$(".select-menu:visible").remove(),this}}),p.menu.on("click",function(){return j(!0),!1}),p.back_sidebar.on("click",function(){return T(),!1}),p.back_list.on("click",function(){return L(),!1}),p.back_content.on("click",function(){return e=!0,u.list.addClass("hidden"),u.sidebar.addClass("hidden"),u.content.removeClass("hidden"),e&&u.sidebar.removeClass("layout-sticky"),y(),r.last_selected=u.content[0],!1;var e}),$(".searchbar").each(function(){O(this)}),!s||rcmail.env.extwin||parent.$(".ui-dialog:visible").length?s||((e=u.content.find(".boxtitle").first().detach().text())||(e=$("h1.voice").first().text()),e&&u.content.find(".header > .header-title").text(e)):(e=$("h1.voice").first().text())&&parent.$("#layout-content > .header > .header-title:not(.constant)").text(e);s||!u.content.length||u.content.is(".no-navbar")||u.content.children(".frame-content").length||(r.frame_nav=$('<div class="footer menu toolbar content-frame-navigation hide-nav-buttons">').append($('<a class="button prev">').append($('<span class="inner"></span>').text(rcmail.gettext("previous")))).append($('<span class="buttons">')).append($('<a class="button next">').append($('<span class="inner"></span>').text(rcmail.gettext("next")))).appendTo(u.content));$("a[data-content-button]").each(function(){i.push(m($(this)))}),$(".formbuttons").filter(function(){return!$(this).parent(".searchoptions").length}).children().each(function(){var e=$(this);(s||e.parents("#layout-content").length)&&(e.is(".cancel")?e.addClass("hidden"):i.push(m(e)))}),(s?parent.UI:a).register_content_buttons(i),(t=rcmail.gui_objects.messageform)&&(t=$('form[name="'+t+'"]'),$("#_cc, #_bcc, #_replyto, #_followupto",$(".compose-headers")).each(function(){$(this).on("change",function(){$("#compose"+$(this).attr("id"))[this.value?"removeClass":"addClass"]("hidden")})}),$("#compose-options").find("textarea,input,select").each(function(){var e=$("<input>").attr({type:"hidden",name:$(this).attr("name")}).appendTo(t);$(this).attr("tabindex",2).on("change",function(){e.val("checkbox"!=this.type||this.checked?$(this).val():"")}).change()}));$("[data-recipient-input]").each(function(){var e,t,a,i,n,o,s;e=this,i="",n=function(){$(e).val(t.text()+a.val())},o=function(e,t,i){var s=$('<li class="recipient">'),r=$('<span class="name">').html(function(e){var t,a,i="",n=e.length;for('"'!=e.charAt(0)&&e.indexOf('"')>-1&&(e='"'+e.replace("\\","\\\\").replace('"','\\"')+'"'),t=0;t<n;t++)switch(a=e.charAt(t)){case'"':if(t>0&&t<n-1){i+='"';break}i+='<span class="quotes">'+a+"</span>";break;case"\\":i+='<span class="quotes">'+a+"</span>","\\"==e.charAt(t+1)&&(i+=a,t++);break;case"<":i+="&lt;";break;case">":i+="&gt;";break;default:i+=a}return i}(e||t)).on("dblclick",function(e){!function(e,t){var a=$(e.target).parents(".recipient"),i=a.text().replace(/,+$/,""),n=$("<input>").attr({type:"text",size:50}).val(i),o=$("<label>").text(rcmail.gettext("recipient")).append(n);rcmail.simple_dialog(o,"recipientedit",function(){var e,o=n.val();if(o){if(o!=i){if(1!=(e=H(o)).recipients.length)return!1;t(e.recipients[0].name,e.recipients[0].email,a)}return!0}})}(e,o)}),l=$('<span class="email">'),c=$("<a>").attr({class:"button icon remove"}).click(function(){return s.remove(),n(),a.focus(),!1});e&&(t=" <"+t+">"),l.text((e?t:"")+","),s.attr("title",e?e+t:null).append([r,l,c]),i?i.replaceWith(s):s.insertBefore(a.parent()),n()},s=function(e){var t;return e=(e||a.val()).replace(/[,;\s]+$/,""),t=H(e),$.each(t.recipients,function(){o(this.name,this.email)}),a.val(t.text),n(),t.recipients.length>0},a=$("<input>").attr({type:"text",tabindex:$(e).attr("tabindex")}).on("paste change",function(e,a){var i,n,o=this.value;"paste"==e.type?(n=(e.originalEvent.clipboardData||window.clipboardData).getData("text")||"",o=o.substring(0,this.selectionStart)+n+o.substring(this.selectionEnd),e.preventDefault()):a&&(i=t.find("li.recipient").last()).length&&this.value.indexOf(i.text().replace(/[ ,]+$/,""))>-1&&i.remove(),s(o)}).on("keydown",function(e){return 8!=e.keyCode||a.val().length?!((","==e.key||";"==e.key||"Enter"==e.key&&!rcmail.ksearch_visible())&&s())&&void 0:(t.children("li.recipient").last().remove(),n(),!1)}).on("blur",function(){t.removeClass("focus")}).on("focus mousedown",function(){t.addClass("focus")}),t=$("<ul>").addClass("form-control recipient-input ac-input rounded-left").append($('<li class="input">').append(a)).on("mouseup",function(){i=window.getSelection().toString()}).on("click",function(){i.length||a.focus()}),$(e).css({position:"absolute",opacity:0,left:"-5000px",width:"10px"}).attr("tabindex",-1).after(t).on("focus",function(e){a.focus(),e.preventDefault()}).on("change",function(){$("li.recipient",t).remove(),a.val(this.value).change()}).change(),rcmail.init_address_input_events(a)}),$(".image-upload").each(function(){var e,t,a,i;e=this,t=$("<a>").attr({class:"icon button delete",href:"#"}).click(function(e){return rcmail.command("delete-photo","",this,e),!1}),a=$(e).find("img")[0],i=function(){var t=-1!=(a.currentSrc||a.src).indexOf(rcmail.env.photo_placeholder);$(e)[t?"removeClass":"addClass"]("changed")},$(e).append(t).click(function(){rcmail.upload_input("upload-form")}),i(),$(a).on("load",i)}),$("textarea[data-html-editor]").each(function(){var e,t,a,i,n,o,s,r,l,c,d;e=this,s=!1,r=$(e),l=r.parent(),c=$('<a class="mce-i-html" href="#" tabindex="-1"></a>').attr("title",rcmail.gettext("htmltoggle")).on("click",function(e){rcmail.command("toggle-editor",{id:r.attr("id"),html:!0},"",e.originalEvent)&&l.addClass("ishtml")}).on("keydown",function(e){if(9==e.which)return r.focus(),!1}),d=$('<div class="editor-toolbar">').append(c),l.is("td")?(t=$('input[type="checkbox"]',l.parent().next()),s=!0):t=r.next("select.hidden"),a=e,o=function(){if(!a.scrollHeight)return setTimeout(o,250);if(i||(i=parseInt($(a).css("padding-top"))+parseInt($(a).css("padding-bottom"))+2,n=$(a).height()),!(a.scrollHeight-i<=n)){var e,t=0;$(a).parents().each(function(){if(this.scrollTop>0)return e=this,t=this.scrollTop,!1});var s=$(a).outerHeight();$(a).outerHeight(0);var r=Math.max(n,a.scrollHeight);$(a).outerHeight(s),r!==s&&$(a).height(r),t&&(e.scrollTop=t)}},$(a).on("input",o).trigger("input"),1==t.length&&(l.addClass("html-editor"),r.after(d).data("control",t).on("keydown",function(e){e.altKey&&121==e.which&&c.focus()}),s&&(t.parents("tr").first().hide(),l.prev().hide(),l.addClass("col-sm-12")))}),$("#dragmessage-menu,#dragcontact-menu").each(function(){rcmail.gui_object("dragmenu",this.id)}),$("#taskmenu > a").each(function(){if(/button-([a-z]+)/.test(this.className)){var e,t=RegExp.$1,a=h(this.id);a&&(e=a.data)&&(e.sel&&(e.sel=e.sel.replace("button-selected","selected")+" "+t),e.act&&(e.act+=" "+t),rcmail.buttons[a.command][a.index]=e,rcmail.init_button(a.command,e)),$(this).addClass(t),$(".button-inner",this).addClass("inner")}$(this).on("mouseover",function(){rcube_webmail.long_subject_title(this,0,$("span.inner",this))})}),$(".listbutton").each(function(){var e=h(this.id);$(this).addClass("button").removeClass("listbutton"),e.data.sel&&(e.data.sel=e.data.sel.replace("listbutton","button")),e.data.act&&(e.data.act=e.data.act.replace("listbutton","button")),rcmail.buttons[e.command][e.index]=e.data,rcmail.init_button(e.command,e.data)}),$("[data-hidden]").each(function(){for(var e,t=$(this).data("hidden"),a=$(this).parent("li"),i=/(large|big|small|phone|lbs)/g;e=i.exec(t);)$(a.length?a:this).addClass("hidden-"+e[1])}),$("[data-list]").each(function(){$("input[type=checkbox]",this).each(function(){F(this)})}),s&&$(".formcontent").each(function(){$(this).next(".formbuttons").length&&$(this).parent().addClass("formcontainer")});$("#attachment-list + a.zipdownload").appendTo(".header-links"),(o=$("html").is(".ipad,.iphone"))&&$(".iframe-wrapper, .scroller").addClass("ios-scroll");$("html").filter(".ipad,.iphone,.webkit.mobile,.webkit.tablet").addClass("webkit-scroller").length&&$(u.menu).addClass("webkit-scroller");$(".treelist").each(function(){var e=this,t=function(){$(e)[$(".treetoggle",e).length>0?"removeClass":"addClass"]("notree")};window.MutationObserver&&new MutationObserver(t).observe(e,{childList:!0,subtree:!0}),t(),$("li.mailbox > a").on("mouseover",function(){rcube_webmail.long_subject_title_ex(this)})}),$("#logo").data("src-default")||$("#logo").data("src-default",$("#logo").attr("src"))}(),k()}if(window.rcmail)rcmail.show_menu=function(e,t,a){var i="object"==typeof e?e.menu:e,n=$("#"+i);return"string"==typeof e&&(e={menu:i}),rcmail.triggerEvent(!1===t?"menu-close":"menu-open",{name:i,obj:n,props:e,originalEvent:a})},rcmail.hide_menu=function(e,t){return rcmail.triggerEvent("menu-close",{name:e,props:{menu:e},originalEvent:t})};else var rcmail=parent.rcmail,rcube_webmail=parent.rcube_webmail,bw={};var UI=new rcube_elastic_ui;if($&&$.datepicker){var __newInst=$.datepicker._newInst;$.extend($.datepicker,{_newInst:function(e,t){var a=__newInst.call(this,e,t);return a.inline||UI.datepicker_init(a.dpDiv),a}})}